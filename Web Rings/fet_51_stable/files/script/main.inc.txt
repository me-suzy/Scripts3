<?php

class Traders_stats{

    var $dom_sorted;
    var $hour_in;
    var $hour_in_trad_uniq;
    var $hour_in_glob_uniq;
    var $hour_in_proxy;

    var $hour_out;
    var $hour_out_proxy;

    var $hour_click;
    var $hour_click_proxy;
    var $hour_click_nojs;
    var $hour_click_cont;
    var $hour_click_uniq;
    var $hour_click_repeats;

    var $hour_lang;

    var $day_in;
    var $day_in_trad_uniq;
    var $day_in_glob_uniq;
    var $day_in_proxy;

    var $day_out;
    var $day_out_proxy;

    var $day_click;
    var $day_click_proxy;
    var $day_click_nojs;
    var $day_click_cont;
    var $day_click_uniq;
    var $day_click_repeats;

    var $day_lang;

    var $hour_prod;
    var $hour_uniq_prod;
    var $hour_ca;
    var $hour_lf;
    var $hour_act;
    var $hour_eff;

    var $day_prod;
    var $day_uniq_prod;
    var $day_ca;
    var $day_lf;
    var $day_act;
    var $day_eff;
    var $day_ret;
    var $debt;

    var $tot_hour_in;
    var $tot_hour_in_trad_uniq;
    var $tot_hour_in_glob_uniq;
    var $tot_hour_in_proxy;
    var $tot_hour_out;
    var $tot_hour_out_proxy;
    var $tot_hour_click;
    var $tot_hour_click_proxy;
    var $tot_hour_click_nojs;
    var $tot_hour_click_cont;
    var $tot_hour_click_uniq;
    var $tot_hour_click_repeats;
    var $tot_hour_lang;

    var $tot_day_in;
    var $tot_day_in_trad_uniq;
    var $tot_day_in_glob_uniq;
    var $tot_day_in_proxy;
    var $tot_day_out;
    var $tot_day_out_proxy;
    var $tot_day_click;
    var $tot_day_click_proxy;
    var $tot_day_click_nojs;
    var $tot_day_click_cont;
    var $tot_day_click_uniq;
    var $tot_day_click_repeats;
    var $tot_day_lang;

    var $trades_tot_hour_in;
    var $trades_tot_hour_in_proxy;
    var $trades_tot_hour_in_trad_uniq;
    var $trades_tot_hour_in_glob_uniq;
    var $books_tot_hour_in;
    var $books_tot_hour_in_proxy;
    var $books_tot_hour_in_glob_uniq;
    var $trades_tot_hour_out;
    var $trades_tot_hour_out_proxy;
    var $trades_tot_hour_click;
    var $trades_tot_hour_click_proxy;
    var $trades_tot_hour_click_repeats;
    var $trades_tot_hour_click_uniq;
    var $trades_tot_hour_click_cont;
    var $trades_tot_hour_click_nojs;
    var $books_tot_hour_click;
    var $books_tot_hour_click_proxy;
    var $books_tot_hour_click_cont;
    var $books_tot_hour_click_nojs;
    var $books_tot_hour_click_repeats;
    var $books_tot_hour_click_uniq;

    var $trades_tot_day_in;
    var $trades_tot_day_in_proxy;
    var $trades_tot_day_in_trad_uniq;
    var $trades_tot_day_in_glob_uniq;
    var $books_tot_day_in;
    var $books_tot_day_in_proxy;
    var $books_tot_day_in_glob_uniq;
    var $trades_tot_day_out;
    var $trades_tot_day_out_proxy;
    var $trades_tot_day_click;
    var $trades_tot_day_click_proxy;
    var $trades_tot_day_click_repeats;
    var $trades_tot_day_click_uniq;
    var $trades_tot_day_click_cont;
    var $trades_tot_day_click_nojs;
    var $books_tot_day_click;
    var $books_tot_day_click_proxy;
    var $books_tot_day_click_cont;
    var $books_tot_day_click_nojs;
    var $books_tot_day_click_repeats;
    var $books_tot_day_click_uniq;
}

class Traders_data{

    var $url;
    var $set_ratio;
    var $set_ratio_sort;
    var $trade_type;
    var $proxy_an;
    var $proxy_ds;
    var $proxy_tr;
    var $badref_in;
    var $main_pages;
    var $click_rule;
    var $content_skim;
    var $mintrade;
    var $nocookie_pr;
    var $badref_click;
    var $badref_cl_pr;
    var $proxy_cl_pr;
    var $nojs_rule;
    var $site_name;
    var $e_mail;
    var $nick;
    var $icq;
    var $toplist_allowed;
    var $time_added;
    var $num;
    var $listed;
}

class Full_daily_stats{
    var $hour_in;
    var $day_in;
    var $hour_proxy_in;
    var $day_proxy_in;
    var $tot_hour_in;
    var $tot_hour_proxy_in;
    var $tot_in;
    var $tot_proxy_in;
    var $hour_out;
    var $day_out;
    var $hour_proxy_out;
    var $day_proxy_out;
    var $tot_hour_out;
    var $tot_hour_proxy_out;
    var $tot_out;
    var $tot_proxy_out;
    var $hour_clicks;
    var $day_clicks;
    var $hour_proxy_clicks;
    var $day_proxy_clicks;
    var $tot_hour_clicks;
    var $tot_hour_proxy_clicks;
    var $tot_clicks;
    var $tot_proxy_clicks;
}

class New_traders_data{

    var $url;
    var $set_ratio;
    var $trade_type;
    var $proxy_an;
    var $proxy_ds;
    var $proxy_tr;
    var $badref_in;
    var $main_pages;
    var $click_rule;
    var $content_skim;
    var $mintrade;
    var $nocookie_pr;
    var $badref_click;
    var $badref_cl_pr;
    var $proxy_cl_pr;
    var $nojs_rule;
    var $site_name;
    var $e_mail;
    var $nick;
    var $icq;
    var $toplist_allowed;
    var $time_added;
    var $from_ip;
    var $num;
}

class Service_functions{
    // Class to perform all functions

    function shortstats($do_read=true,$do_read_new=true){
        global $trader,$stats,$html,$intf,$admin,$new_trader;
        // Main stats function

        if($do_read) $this->read_traders();
        $this->read_stats();
        $this->make_resets();

        $new_sorting=$_GET['sort'] or $new_sorting=false;
        if($new_sorting && $new_sorting!=$admin->list_sorting){
            $admin->list_sorting=$new_sorting;
            $admin->save_settings();
        }

        $this->sort_trades($admin->list_sorting);

        $this->filter_trades();

        $html->main_page_header('Main Stats');
        $html->main_table_header('Last hour and 24h summary stats');

        $html->stats_table_header();

        if($admin->totals_pos<1 || $admin->totals_pos>1){
            $html->totals();
            echo '<tr><td colspan='.$admin->td_cellnum.' bgcolor="'.$intf->color['MAIN_BGCOLOR'].'"><b>Main Trades</b></td></tr>';
        }

        $admin->cur_row=0;
        if(is_array($stats->dom_sorted)){
            foreach($stats->dom_sorted as $tr_dom){
                if(!$trader->url["$tr_dom"]) continue;
                $html->main_stats_row($tr_dom,$admin->cur_row);
                $admin->cur_row++;
            }
        }

        if($admin->totals_pos>0) $html->totals();

        echo '<tr><td colspan='.$admin->td_cellnum.' bgcolor="'.$intf->color['MAIN_BGCOLOR'].'"><b>Service Variables</b></td></tr>';
        $html->internal_vars_row('exout');
        $html->internal_vars_row('content');
        $html->internal_vars_row('noref');
        $html->internal_vars_row('notrade');
        $html->internal_vars_row('nocookie');
        $html->internal_vars_row('filtered');

        $html->stats_table_footer();
        $html->middle_menu();

        if($do_read_new) $this->read_new_traders();
        if($new_trader->num>0){
            echo "<br><div align=left><font size=1><b>New Trades</b></font></div>";
            $html->new_trades_table_header();

            foreach($new_trader->url as $tr_dom=>$tr_url){
                $html->main_stats_new_row($tr_dom,$admin->cur_row);
                $admin->cur_row++;
            }

            $html->new_trades_table_footer();
            $html->new_menu();
        }

        $html->main_table_footer();
        $html->main_page_footer();

        exit;
    }

    function save_filter(){
        global $admin;
        $new_filter=$_POST['filter'];
        if($new_filter!='' && $new_filter!=$admin->list_filtering){
            $admin->list_filtering=$new_filter;
            $admin->save_settings();
        }
        $this->shortstats();
    }

    function filter_trades(){
        global $trader,$stats,$admin;

        if($admin->list_filtering<1) return true;
        $dlev=floor($stats->tot_day_in*0.0005);
        if($dlev>100) $dlev=100;
        $temp_sorted=$stats->dom_sorted;
        if(is_array($temp_sorted)){
            foreach($temp_sorted as $tdid=>$tdom){
                if($admin->list_filtering<2){
                    if($stats->day_in["$tdom"]<$dlev) unset($stats->dom_sorted[$tdid]);
                } else {
                    if($stats->day_in["$tdom"]>=$dlev) unset($stats->dom_sorted[$tdid]);
                }
            }
        }
        unset($temp_sorted);
    }

    function edit_one(){
        global $html,$intf,$trader,$global;

        $edom=$_GET['domain'];
        if(!$edom || strlen($edom)<3) $this->shortstats();
        $this->read_traders();
        if(!$trader->url["$edom"]) $this->shortstats(false);

        $html->sub_page_header('Editing trade &quot;'.$edom.'&quot;');
        $html->script_sdmnt();
        $html->script_sdrto();
        $html->main_table_header('Editing trade "'.$edom.'"');

        echo "<br>
            <input type=hidden name=eddom value='".$edom."'>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td colspan=2 bgcolor='".$intf->color['STB_HEADER']."'><font size=1><b>Trade &quot;".$edom."&quot; parameters</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=200><font size=1>Trade URL</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=400>";
        $html->input(11,'normal','text','new_url',65,165,$trader->url["$edom"]);
        echo "</td>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Trade Type</font></td>
            <td  bgcolor='".$intf->color['NORM_CELL']."'><select name=new_tradetype>
            <option value=0";
        if($trader->trade_type["$edom"]<1) echo ' selected';
        echo ">Stopped<option value=1";
        if($trader->trade_type["$edom"]==1) echo ' selected';
        echo ">Normal<option value=2";
        if($trader->trade_type["$edom"]==2) echo ' selected';
        echo ">Normal+<option value=3";
        if($trader->trade_type["$edom"]==3) echo ' selected';
        echo ">Ratio<option value=4";
        if($trader->trade_type["$edom"]==4) echo ' selected';
        echo ">Capped<option value=5";
        if($trader->trade_type["$edom"]==5) echo ' selected';
        echo ">Boost<option value=6";
        if($trader->trade_type["$edom"]==6) echo ' selected';
        echo ">Quality<option value=7";
        if($trader->trade_type["$edom"]>=7) echo ' selected';
        echo ">Quality+</select>
            </td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Minimum Hourly Trade</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><script>sdmnt(".$trader->mintrade["$edom"].")</script></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Set Ratio</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><script>sdrto(".$trader->set_ratio["$edom"].")</script></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Main Pages</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        $mpn=0;
        $mpused=array();
        foreach($trader->main_pages["$edom"] as $mpid){
            $mpn++;
            echo $mpn.". <select name='new_mainpage[]'>";
            if($mpn>1) echo "<option value=-1>Do not use";
            reset($global->main_page);
            foreach($global->main_page as $gmpid=>$gmpnm){
                if($gmpid==$mpid) $s=' selected'; else $s='';
                echo "<option value=".$gmpid.$s.">".$gmpnm;
            }
            echo "</select><br>";
        }
        for($i=$mpn+1;$i<=3;$i++){
            echo $i.". <select name='new_mainpage[]'><option value=-1 selected>Do not use";
            foreach($global->main_page as $gmpid=>$gmpnm)
                echo "<option value=".$gmpid.">".$gmpnm;
            echo "</select><br>";
        }
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show in toplist</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_toplist><option value=1";
        if($trader->toplist_allowed["$edom"]>0) echo ' selected';
        echo ">Yes<option value=0";
        if($trader->toplist_allowed["$edom"]<1) echo ' selected';
        echo ">No</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Clicks order</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        $html->input(11,'normal','text','new_click_rule',15,165,$trader->click_rule["$edom"]);
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Content skim</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_skim>";
        for($i=0;$i<=100;$i++){
            if($i==$trader->content_skim["$edom"]) $s=' selected'; else $s='';
            if($i>0) echo "<option value=".$i.$s.">".$i."%"; else echo "<option value=".$i.$s.">Global";
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept proxy traffic</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><input type=checkbox name=new_proxy_tr value=1";
        if($trader->proxy_tr["$edom"]>0) echo ' checked';
        echo "> Transparent<br><input type=checkbox name=new_proxy_ds value=1";
        if($trader->proxy_ds["$edom"]>0) echo ' checked';
        echo "> Distorting<br><input type=checkbox name=new_proxy_an value=1";
        if($trader->proxy_an["$edom"]>0) echo ' checked';
        echo "> Anonimous</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept noref hits</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_noref_hits><option value=1";
        if($trader->badref_in["$edom"]>0) echo ' selected';
        echo ">Yes<option value=0";
        if($trader->badref_in["$edom"]<1) echo ' selected';
        echo ">No</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept noref clicks</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_noref_clicks><option value=1";
        if($trader->badref_click["$edom"]>0) echo ' selected';
        echo ">Yes<option value=0";
        if($trader->badref_click["$edom"]<1) echo ' selected';
        echo ">No</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>No JSCookie clicks counts as</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_nojs_clicks><option value=1";
        if($trader->badref_click["$edom"]>0) echo ' selected';
        echo ">Normal Click<option value=0";
        if($trader->badref_click["$edom"]<1) echo ' selected';
        echo ">NoCookie Click</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_proxy_cl_pr>";
        for($i=0;$i<=100;$i++){
            if($i==$trader->proxy_cl_pr["$edom"]) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i;
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>NoCookie traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_nocookie_pr>";
        for($i=0;$i<=100;$i++){
            if($i==$trader->nocookie_pr["$edom"]) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i;
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>NoRef traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_badref_cl_pr>";
        for($i=0;$i<=100;$i++){
            if($i==$trader->badref_cl_pr["$edom"]) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i;
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Site Name</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        $html->input(11,'normal','text','new_sitename',40,165,$trader->site_name["$edom"]);
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Webmaster</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        $html->input(11,'normal','text','new_wmnick',40,165,$trader->nick["$edom"]);
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>ICQ UIN</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        $html->input(11,'normal','text','new_icq',40,165,$trader->icq["$edom"]);
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>E-Mail</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        $html->input(11,'normal','text','new_email',40,165,$trader->e_mail["$edom"]);
        echo "</td>
            </tr>
            <tr>
            <td colspan=2 bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center>";
        $html->button('submit','Update Trade','light');
        echo "</td></tr>
            </table>
            <br>
        ";

        $html->main_table_footer();
        $html->sub_page_footer();
        exit;
    }

    function mass_edit(){
        global $html,$intf,$trader,$global;

        $to_edit=$_POST['checked'];
        if(!is_array($to_edit) || count($to_edit)<1) $this->shortstats();

        $html->sub_page_header('Mass edit');
        $html->script_dmnt3();
        $html->script_dmnt4();
        $html->main_table_header('Editing selected trades');

        echo "<br>
            <input type=hidden name=eddom value='".$edom."'>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td colspan=2 bgcolor='".$intf->color['STB_HEADER']."' align=center><font size=1><b>Trades selected to edit</b></font></td></tr>
            <tr>
            <td colspan=2 bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        $ln=ceil(count($to_edit)/3);
        sort($to_edit);
        echo "<table width=90% border=0>";
        $dnum=0;
        for($i=0;$i<$ln;$i++){
            echo "<tr>";
            for($j=0;$j<3;$j++){
                $dname=$to_edit[$dnum];
                if($dname){
                    echo "<td><input type=checkbox name='confirmed[]' value='".$dname."' checked><font size=1> &nbsp;".$dname."</font></td>";
                    $dnum++;
                } else echo "<td>&nbsp;</td>";
            }
            echo "</tr>";
        }
        echo "</table></td>
            </tr>
            <tr>
            <td colspan=2 bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt><font size=1>New Parameters</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=250><font size=1>Trade Type</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=350><select name=new_tradetype><option value=-1 selected>Don't change<option value=0>Stopped<option value=1>Normal
            <option value=2>Normal+<option value=3>Ratio<option value=4>Capped<option value=5>Boost<option value=6>Quality<option value=7>Quality+</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Minimum Hourly Trade</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><script>dmnt3()</script></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Set Ratio</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_setratio><option value=-1 selected>Don't change";
        for($i=0;$i<=30;$i++){
            $v=$i/10;
            echo "<option value=".$v.">".$v;
        }
        echo "</select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Main Page</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        echo "1. <select name='new_mainpage_1'><option value=-1 selected>Don't change";
        foreach($global->main_page as $gmpid=>$gmpnm)  echo "<option value=".$gmpid.">".$gmpnm;
        echo "</select><br>2. <select name='new_mainpage_2'><option value=-2 selected>Don't change<option value=-1>Do not use";
        foreach($global->main_page as $gmpid=>$gmpnm)  echo "<option value=".$gmpid.">".$gmpnm;
        echo "</select><br>3. <select name='new_mainpage_3'><option value=-2 selected>Don't change<option value=-1>Do not use";
        foreach($global->main_page as $gmpid=>$gmpnm)  echo "<option value=".$gmpid.">".$gmpnm;
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show in toplist</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_toplist><option value=-1 selected>Don't change<option value=1>Yes<option value=0>No</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Clicks order (&quot;n/c&quot; to not change)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        $html->input(11,'normal','text','new_clickorder',15,165,'n/c');
        echo "</td>
            </tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Content skim</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_skim><option value=-1 selected>Don't change";
        for($i=0;$i<=100;$i++) echo "<option value=".$i.">".$i."%";
        echo "</select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept proxy traffic</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=checkbox name=new_proxy value=-1 checked> Don't change<br>
            <input type=checkbox name=new_proxy_tr value=1 checked> Transparent<br>
            <input type=checkbox name=new_proxy_dt value=1 checked> Distorting<br>
            <input type=checkbox name=new_proxy_an value=1 checked> Anonimous
            </font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept noref hits</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_acc_nr_hit><option value=-1 selected>Don't change<option value=1>Yes<option value=0>No</select>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept noref clicks</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_acc_nr_click><option value=-1 selected>Don't change<option value=1>Yes<option value=0>No</select>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>No JSCookie clicks counts as</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_nojs><option value=-1 selected>Don't change<option value=1>Normal Click<option value=0>NoCookie Click</select>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_proxy_pr><option value=-1>Don't change";
        for($i=0;$i<=100;$i++) echo "<option value=".$i.">".$i."%";
        echo "</select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>NoCookie traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_nocook_pr><option value=-1>Don't change";
        for($i=0;$i<=100;$i++) echo "<option value=".$i.">".$i."%";
        echo "</select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>NoRef traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_noref_pr><option value=-1>Don't change";
        for($i=0;$i<=100;$i++) echo "<option value=".$i.">".$i."%";
        echo "</select></td></tr>
            <tr>
            <td colspan=2 bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt><font size=1>Short Forces</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Hourly Hits</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><script>dmnt4()</script></select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Duration</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_sfdur><option value=0>Don't change";
        for($i=1;$i<=240;$i++) if($i==1) echo "<option value=".$i.">".$i." hour"; else echo "<option value=".$i.">".$i." hours";
        echo "</select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' colspan=2 align=center>";
        $html->button('submit','Update Trades','light');
        echo "</td>
            </tr>
            </table>
            <br>";


        $html->main_table_footer();
        $html->sub_page_footer();
        exit;
    }

    function mass_update(){
        global $trader,$global;

        $change=false;
        $shortchange=false;
        $confirmed=$_POST['confirmed'];
        if(!is_array($confirmed) || count($confirmed)<1) $this->shortstats();
        $new_tradetype=$_POST['new_tradetype'];
        if($new_tradetype>-1) $change=true;
        $new_mintrade=$_POST['new_mintrade'];
        if($new_mintrade>-1) $change=true;
        $new_setratio=$_POST['new_setratio'];
        if($new_setratio>-1) $change=true;
        $new_mainpage_1=$_POST['new_mainpage_1'];
        if($new_mainpage_1>-1) $change=true;
        $new_mainpage_2=$_POST['new_mainpage_2'];
        if($new_mainpage_2>-2) $change=true;
        $new_mainpage_3=$_POST['new_mainpage_3'];
        if($new_mainpage_3>-2) $change=true;
        $new_toplist=$_POST['new_toplist'];
        if($new_toplist>-1) $change=true;
        $new_clickorder=$_POST['new_clickorder'];
        if($new_clickorder!='n/c') $change=true;
        $new_skim=$_POST['new_skim'];
        if($new_skim>-1) $change=true;
        $new_proxy=$_POST['new_proxy'];
        if($new_proxy!=-1) $change=true;
        $new_proxy_tr=$_POST['new_proxy_tr'] or $new_proxy_tr=0;
        $new_proxy_dt=$_POST['new_proxy_dt'] or $new_proxy_dt=0;
        $new_proxy_an=$_POST['new_proxy_an'] or $new_proxy_an=0;
        $new_acc_nr_hit=$_POST['new_acc_nr_hit'];
        if($new_acc_nr_hit>-1) $change=true;
        $new_acc_nr_click=$_POST['new_acc_nr_click'];
        if($new_acc_nr_click>-1) $change=true;
        $new_nojs=$_POST['new_nojs'];
        if($new_nojs>-1) $change=true;
        $new_proxy_pr=$_POST['new_proxy_pr'];
        if($new_proxy_pr>-1) $change=true;
        $new_nocook_pr=$_POST['new_nocook_pr'];
        if($new_nocook_pr>-1) $change=true;
        $new_noref_pr=$_POST['new_noref_pr'];
        if($new_noref_pr>-1) $change=true;
        $new_sfhits=$_POST['new_sfhits'];
        if($new_sfhits>-1) $shortchange=true;
        $new_sfdur=$_POST['new_sfdur'];
        if($new_sfdur>0) $shortchange=true;

        if(!$change && !$shortchange) $this->shortstats();
        if($change){
            $this->read_traders();

            $ud=false;
            foreach($confirmed as $udom){
                if(!$trader->url["$udom"]) continue;
                $ud=true;
                if($new_tradetype>-1) $trader->trade_type["$udom"]=$new_tradetype;
                if($new_mintrade>-1) $trader->mintrade["$udom"]=$new_mintrade;
                if($new_setratio>-1) $trader->set_ratio["$udom"]=$new_setratio;
                if($new_mainpage_1>-1) $trader->main_pages["$udom"][0]=$new_mainpage_1;
                if($new_mainpage_2>-2){
                    if($new_mainpage_2==-1) unset($trader->main_pages["$udom"][1]);
                    else $trader->main_pages["$udom"][1]=$new_mainpage_2;
                }
                if($new_mainpage_3>-2){
                    if($new_mainpage_3==-1) unset($trader->main_pages["$udom"][2]);
                    else $trader->main_pages["$udom"][2]=$new_mainpage_3;
                }
                if($new_toplist>-1) $trader->toplist_allowed["$udom"]=$new_toplist;
                if($new_clickorder!='n/c') $trader->click_rule["$udom"]=$new_clickorder;
                if($new_skim>-1) $trader->content_skim["$udom"]=$new_skim;
                if($new_proxy!=-1){
                    $trader->proxy_an["$udom"]=$new_proxy_an;
                    $trader->proxy_ds["$udom"]=$new_proxy_dt;
                    $trader->proxy_tr["$udom"]=$new_proxy_tr;
                }
                if($new_acc_nr_hit>-1) $trader->badref_in["$udom"]=$new_acc_nr_hit;
                if($new_acc_nr_click>-1) $change=true;
                if($new_nojs>-1) $trader->nojs_rule["$udom"]=$new_nojs;
                if($new_proxy_pr>-1) $trader->proxy_cl_pr["$udom"]=$new_proxy_pr;
                if($new_nocook_pr>-1) $trader->nocookie_pr["$udom"]=$new_nocook_pr;
                if($new_noref_pr>-1) $trader->badref_cl_pr["$udom"]=$new_noref_pr;
            }

            if($ud){
                $this->backup_traders();
                $this->write_traders();
            }
        }
        if($shortchange){
            $global->read_short_forces();
            foreach($confirmed as $udom){
                if($global->short_force["$udom"]){
                    if($new_sfhits>0) $global->short_min["$udom"]=$new_sfhits;
                    if($new_sfdur>0){
                        $global->short_force["$udom"]=time();
                        $global->short_duration["$udom"]=$new_sfdur;
                    }
                    if($new_sfhits==0) unset($global->short_min["$udom"]);
                } else {
                    if($new_sfhits>0 && $new_sfdur>0){
                        $global->short_force["$udom"]=time();
                        $global->short_min["$udom"]=$new_sfhits;
                        $global->short_duration["$udom"]=$new_sfdur;
                    }
                }
            }
            $global->save_shortforces();
        }
        if($change) $this->shortstats(false); else $this->shortstats();
    }

    function reset_trades(){
        global $settings,$log;

        $to_reset=$_POST['checked'];
        if(!is_array($to_reset) || count($to_reset)<1) $this->shortstats();

        $sf=@fopen($settings->data_path.'/to_reset.dat','w');
        if(!$sf){
            $log->error('TRADES RESETS file write fault');
            $this->shortstats();
        }
        @flock($sf,LOCK_EX);
        foreach($to_reset as $rdom) @fwrite($sf,$rdom."\n");
        @flock($sf,LOCK_UN);
        @fclose($sf);
        @chmod($settings->data_path.'/to_reset.dat', 0777);

        $this->shortstats();
    }

    function make_resets(){
        global $stats,$settings;

        $to_reset=@file($settings->data_path.'/to_reset.dat');
        if(!$to_reset || !is_array($to_reset)) return true;
        foreach($to_reset as $rdom){
            $rdom=trim($rdom);
            $stats->hour_in["$rdom"]=0;
            $stats->hour_in_trad_uniq["$rdom"]=0;
            $stats->hour_in_glob_uniq["$rdom"]=0;
            $stats->hour_in_proxy["$rdom"]=0;
            $stats->hour_out["$rdom"]=0;
            $stats->hour_out_proxy["$rdom"]=0;
            $stats->hour_click["$rdom"]=0;
            $stats->hour_click_proxy["$rdom"]=0;
            $stats->hour_click_nojs["$rdom"]=0;
            $stats->hour_click_cont["$rdom"]=0;
            $stats->hour_click_uniq["$rdom"]=0;
            $stats->hour_click_repeats["$rdom"]=0;
            $stats->hour_lang["$rdom"]=0;
            $stats->day_in["$rdom"]=0;
            $stats->day_in_trad_uniq["$rdom"]=0;
            $stats->day_in_glob_uniq["$rdom"]=0;
            $stats->day_in_proxy["$rdom"]=0;
            $stats->day_out["$rdom"]=0;
            $stats->day_out_proxy["$rdom"]=0;
            $stats->day_click["$rdom"]=0;
            $stats->day_click_proxy["$rdom"]=0;
            $stats->day_click_nojs["$rdom"]=0;
            $stats->day_click_cont["$rdom"]=0;
            $stats->day_click_uniq["$rdom"]=0;
            $stats->day_click_repeats["$rdom"]=0;
            $stats->day_lang["$rdom"]=0;
            $stats->hour_prod["$rdom"]=0;
            $stats->hour_ca["$rdom"]=0;
            $stats->hour_lf["$rdom"]=0;
            $stats->hour_act["$rdom"]=0;
            $stats->hour_eff["$rdom"]=0;
            $stats->day_prod["$rdom"]=0;
            $stats->day_ret["$rdom"]=0;
            $stats->day_ca["$rdom"]=0;
            $stats->day_eff["$rdom"]=0;
            $stats->day_act["$rdom"]=0;
            $stats->debt["$rdom"]=-1;
        }
    }

    function update_trade(){
        global $trader;

        $new_url=$_POST['new_url'];
        $udom=$_POST['eddom'];
        if(strlen($new_url)<10 || !stristr($new_url,'http://')) $this->shortstats();
        $this->read_traders();
        if(!$trader->url["$udom"]) $this->shortstats(false);

        $trader->url["$udom"]=str_replace('|','',$new_url);
        $trader->set_ratio["$udom"]=$_POST['new_ratio'];
        $trader->trade_type["$udom"]=$_POST['new_tradetype'];
        $trader->proxy_an["$udom"]=$_POST['new_proxy_an'];
        $trader->proxy_ds["$udom"]=$_POST['new_proxy_ds'];
        $trader->proxy_tr["$udom"]=$_POST['new_proxy_tr'];
        $trader->badref_in["$udom"]=$_POST['new_noref_hits'];
        $trader->main_pages["$udom"]=array();
        $nmp=$_POST['new_mainpage'];
        if(is_array($nmp)){
            foreach($nmp as $nmpid)
                if($nmpid>=0) $trader->main_pages["$udom"][]=$nmpid;
        }
        $trader->click_rule["$udom"]=str_replace('|','',$_POST['new_click_rule']);
        $trader->content_skim["$udom"]=$_POST['new_skim'];
        $trader->mintrade["$udom"]=$_POST['new_mintrade'];
        $trader->nocookie_pr["$udom"]=$_POST['new_nocookie_pr'];
        $trader->badref_click["$udom"]=$_POST['new_noref_clicks'];
        $trader->badref_cl_pr["$udom"]=$_POST['new_badref_cl_pr'];
        $trader->proxy_cl_pr["$udom"]=$_POST['new_proxy_cl_pr'];
        $trader->nojs_rule["$udom"]=$_POST['new_nojs_clicks'];
        $trader->site_name["$udom"]=str_replace('|','',$_POST['new_sitename']);
        $trader->e_mail["$udom"]=str_replace('|','',$_POST['new_email']);
        $trader->nick["$udom"]=str_replace('|','',$_POST['new_wmnick']);
        $trader->icq["$udom"]=str_replace('|','',$_POST['new_icq']);
        $trader->toplist_allowed["$udom"]=$_POST['new_toplist'];

        $this->backup_traders();
        $this->write_traders();
        $this->shortstats(false);
    }

    function short_forces($rt=true,$rf=true){
        global $global,$intf,$html,$trader;

        $html->sub_page_header('Short Forces');
        $html->script_dmnt2();
        $html->script_sfdmnt();
        $html->main_table_header('Time Limited Forces');

        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=15>&nbsp;</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=340 class=nt><font size=1>URL</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=60 class=nt><font size=1>Hourly Hits</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=185 class=nt><font size=1>Time to End</font></td>
            </tr>";

        if($rf) $global->read_short_forces();
        if($rt) $this->read_traders();

        if(is_array($global->short_force)){
            foreach($global->short_force as $fdom=>$stime){
                $tend=($stime+($global->short_duration["$fdom"]*3600))-time();
                $ts='';
                if($tend<1) $ts='Completed';
                else {
                    $tmin=ceil($tend/60);
                    $thour=floor($tmin/60);
                    $tmin=$tmin-$thour*60;
                    if($thour>0){if($thour<2) $ts=$thour.' hour,'; else $ts=$thour.' hours,';}
                    $ts.=' '.$tmin.' minutes';
                }
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='del_rule[]' value='".$fdom."';></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><a href='".$trader->url["$fdom"]."' target=_blank title='Trade ".$fdom."'>".$trader->url["$fdom"]."</a></font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><script>sfdmnt(".$global->short_min["$fdom"].",'".$fdom."')</script></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=hidden name='to_update[]' value='".$fdom."'>
                    <nobr><font size=1>".$ts."</font> <select name='sf_sh[".$fdom."]'>";
                $sb=0-$thour;
                for($i=$sb;$i<=24;$i++){
                    if($i==0) $s=' selected'; else $s='';
                    if($i>=0) $v='+'.$i; else $v=$i;
                    echo "<option value=".$i.$s.">".$v." hours";
                }
                echo "</select></nobr></td>
                    </tr>";
            }
        }

        echo "<tr><td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=4></td></tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=4>";
        if(is_array($trader->url)) foreach($trader->url as $trd=>$tru) if(!$global->short_force["$trd"]) $noforced++;
        if($noforced>0){
            echo "<table width=100% border=0>
                <tr>
                <td align=center><font size=1>Select Trade</font><br><select name=new_to_force>";
            foreach($trader->url as $trd=>$tru) if(!$global->short_force["$trd"]) echo "<option value='".$trd."'>".$trd." - ".$tru;
            echo "</td><td align=center><font size=1>Hourly Hits</font><br><script>dmnt2();</script></td>
                <td align=center><font size=1>Duration</font><br><select name=new_duration>";
            for($i=1;$i<=240;$i++){
                echo "<option value=".$i.">".$i;
                if($i==1) echo ' hour'; else echo ' hours';
            }
            echo "</select></td>
                </tr><tr>
                <td colspan=3 align=center>";
                $html->button('submit','Add Forces','light');
                echo "</td>
                </tr>
            </table>";
        }
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=4>";
        $html->button('submit','Update Forces','light');
        echo " &nbsp; &nbsp; &nbsp; ";
        $html->button('submit','Remove Forces','light');
        echo "</td>
            </tr>
            </table>
            <br>
            ";
        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function remove_forces(){
        global $global;

        $to_del=$_POST['del_rule'];
        if(!is_array($to_del)) $this->short_forces();
        $global->read_short_forces();
        $uf=false;
        foreach($to_del as $ddom){
            if($global->short_force["$ddom"]){
                $uf=true;
                unset($global->short_force["$ddom"]);
                unset($global->short_min["$ddom"]);
                unset($global->short_duration["$ddom"]);
            }
        }
        if($uf) $global->save_shortforces();
        $this->short_forces(true,false);
    }

    function update_forces(){
        global $global,$trader;

        $to_update=$_POST['to_update'];
        if(!is_array($to_update)) $this->short_forces();
        $global->read_short_forces();
        $sf_shift=$_POST['sf_sh'];
        $new_sf=$_POST['new_shortf'];
        $uf=false;
        foreach($to_update as $udom){
            if($global->short_force["$udom"]){
                $uf=true;
                $global->short_min["$udom"]=$new_sf["$udom"];
                $nd=$global->short_duration["$udom"]+$sf_shift["$udom"];
                if($nd<1) $nd=1;
                if($nd>240) $nd=240;
                $global->short_duration["$udom"]=$nd;
            }
        }
        if($uf) $global->save_shortforces();
        $this->short_forces(true,false);
    }

    function add_forces(){
        global $global,$trader;

        $new_fdom=$_POST['new_to_force'];
        $new_min=$_POST['new_mintrade'];
        $new_duration=$_POST['new_duration'];
        if(!$new_fdom || $new_min<1 || $new_duration<1) $this->short_forces();
        $this->read_traders();
        if(!$trader->url["$new_fdom"]) $this->short_forces(false);
        $global->read_short_forces();
        if(!$global->short_force["$new_fdom"]){
            $global->short_force["$new_fdom"]=time();
            $global->short_min["$new_fdom"]=$new_min;
            $global->short_duration["$new_fdom"]=$new_duration;
            $global->save_shortforces();
        }
        $this->short_forces(false,false);
    }

    function show_events($rf=true){
        global $global,$intf,$html,$trader;

        $dayname=array(1=>'Sunday',2=>'Monday',3=>'Tuesday',4=>'Wednesday',5=>'Thursday',6=>'Friday',7=>'Saturday');

        $html->sub_page_header('Long forces');
        $html->script_evf();
        $html->main_table_header('Events schedule');
        if($rf) $global->read_long_forces();
        $this->read_traders();

        echo "<br>
            <table width=800 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=30>&nbsp;</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=340 class=nt><font size=1>URL</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=150 class=nt><font size=1>Time</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=150 class=nt><font size=1>Hits</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=150 class=nt><font size=1>State</font></td>
            </tr>";

        if(is_array($global->events_list)){
            foreach($global->events_list as $enum=>$edom){
                if($global->event_st_day[$enum]==0 || $global->event_ed_day[$enum]==0){
                    $st_time=$global->event_st_hour[$enum]*60+$global->event_st_min[$enum];
                    $ed_time=$global->event_ed_hour[$enum]*60+$global->event_ed_min[$enum];
                    $ch=date('G');
                    $cm=date('i');
                    $ct_time=$ch*60+$cm;
                    $t_str='Daily<br>From: '.$global->event_st_hour[$enum].':'.$global->event_st_min[$enum].'<br>Until: '.$global->event_ed_hour[$enum].':'.$global->event_ed_min[$enum];
                } else {
                    $st_time=($global->event_st_day[$enum]-1)*60*24+$global->event_st_hour[$enum]*60+$global->event_st_min[$enum];
                    $ed_time=($global->event_ed_day[$enum]-1)*60*24+$global->event_ed_hour[$enum]*60+$global->event_ed_min[$enum];
                    $ch=date('G');
                    $cm=date('i');
                    $cd=date('w');
                    $ct_time=$cd*60*24+$ch*60+$cm;
                    $t_str='From: '.$dayname[$global->event_st_day[$enum]].', '.$global->event_st_hour[$enum].':'.$global->event_st_min[$enum].'<br>Until: '.$dayname[$global->event_ed_day[$enum]].', '.$global->event_ed_hour[$enum].':'.$global->event_ed_min[$enum];
                }
                $tp_str=$global->event_min[$enum].'/hour';
                if($st_time<$ed_time){
                    if($ct_time>=$st_time && $ct_time<=$ed_time) $state='<font color='.$intf->color['ACT_EVENT'].'>Active</font>';
                    else $state='<font color='.$intf->color['INACT_EV'].'>Inactive</font>';
                } else {
                    if($ct_time>=$st_time || $ct_time<=$ed_time) $state='<font color='.$intf->color['ACT_EVENT'].'>Active</font>';
                    else $state='<font color='.$intf->color['INACT_EV'].'>Inactive</font>';
                }
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='del_event[]' value='".$enum."'></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><a href='".$trader->url["$edom"]."' target=_blank title='Trade ".$edom."'>".$trader->url["$edom"]."</a></font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center>".$t_str."</td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>".$tp_str."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>".$state."</font></td>
                    </tr>";
            }
        }

        echo "<tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' colspan=5></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' colspan=5 align=center>
            <table width=100% border=0>
            <tr>
            <td align=center><font size=1>Select Trade</font><br><select name=new_event_dom>";
        if(is_array($trader->url)) foreach($trader->url as $trd=>$tru) echo "<option value='".$trd."'>".$trd." - ".$tru;
        echo "</select></td>
            <td align=center><font size=1>Starts at:<br><select name=st_day><option value=0 selected>Daily";
        foreach($dayname as $did=>$dnm) echo "<option value=".$did.">".$dnm;
        echo "</select><br><select name=st_hour>";
        for($i=0;$i<=23;$i++){
            if($i<10) $v='0'.$i; else $v=$i;
            echo "<option value=".$v.">".$v;
        }
        echo "</select> : <select name=st_min>";
        for($i=0;$i<=59;$i++){
            if($i<10) $v='0'.$i; else $v=$i;
            echo "<option value=".$v.">".$v;
        }
        echo "</select></td>
            <td align=center><font size=1>Stops at:<br><select name=ed_day><option value=0 selected>Daily";
        foreach($dayname as $did=>$dnm) echo "<option value=".$did.">".$dnm;
        echo "</select><br><select name=ed_hour>";
        for($i=0;$i<=23;$i++){
            if($i<10) $v='0'.$i; else $v=$i;
            echo "<option value=".$v.">".$v;
        }
        echo "</select> : <select name=ed_min>";
        for($i=0;$i<=59;$i++){
            if($i<10) $v='0'.$i; else $v=$i;
            echo "<option value=".$v.">".$v;
        }
        echo "</select></td>
            <td align=center><font size=1>Hits: <script>evf()</script></td>
            </tr>
            <tr>
            <td align=center colspan=4>";
        $html->button('submit','Add Event','light');
        echo "</td>
            </tr>
            <tr>
            </tr>
            </table>
            </td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' colspan=5 align=center>";
        $html->button('submit','Delete Events','light');
        echo "</td>
            </tr>
            </table>
            <br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function add_event(){
        global $global;

        $edom=$_POST['new_event_dom'];
        $st_day=$_POST['st_day'];
        $st_hour=$_POST['st_hour'];
        $st_min=$_POST['st_min'];
        $ed_day=$_POST['ed_day'];
        $ed_hour=$_POST['ed_hour'];
        $ed_min=$_POST['ed_min'];
        $e_force=$_POST['ev_forces'];
        if($st_day==0 || $ed_day==0){ $st_day=0; $ed_day=0; }
        if(!$edom || $e_force<1 || ($st_day==$ed_day && $st_hour==$ed_hour && $st_min==$ed_min)) $this->show_events();
        $global->read_long_forces();
        $fnum=count($global->events_list);
        $global->events_list[$fnum]=$edom;
        $global->event_st_day[$fnum]=$st_day;
        $global->event_st_hour[$fnum]=$st_hour;
        $global->event_st_min[$fnum]=$st_min;
        $global->event_ed_day[$fnum]=$ed_day;
        $global->event_ed_hour[$fnum]=$ed_hour;
        $global->event_ed_min[$fnum]=$ed_min;
        $global->event_min[$fnum]=$e_force;
        $global->save_long_forces();
        $this->show_events(false);
    }

    function delete_events(){
        global $global;

        $to_del=$_POST['del_event'];
        if(!is_array($to_del)) $this->show_events();
        $global->read_long_forces();
        foreach($to_del as $did){
            unset($global->events_list[$did]);
            unset($global->event_st_day[$did]);
            unset($global->event_st_hour[$did]);
            unset($global->event_st_min[$did]);
            unset($global->event_ed_day[$did]);
            unset($global->event_ed_hour[$did]);
            unset($global->event_ed_min[$did]);
            unset($global->event_min[$did]);
        }
        $global->save_long_forces();
        $this->show_events(false);
    }

    function show_blacklist($rl=true){
        global $global,$intf,$html;

        $html->sub_page_header('Blacklist');
        $html->main_table_header('Blacklisted domains');
        if($rl) $global->read_blacklist();

        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=30>&nbsp;</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=370 class=nt><font size=1>Domain</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=200 class=nt><font size=1>Blacklisted date</font></td>
            </tr>";
        if(is_array($global->in_blacklist)){
            ksort($global->in_blacklist);
            foreach($global->in_blacklist as $bld=>$blt){
                $ts=date('jS of F Y',$blt);
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='domchecked[]' value='".$bld."'></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$bld."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$ts."</font></td>
                    </tr>";
            }
        }

        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3>
            <font size=1>New domain: &nbsp ";
        $html->input(11,'normal','text','new_to_blacklist',30,65,'');
        echo " &nbsp; ";
        $html->button('submit','Add to Blacklist','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3>";
        $html->button('submit','Remove from Blacklist','light');
        echo "</td>
            </tr>
            </table><br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;

    }

    function add_new_to_blacklist(){
        global $global;

        $nd=strtolower(str_replace('|','',$_POST['new_to_blacklist']));
        if(strlen($nd)<3 || !stristr($nd,'.')) $this->show_blacklist();
        $global->read_blacklist();
        if(!$global->in_blacklist["$nd"]){
            $global->in_blacklist["$nd"]=time();
            $global->save_blacklist();
        }
        $this->show_blacklist(false);
    }

    function remove_from_blacklist(){
        global $global;

        $to_del=$_POST['domchecked'];
        if(!is_array($to_del) || count($to_del)<1) $this->show_blacklist();
        $global->read_blacklist();
        $ub=false;
        foreach($to_del as $tdom){
            if($global->in_blacklist["$tdom"]){
                unset($global->in_blacklist["$tdom"]);
                $ub=true;
            }
        }
        if($ub) $global->save_blacklist();
        $this->show_blacklist(false);
    }

    function show_groups($rg=true){
        global $global,$intf,$html,$trader;

        $html->sub_page_header('Trade Groups');
        $html->main_table_header('Setting Groups of Trades');
        $this->read_traders();

        if($rg) $global->read_groups();
        if(is_array($global->group)) $group_num=count($global->group); else $group_num=0;

        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=3><font size=1><b>Current Groups</b></font></tr>";

        if($group_num>0){
            foreach($global->group as $gr_name=>$gr_trds){
                echo "<tr>
                    <td bgcolor='".$intf->color['STB_HEADER']."' align=center><input type=checkbox name='group_to_del[]' value='".$gr_name."'></td>
                    <td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2 class=nt>Group <b>&quot;".$gr_name."&quot;</b></td></tr>";
                if(is_array($gr_trds)){
                    foreach($gr_trds as $gtrd){
                        echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='to_del_trade[".$gr_name."][]' value='".$gtrd."'></td>
                            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$gtrd."</font></td>";
                        $tr_url=$trader->url["$gtrd"];
                        echo "<td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><a href='".$tr_url."' target=_blank>".$tr_url."</a></font></td></tr>";
                    }
                }
                echo "<tr><td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3></td></tr>";
            }
            echo "<tr><td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3></td></tr>";
        }

        echo "<tr><td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3><font size=1>New Group: </font>";
        $html->input(11,'normal','text','new_group',15,30,'');
        echo ' &nbsp; ';
        $html->button('submit','Create Group','light');
        echo "</td></tr>";
        if($group_num>0){
            echo "<tr>
                <td colspan=3 bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center>
                <table border=0 width=550>
                <tr>
                <td><font size=1>Add Trades</font></td><td><select name='trade_to_group[]' multiple>";
            if(is_array($trader->url)) foreach($trader->url as $trdom=>$trurl) echo "<option value='".$trdom."'>".$trdom;
            echo "</select></td><td><font size=1>to the Group</font></td><td><select name=to_group>";
            foreach($global->group as $grpn=>$grpt) echo "<option value='".$grpn."'>".$grpn;
            echo "</select></td><td>";
            $html->button('submit','Add To Group','light');
            echo "</td></tr></table></td>
                </tr>
                <tr>
                <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3>";
            $html->button('submit','Remove Group','light');
            echo ' &nbsp; &nbsp; &nbsp; ';
            $html->button('submit','Remove Trades','light');
            echo "</td>
                </tr>
                ";
        }
        echo "</table><br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function remove_group(){
        global $global;

        $g_to_del=$_POST['group_to_del'];
        if(!is_array($g_to_del)) $this->show_groups();
        $global->read_groups();
        foreach($g_to_del as $gdel) unset($global->group["$gdel"]);
        $global->save_groups();
        $this->show_groups(false);
    }

    function remove_trades(){
        global $global;

        $to_del_trades=$_POST['to_del_trade'];
        if(!is_array($to_del_trades)) $this->show_groups();
        $global->read_groups();
        foreach($to_del_trades as $grnm=>$gtrd){
            foreach($gtrd as $rtrd){
                $k=array_search($rtrd,$global->group["$grnm"]);
                if($k===false) continue;
                unset($global->group["$grnm"][$k]);
            }
        }
        $global->save_groups();
        $this->show_groups(false);
    }

    function add_to_group(){
        global $global;

        $to_add=$_POST['trade_to_group'];
        $to_group=$_POST['to_group'];
        if(!is_array($to_add) || !$to_group) $this->show_groups();
        $global->read_groups();
        foreach($to_add as $ntr) if(!in_array($ntr,$global->group["$to_group"])) $global->group["$to_group"][]=$ntr;
        $global->save_groups();
        $this->show_groups(false);
    }

    function create_group(){
        global $global;

        $new_group=strtolower(strip_tags(str_replace(' ','',str_replace('|','',$_POST['new_group']))));
        if(strlen($new_group)<1) $this->show_groups();

        $global->read_groups();
        if(is_array($global->group) && array_key_exists($new_group,$global->group)) $this->show_groups(false);
        $global->group["$new_group"]=array();
        $global->save_groups();
        $this->show_groups(false);
    }

    function show_special_urls($rdex=true,$rdnc=true,$rdfl=true,$rdlh=true,$rdlc=true,$rdnr=true){
        global $html,$intf,$global;

        $html->sub_page_header('Special Urls Settings');
        $html->main_table_header('URLs for sorted traffic');

        if($rdex) $global->read_exout_urls();
        if($rdnc) $global->read_nocookie_urls();
        if($rdfl) $global->read_filtered_urls();
        if($rdlh) $global->read_langhit_urls();
        if($rdlc) $global->read_langclick_urls();
        if($rdnr) $global->read_noref_urls();

        echo "<br>
            <table width=700 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=3><font size=1><b>ExOut traffic URLs</b></font></tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center width=30>&nbsp;</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=500 class=nt>URL</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=170 class=nt>Traffic %</td>
            </tr>";
        $un=0;
        if(is_array($global->exout_urls)){
            foreach($global->exout_urls as $url=>$prc){
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='exchecked[]' value=".$un."></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><a href='".$url."' target=_blank><font size=1>".$url."</font></a></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>".$prc."%</font></td></tr>";
                $un++;
            }
        }
        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3><font size=1>New ExOut Url: &nbsp;";
        $html->input(11,'normal','text','new_exurl',40,165,'');
        echo ", &nbsp; traffic: &nbsp;</font><select name=new_exprc>";
        for($i=1;$i<=100;$i++){
            if($i>=100) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i."%";
        }
        echo "</select> &nbsp; ";
        $html->button('submit','Add ExOut URL','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3>";
        $html->button('submit','Delete ExOut URLs','light');
        echo "</td>
            </tr>
            </table>
            <br>
            <table width=700 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=3><font size=1><b>NoRef traffic URLs</b></font></tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center width=30>&nbsp;</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=500 class=nt>URL</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=170 class=nt>Traffic %</td>
            </tr>";
        $un=0;
        if(is_array($global->noref_urls)){
            foreach($global->noref_urls as $url=>$prc){
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='nrchecked[]' value=".$un."></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><a href='".$url."' target=_blank><font size=1>".$url."</font></a></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>".$prc."%</font></td></tr>";
                $un++;
            }
        }
        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3><font size=1>New NoRef Url: &nbsp;";
        $html->input(11,'normal','text','new_nrurl',40,165,'');
        echo ", &nbsp; traffic: &nbsp;</font><select name=new_nrprc>";
        for($i=1;$i<=100;$i++){
            if($i>=100) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i."%";
        }
        echo "</select> &nbsp; ";
        $html->button('submit','Add NoRef URL','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3>";
        $html->button('submit','Delete NoRef URLs','light');
        echo "</td>
            </tr>
            </table>
            <br>
            <table width=700 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=3><font size=1><b>NoCookie traffic URLs</b></font></tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center width=30>&nbsp;</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=500 class=nt>URL</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=170 class=nt>Traffic %</td>
            </tr>";
        $un=0;
        if(is_array($global->nocookie_urls)){
            foreach($global->nocookie_urls as $url=>$prc){
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='ncchecked[]' value=".$un."></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><a href='".$url."' target=_blank><font size=1>".$url."</font></a></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>".$prc."%</font></td></tr>";
                $un++;
            }
        }
        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3><font size=1>New NoCookie Url: &nbsp;";
        $html->input(11,'normal','text','new_ncurl',40,165,'');
        echo ", &nbsp; traffic: &nbsp;</font><select name=new_ncprc>";
        for($i=1;$i<=100;$i++){
            if($i>=100) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i."%";
        }
        echo "</select> &nbsp; ";
        $html->button('submit','Add NoCookie URL','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3>";
        $html->button('submit','Delete NoCookie URLs','light');
        echo "</td>
            </tr>
            </table>
            <br>
            <table width=700 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=3><font size=1><b>Filtered traffic URLs</b></font></tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center width=30>&nbsp;</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=500 class=nt>URL</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=170 class=nt>Traffic %</td>
            </tr>";
        $un=0;
        if(is_array($global->filtered_urls)){
            foreach($global->filtered_urls as $url=>$prc){
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='flchecked[]' value=".$un."></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><a href='".$url."' target=_blank><font size=1>".$url."</font></a></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>".$prc."%</font></td></tr>";
                $un++;
            }
        }
        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3><font size=1>New Filtered Url: &nbsp;";
        $html->input(11,'normal','text','new_flurl',40,165,'');
        echo ", &nbsp; traffic: &nbsp;</font><select name=new_flprc>";
        for($i=1;$i<=100;$i++){
            if($i>=100) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i."%";
        }
        echo "</select> &nbsp; ";
        $html->button('submit','Add Filtered URL','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3>";
        $html->button('submit','Delete Filtered URLs','light');
        echo "</td>
            </tr>
            </table>
            <br>
            <table width=700 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=3><font size=1><b>Specific languages Hits redirects URLs</b></font></tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center width=30>&nbsp;</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=170 class=nt>Language</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=500 class=nt>URL</td>
            </tr>";
        if(is_array($global->lnghit_urls)){
            foreach($global->lnghit_urls as $lng=>$url){
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='lnghitchecked[".$lng."]' value=1></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>".$lng."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><a href='".$url."' target=_balnk>".$url."</a></font></td></tr>";
            }
        }
        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3><font size=1>New Language: &nbsp;";
        $html->input(11,'normal','text','new_hitlang',6,30,'');
        echo ", &nbsp; URL: &nbsp;";
        $html->input(11,'normal','text','new_hitlngurl',40,165,'');
        echo " &nbsp; ";
        $html->button('submit','Add Hit URL','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3>";
        $html->button('submit','Delete Hit URLs','light');
        echo "</td>
            </tr>
            </table>
            <br>
            <table width=700 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=3><font size=1><b>Specific languages Clicks redirects URLs</b></font></tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center width=30>&nbsp;</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=170 class=nt>Language</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=500 class=nt>URL</td>
            </tr>";
        if(is_array($global->lngclick_urls)){
            foreach($global->lngclick_urls as $lng=>$url){
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='lngclickchecked[".$lng."]' value=1></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>".$lng."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><a href='".$url."' target=_balnk>".$url."</a></font></td></tr>";
            }
        }
        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3><font size=1>New Language: &nbsp;";
        $html->input(11,'normal','text','new_clicklang',6,30,'');
        echo ", &nbsp; URL: &nbsp;";
        $html->input(11,'normal','text','new_clicklngurl',40,165,'');
        echo " &nbsp; ";
        $html->button('submit','Add Click URL','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3>";
        $html->button('submit','Delete Click URLs','light');
        echo "</td>
            </tr>
            </table>
            <br>
            ";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function add_lnghit_url(){
        global $global;

        $new_lang=str_replace('|','',$_POST['new_hitlang']);
        $new_url=str_replace('|','',$_POST['new_hitlngurl']);

        if(!$new_lang || !$new_url) $this->show_special_urls();

        $global->read_langhit_urls();
        if($global->lnghit_urls["$new_lang"]!=$new_url){
            $global->lnghit_urls["$new_lang"]=$new_url;
            $global->save_lnghit_urls();
        }
        $this->show_special_urls(true,true,true,false);
    }

    function delete_lngclick_urls(){
        global $global;

        $to_del=$_POST['lngclickchecked'];
        if(!is_array($to_del)) $this->show_special_urls();
        $global->read_langclick_urls();
        $ud=false;
        foreach($to_del as $lng=>$lngc){
            if($global->lngclick_urls["$lng"]){
                unset($global->lngclick_urls["$lng"]);
                $ud=true;
            }
        }
        if($ud) $global->save_lngclick_urls();
        $this->show_special_urls(true,true,true,true,false);
    }

    function delete_lnghit_urls(){
        global $global;

        $to_del=$_POST['lnghitchecked'];
        if(!is_array($to_del)) $this->show_special_urls();
        $global->read_langhit_urls();
        $ud=false;
        foreach($to_del as $lng=>$lngc){
            if($global->lnghit_urls["$lng"]){
                unset($global->lnghit_urls["$lng"]);
                $ud=true;
            }
        }
        if($ud) $global->save_lnghit_urls();
        $this->show_special_urls(true,true,true,false);
    }

    function add_lngclick_url(){
        global $global;

        $new_lang=str_replace('|','',$_POST['new_clicklang']);
        $new_url=str_replace('|','',$_POST['new_clicklngurl']);

        if(!$new_lang || !$new_url) $this->show_special_urls();

        $global->read_langclick_urls();
        if($global->lngclick_urls["$new_lang"]!=$new_url){
            $global->lngclick_urls["$new_lang"]=$new_url;
            $global->save_lngclick_urls();
        }
        $this->show_special_urls(true,true,true,true,false);
    }

    function add_nocookie_url(){
        global $global;

        $new_url=$_POST['new_ncurl'];
        $new_prc=$_POST['new_ncprc'] or $new_prc=1;
        $global->read_nocookie_urls();
        if($global->nocookie_urls["$new_url"]) $this->show_special_urls(true,false);
        $global->nocookie_urls["$new_url"]=$new_prc;
        $tot_prc=0;
        foreach($global->nocookie_urls as $url=>$prc) $tot_prc+=$prc;
        if($tot_prc>0) $k=100/$tot_prc; else $k=1;
        foreach($global->nocookie_urls as $url=>$prc) $global->nocookie_urls["$url"]=round($prc*$k);
        $global->save_nocookie_urls();
        $this->show_special_urls(true,false);
    }

    function add_noref_url(){
        global $global;

        $new_url=$_POST['new_nrurl'];
        $new_prc=$_POST['new_nrprc'] or $new_prc=1;
        $global->read_noref_urls();
        if($global->noref_urls["$new_url"]) $this->show_special_urls(true,true,true,true,true,false);
        $global->noref_urls["$new_url"]=$new_prc;
        $tot_prc=0;
        foreach($global->noref_urls as $url=>$prc) $tot_prc+=$prc;
        if($tot_prc>0) $k=100/$tot_prc; else $k=1;
        foreach($global->noref_urls as $url=>$prc) $global->noref_urls["$url"]=round($prc*$k);
        $global->save_noref_urls();
        $this->show_special_urls(true,true,true,true,true,false);
    }

    function add_filtered_url(){
        global $global;

        $new_url=$_POST['new_flurl'];
        $new_prc=$_POST['new_flprc'] or $new_prc=1;
        $global->read_filtered_urls();
        if($global->filtered_urls["$new_url"]) $this->show_special_urls(true,true,false);
        $global->filtered_urls["$new_url"]=$new_prc;
        $tot_prc=0;
        foreach($global->filtered_urls as $url=>$prc) $tot_prc+=$prc;
        if($tot_prc>0) $k=100/$tot_prc; else $k=1;
        foreach($global->filtered_urls as $url=>$prc) $global->filtered_urls["$url"]=round($prc*$k);
        $global->save_filtered_urls();
        $this->show_special_urls(true,true,false);
    }

    function delete_filtered_urls(){
        global $global;

        $to_del=$_POST['flchecked'];
        if(!is_array($to_del) || count($to_del)<1) $this->show_special_urls();
        $global->read_filtered_urls();
        if(!is_array($global->filtered_urls)) $this->show_special_urls();
        $ei=0;
        $ue=false;
        $temp_ex=$global->filtered_urls;
        foreach($temp_ex as $url=>$prc){
            if(in_array($ei,$to_del)){
                $ue=true;
                unset($global->filtered_urls["$url"]);
            }
            $ei++;
        }
        unset($temp_ex);
        if($ue){
            $tot_prc=0;
            foreach($global->filtered_urls as $url=>$prc) $tot_prc+=$prc;
            if($tot_prc>0) $k=100/$tot_prc; else $k=1;
            foreach($global->filtered_urls as $url=>$prc) $global->filtered_urls["$url"]=round($prc*$k);
            $global->save_filtered_urls();
        }
        $this->show_special_urls(true,true,false);
    }

    function delete_nocookie_urls(){
        global $global;

        $to_del=$_POST['ncchecked'];
        if(!is_array($to_del) || count($to_del)<1) $this->show_special_urls();
        $global->read_nocookie_urls();
        if(!is_array($global->nocookie_urls)) $this->show_special_urls();
        $ei=0;
        $ue=false;
        $temp_ex=$global->nocookie_urls;
        foreach($temp_ex as $url=>$prc){
            if(in_array($ei,$to_del)){
                $ue=true;
                unset($global->nocookie_urls["$url"]);
            }
            $ei++;
        }
        unset($temp_ex);
        if($ue){
            $tot_prc=0;
            foreach($global->nocookie_urls as $url=>$prc) $tot_prc+=$prc;
            if($tot_prc>0) $k=100/$tot_prc; else $k=1;
            foreach($global->nocookie_urls as $url=>$prc) $global->nocookie_urls["$url"]=round($prc*$k);
            $global->save_nocookie_urls();
        }
        $this->show_special_urls(true,false);
    }

    function delete_noref_urls(){
        global $global;

        $to_del=$_POST['nrchecked'];
        if(!is_array($to_del) || count($to_del)<1) $this->show_special_urls();
        $global->read_noref_urls();
        if(!is_array($global->noref_urls)) $this->show_special_urls();
        $ei=0;
        $ue=false;
        $temp_ex=$global->noref_urls;
        foreach($temp_ex as $url=>$prc){
            if(in_array($ei,$to_del)){
                $ue=true;
                unset($global->noref_urls["$url"]);
            }
            $ei++;
        }
        unset($temp_ex);
        if($ue){
            $tot_prc=0;
            foreach($global->noref_urls as $url=>$prc) $tot_prc+=$prc;
            if($tot_prc>0) $k=100/$tot_prc; else $k=1;
            foreach($global->noref_urls as $url=>$prc) $global->noref_urls["$url"]=round($prc*$k);
            $global->save_noref_urls();
        }
        $this->show_special_urls(true,true,true,true,true,false);
    }

    function add_exout_url(){
        global $global;

        $new_url=$_POST['new_exurl'];
        $new_prc=$_POST['new_exprc'] or $new_prc=1;
        $global->read_exout_urls();
        if($global->exout_urls["$new_url"]) $this->show_special_urls(false);
        $global->exout_urls["$new_url"]=$new_prc;
        $tot_prc=0;
        foreach($global->exout_urls as $url=>$prc) $tot_prc+=$prc;
        if($tot_prc>0) $k=100/$tot_prc; else $k=1;
        foreach($global->exout_urls as $url=>$prc) $global->exout_urls["$url"]=round($prc*$k);
        $global->save_exout_urls();
        $this->show_special_urls(false);
    }

    function delete_exout_urls(){
        global $global;

        $to_del=$_POST['exchecked'];
        if(!is_array($to_del) || count($to_del)<1) $this->show_special_urls();
        $global->read_exout_urls();
        if(!is_array($global->exout_urls)) $this->show_special_urls();
        $ei=0;
        $ue=false;
        $temp_ex=$global->exout_urls;
        foreach($temp_ex as $url=>$prc){
            if(in_array($ei,$to_del)){
                $ue=true;
                unset($global->exout_urls["$url"]);
            }
            $ei++;
        }
        unset($temp_ex);
        if($ue){
            $tot_prc=0;
            foreach($global->exout_urls as $url=>$prc) $tot_prc+=$prc;
            if($tot_prc>0) $k=100/$tot_prc; else $k=1;
            foreach($global->exout_urls as $url=>$prc) $global->exout_urls["$url"]=round($prc*$k);
            $global->save_exout_urls();
        }
        $this->show_special_urls(false);
    }

    function add_trades(){
        global $html,$intf,$global,$settings;

        // Reading add state
        $fset=@file($settings->data_path.'/add_state.dat');
        if($fset){
            for($i=0;$i<10;$i++){
                list($tt,$mt,$rt)=explode('|',trim($fset[$i]));
                $tt_state[$i]=$tt or $tt_state[$i]=0;
                $mt_state[$i]=$mt or $mt_state[$i]=0;
                $rt_state[$i]=$rt or $rt_state[$i]=0;
            }
            $st_clickorder=$fset[10];
            $st_skim=$fset[11] or $st_skim=0;
            $st_prox_tr=$fset[12] or $st_prox_tr=0;
            $st_prox_ds=$fset[13] or $st_prox_ds=0;
            $st_prox_an=$fset[14] or $st_prox_an=0;
            $st_noref_hits=$fset[15] or $st_noref_hits=0;
            $st_noref_clicks=$fset[16] or $st_noref_clicks=0;
            $st_toplist=$fset[17] or $st_toplist=0;
            $st_nojs_rule=$fset[18] or $st_nojs_rule=0;
            $st_proxy_pr=$fset[19] or $st_proxy_pr=0;
            $st_nocookie_pr=$fset[20] or $st_nocookie_pr=0;
            $st_noref_pr=$fset[21] or $st_noref_pr=0;
        } else {
            $tt_state=array_fill(0,10,1);
            $mt_state=array_fill(0,10,5);
            $rt_state=array_fill(0,10,1.2);
            $st_clickorder='';
            $st_skim=50;
            $st_prox_tr=1;
            $st_prox_ds=1;
            $st_prox_an=1;
            $st_noref_hits=1;
            $st_noref_clicks=1;
            $st_toplist=1;
            $st_nojs_rule=1;
            $st_proxy_pr=100;
            $st_nocookie_pr=100;
            $st_noref_pr=100;
        }

        $html->sub_page_header('Adding new');
        $html->script_dmnt();
        $html->script_drto();
        $html->main_table_header('Adding new trades to the main list');

        echo '<br>
            <table width=800 border=0 cellpadding=5 cellspacing=1 bgcolor="'.$intf->color['STB_BACKGROUND'].'">
            <tr><td colspan=8 bgcolor="'.$intf->color['MAIN_BGCOLOR'].'"><font size=1><b>New Trades individual parameters</b></font></td></tr>
            <tr align=center>
            <td bgcolor="'.$intf->color['STB_HEADER'].'" width=230><font color="'.$intf->color['LINK_COLOR'].'">Url</font></td>
            <td bgcolor="'.$intf->color['STB_HEADER'].'" width=170><font color="'.$intf->color['LINK_COLOR'].'">Site Name</font></td>
            <td bgcolor="'.$intf->color['STB_HEADER'].'" width=70><font color="'.$intf->color['LINK_COLOR'].'">Trade Type</font></td>
            <td bgcolor="'.$intf->color['STB_HEADER'].'" width=70><font color="'.$intf->color['LINK_COLOR'].'">Min Trade</font></td>
            <td bgcolor="'.$intf->color['STB_HEADER'].'" width=50><font color="'.$intf->color['LINK_COLOR'].'">Ratio</font></td>
            <td bgcolor="'.$intf->color['STB_HEADER'].'" width=90><font color="'.$intf->color['LINK_COLOR'].'">Webmaster</font></td>
            <td bgcolor="'.$intf->color['STB_HEADER'].'" width=90><font color="'.$intf->color['LINK_COLOR'].'">ICQ</font></td>
            <td bgcolor="'.$intf->color['STB_HEADER'].'" width=90><font color="'.$intf->color['LINK_COLOR'].'">E-Mail</font></td>
            </tr>';


        for($i=0;$i<=9;$i++){
            echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."'>";
            $html->input(11,'normal','text','new_url['.$i.']',35,165,'');
            echo "</td><td bgcolor='".$intf->color['NORM_CELL']."'>";
            $html->input(11,'normal','text','new_sitename['.$i.']',20,165,'');
            echo "</td><td bgcolor='".$intf->color['NORM_CELL']."' align=center>
                <select name='new_tradetype[".$i."]'>
                <option value=0";
            if($tt_state[$i]<1) echo ' selected';
            echo ">Stopped
                <option value=1";
            if($tt_state[$i]==1) echo ' selected';
            echo ">Normal
                <option value=2";
            if($tt_state[$i]==2) echo ' selected';
            echo ">Normal+
                <option value=3";
            if($tt_state[$i]==3) echo ' selected';
            echo ">Ratio
                <option value=4";
            if($tt_state[$i]==4) echo ' selected';
            echo ">Capped
                <option value=5";
            if($tt_state[$i]==5) echo ' selected';
            echo ">Boost
                <option value=6";
            if($tt_state[$i]==6) echo ' selected';
            echo ">Quality
                <option value=7";
            if($tt_state[$i]==7) echo ' selected';
            echo ">Quality+
                </select>
                </td><td bgcolor='".$intf->color['NORM_CELL']."' align=center>
                <script>dmnt(".$i.",".$mt_state[$i].")</script>
                </td><td bgcolor='".$intf->color['NORM_CELL']."' align=center>
                <script>drto(".$i.",".$rt_state[$i].")</script>
                </td><td bgcolor='".$intf->color['NORM_CELL']."'>";
            $html->input(11,'normal','text','new_wmnick['.$i.']',12,165,'');
            echo "</td><td bgcolor='".$intf->color['NORM_CELL']."'>";
            $html->input(11,'normal','text','new_icq['.$i.']',10,165,'');
            echo "</td><td bgcolor='".$intf->color['NORM_CELL']."'>";
            $html->input(11,'normal','text','new_email['.$i.']',12,165,'');
            echo '</td></tr>';

        }
        echo '<tr><td colspan=8 bgcolor="'.$intf->color['MAIN_BGCOLOR'].'" align=center>';
        $html->button('submit','Save New Trades','light');
        echo '</td></tr><tr>
            <td colspan=8 bgcolor="'.$intf->color['MAIN_BGCOLOR'].'"><font size=1><b>New Trades common parameters</b></font></td></tr>
            <tr><td colspan=8 bgcolor="'.$intf->color['NORM_CELL'].'" align=center>
            <table width=400 border=0 cellpadding=5 cellspacing=1 bgcolor="'.$intf->color['STB_BACKGROUND'].'">
            <tr><td bgcolor="'.$intf->color['NORM_CELL'].'" width=250><font size=1>Main Page</font></td>
            <td bgcolor="'.$intf->color['NORM_CELL'].'" width=150>';

        if(count($global->main_page)<1){
            echo "No main pages";
        } else {
            $mpc=0;
            $tmpage=$global->main_page;
            reset($global->main_page);
            list($mpid,$mpname)=each($global->main_page);
            echo '<select name=new_mainpage>';
            $mrk=false;
            foreach($global->main_page as $tmpid=>$tmpname){
                if(!$mrk){ $s=' selected'; $mrk=true;}else $s='';
                echo '<option value='.$tmpid.$s.'>'.$tmpname;
            }
            echo "</select>";
        }

        echo '</td></tr>
            <tr><td bgcolor="'.$intf->color['NORM_CELL'].'"><font size=1>Show in toplist</font></td>
            <td bgcolor="'.$intf->color['NORM_CELL'].'"><select name=new_toplist><option value=1';
        if($st_toplist>0) echo ' selected';
        echo '>Yes<option value=';
        if($st_toplist<1) echo ' selected';
        echo '>No</select>
            </td></tr>
            <tr><td bgcolor="'.$intf->color['NORM_CELL'].'"><font size=1>Clicks order</font></td>
            <td bgcolor="'.$intf->color['NORM_CELL'].'">';
        $html->input(11,'normal','text','new_clickorder',15,165,$st_clickorder);
        echo '</td>
            </tr>
            <tr>
            <td bgcolor="'.$intf->color['NORM_CELL'].'"><font size=1>Content skim</font></td>
            <td bgcolor="'.$intf->color['NORM_CELL'].'">
            <select name=new_skim>';
        for($i=0;$i<=100;$i++){
            if($i==$st_skim) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">$i%";
        }
        echo "</select></td>
            </tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept proxy traffic</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=checkbox name=new_prox_tr value=1";
        if($st_prox_tr>0) echo ' checked';
        echo "> Transparent<br>
            <input type=checkbox name=new_prox_ds value=1";
        if($st_prox_ds>0) echo ' checked';
        echo "> Distorting<br>
            <input type=checkbox name=new_prox_an value=1";
        if($st_prox_an>0) echo ' checked';
        echo "> Anonimous
            </td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept NoRef hits</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_noref_hits><option value=1";
        if($st_noref_hits>0) echo ' selected';
        echo ">Yes<option value=";
        if($st_noref_hits<1) echo ' selected';
        echo ">No</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept NoRef clicks</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_noref_clicks><option value=1";
        if($st_noref_clicks>0) echo ' selected';
        echo ">Yes<option value=0";
        if($st_noref_clicks<1) echo ' selected';
        echo ">No</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>No JSCookie click counts as</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_nojs_rule><option value=1";
        if($st_nojs_rule>0) echo ' selected';
        echo ">Normal Click<option value=0";
        if($st_nojs_rule<1) echo ' selected';
        echo ">NoCookie Click</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_proxy_pr>";
        for($i=0;$i<=100;$i++){
            if($i==$st_proxy_pr) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">$i%";
        }
        echo "</select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>NoCookie traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_nocookie_pr>";
        for($i=0;$i<=100;$i++){
            if($i==$st_nocookie_pr) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">$i%";
        }
        echo "</select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>NoRef traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_noref_pr>";
        for($i=0;$i<=100;$i++){
            if($i==$st_noref_pr) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">$i%";
        }
        echo "</select></td></tr>
            </table>
            </td></tr>
            <tr><td align=center colspan=8 bgcolor='".$intf->color['MAIN_BGCOLOR']."'>";
            $html->button('submit','Save New Trades','light');
            echo "</td></tr>
            </table>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function backup_traders(){
        global $settings;
        @copy($settings->data_path.'/traders.dat',$settings->bakup_path.'/traders.'.time().'.dat');
    }

    function blacklist_trades(){
        global $trader,$global;

        $to_del=$_POST['checked'];
        if(!is_array($to_del) || count($to_del)<1) $this->shortstats();
        $this->read_traders();
        $global->read_groups();
        $global->read_blacklist();
        $global->read_short_forces();
        $global->read_long_forces();
        $bc=false;
        $bg=false;
        $blf=false;
        $bsf=false;
        foreach($to_del as $ddom){
            if($trader->url["$ddom"]){
                $global->in_blacklist["$ddom"]=time();
                if(is_array($global->group)){
                    foreach($global->group as $grname=>$grdat){
                        if(!is_array($grdat)) continue;
                        $gn=array_search($ddom,$grdat);
                        if($gn===false) continue;
                        unset($global->group["$grname"][$gn]);
                        $bg=true;
                    }
                }
                if($global->short_force["$ddom"]){
                    unset($global->short_force["$ddom"]);
                    $bsf=true;
                }
                if(is_array($global->events_list)){
                    foreach($global->events_list as $evid=>$edom){
                        if($edom==$ddom){
                            unset($global->events_list[$evid]);
                            $blf=true;
                        }
                    }
                }
                unset($trader->url["$ddom"]);
                $trader->num--;
                $bc=true;
            }
        }
        if($bg) $global->save_groups();
        if($bsf) $global->save_shortforces();
        if($blf) $global->save_long_forces();
        if($bc){
            $this->backup_traders();
            $this->write_traders();
            $global->save_blacklist();
        }
        $this->shortstats(false);
    }

    function save_new_trades(){
        global $trader,$new_trader,$global,$settings,$log;

        $new_url=$_POST['new_url'];
        if(!is_array($new_url) || count($new_url)<1) $this->shortstats();

        $this->read_traders();
        $this->read_new_traders();
        $global->read_blacklist();

        $new_mainpages=$_POST['new_mainpage'];
        $new_clickorder=str_replace('|','',$_POST['new_clickorder']);
        $new_skim=$_POST['new_skim'];
        $new_prox_tr=$_POST['new_prox_tr'] or $new_prox_tr=0;
        $new_prox_ds=$_POST['new_prox_ds'] or $new_prox_ds=0;
        $new_prox_an=$_POST['new_prox_ds'] or $new_prox_an=0;
        $new_noref_hits=$_POST['new_noref_hits'];
        $new_noref_clicks=$_POST['new_noref_clicks'];
        $new_toplist=$_POST['new_toplist'];
        $new_nojs_rule=$_POST['new_nojs_rule'];
        $new_proxy_pr=$_POST['new_proxy_pr'];
        $new_nocookie_pr=$_POST['new_nocookie_pr'];
        $new_noref_pr=$_POST['new_noref_pr'];
        $arr_sitename=$_POST['new_sitename'];
        $arr_tradetype=$_POST['new_tradetype'];
        $arr_mintrade=$_POST['new_mintrade'];
        $arr_ratio=$_POST['new_ratio'];
        $arr_wmnick=$_POST['new_wmnick'];
        $arr_icq=$_POST['new_icq'];
        $arr_email=$_POST['new_email'];

        $bc=false;
        foreach($new_url as $newid=>$newurl){
            if(strlen($newurl)<10 || !stristr($newurl,'http://') || stristr($newurl,'|')) continue;
            $ndom=get_domain($newurl);
            if($trader->url["$ndom"] || $new_trader->url["$ndom"] || $global->in_blacklist["$ndom"]) continue;
            $newurl=str_replace('|','',trim($newurl));
            $bc=true;
            $new_sitename=str_replace('|','',trim($arr_sitename[$newid]));
            $new_tradetype=$arr_tradetype[$newid];
            $new_mintrade=$arr_mintrade[$newid];
            $new_ratio=$arr_ratio[$newid];
            $new_wmnick=str_replace('|','',$arr_wmnick[$newid]);
            $new_icq=str_replace('|','',$arr_icq[$newid]);
            $new_email=str_replace('|','',$arr_email[$newid]);

            $trader->url["$ndom"]=$newurl;
            $trader->set_ratio["$ndom"]=$new_ratio;
            $trader->trade_type["$ndom"]=$new_tradetype;
            $trader->proxy_an["$ndom"]=$new_prox_an;
            $trader->proxy_ds["$ndom"]=$new_prox_ds;
            $trader->proxy_tr["$ndom"]=$new_prox_tr;
            $trader->badref_in["$ndom"]=$new_noref_hits;
            $trader->main_pages["$ndom"][]=$new_mainpages;
            $trader->click_rule["$ndom"]=$new_clickorder;
            $trader->content_skim["$ndom"]=$new_skim;
            $trader->mintrade["$ndom"]=$new_mintrade;
            $trader->nocookie_pr["$ndom"]=$new_nocookie_pr;
            $trader->badref_click["$ndom"]=$new_noref_clicks;
            $trader->badref_cl_pr["$ndom"]=$new_noref_pr;
            $trader->proxy_cl_pr["$ndom"]=$new_proxy_pr;
            $trader->nojs_rule["$ndom"]=$new_nojs_rule;
            $trader->site_name["$ndom"]=$new_sitename;
            $trader->e_mail["$ndom"]=$new_email;
            $trader->nick["$ndom"]=$new_wmnick;
            $trader->icq["$ndom"]=$new_icq;
            $trader->toplist_allowed["$ndom"]=$new_toplist;
            $trader->time_added["$ndom"]=time();
            $trader->num++;
        }
        if($bc){
            $this->backup_traders();
            $this->write_traders();
        }
        // Saving add form state
        $fp=@fopen($settings->data_path.'/add_state.dat','w');
        if($fp){
            @flock($fp,LOCK_EX);
            for($i=0;$i<10;$i++) @fwrite($fp,$arr_tradetype[$i].'|'.$arr_mintrade[$i].'|'.$arr_ratio[$i]."\n");
            @fwrite($fp,$new_clickorder."\n");
            @fwrite($fp,$new_skim."\n");
            @fwrite($fp,$new_prox_tr."\n");
            @fwrite($fp,$new_prox_ds."\n");
            @fwrite($fp,$new_prox_an."\n");
            @fwrite($fp,$new_noref_hits."\n");
            @fwrite($fp,$new_noref_clicks."\n");
            @fwrite($fp,$new_toplist."\n");
            @fwrite($fp,$new_nojs_rule."\n");
            @fwrite($fp,$new_proxy_pr."\n");
            @fwrite($fp,$new_nocookie_pr."\n");
            @fwrite($fp,$new_noref_pr."\n");
            @flock($fp,LOCK_UN);
            @fclose($fp);
            @chmod($settings->data_path.'/add_state.dat',0777);
        } else {
            $log->error('Can not save add form state');
            @chmod($this->data_path.'/add_state.dat',0777);
        }

        $this->shortstats(false,false);
    }

    function delete_trades(){
        global $trader,$global;

        $to_del=$_POST['checked'];
        if(!is_array($to_del) || count($to_del)<1) $this->shortstats();
        $this->read_traders();
        $global->read_groups();
        $global->read_short_forces();
        $global->read_long_forces();
        $bc=false;
        $bg=false;
        $blf=false;
        $bsf=false;
        foreach($to_del as $ddom){
            if($trader->url["$ddom"]){
                if(is_array($global->group)){
                    foreach($global->group as $grname=>$grdat){
                        if(!is_array($grdat)) continue;
                        $gn=array_search($ddom,$grdat);
                        if($gn===false) continue;
                        unset($global->group["$grname"][$gn]);
                        $bg=true;
                    }
                }
                if($global->short_force["$ddom"]){
                    unset($global->short_force["$ddom"]);
                    $bsf=true;
                }
                if(is_array($global->events_list)){
                    foreach($global->events_list as $evid=>$edom){
                        if($edom==$ddom){
                            unset($global->events_list[$evid]);
                            $blf=true;
                        }
                    }
                }
                unset($trader->url["$ddom"]);
                $trader->num--;
                $bc=true;
            }
        }
        if($bg) $global->save_groups();
        if($bc){
            $this->backup_traders();
            $this->write_traders();
        }
        if($bsf) $global->save_shortforces();
        if($blf) $global->save_long_forces();
        $this->shortstats(false);
    }

    function accept_new(){
        global $trader,$new_trader;

        $to_accept=$_POST['checked'];
        if(!is_array($to_accept) || count($to_accept)<1) $this->shortstats();
        $this->read_traders();
        $this->read_new_traders();

        $bc=false;
        foreach($to_accept as $adom){
            if(!$new_trader->url["$adom"]) continue;
            $bc=true;

            $trader->url["$adom"]=$new_trader->url["$adom"];
            $trader->set_ratio["$adom"]=$new_trader->set_ratio["$adom"];
            $trader->trade_type["$adom"]=$new_trader->trade_type["$adom"];
            $trader->proxy_an["$adom"]=$new_trader->proxy_an["$adom"];
            $trader->proxy_ds["$adom"]=$new_trader->proxy_ds["$adom"];
            $trader->proxy_tr["$adom"]=$new_trader->proxy_tr["$adom"];
            $trader->badref_in["$adom"]=$new_trader->badref_in["$adom"];
            $trader->main_pages["$adom"]=$new_trader->main_pages["$adom"];
            $trader->click_rule["$adom"]=$new_trader->click_rule["$adom"];
            $trader->content_skim["$adom"]=$new_trader->content_skim["$adom"];
            $trader->mintrade["$adom"]=$new_trader->mintrade["$adom"];
            $trader->nocookie_pr["$adom"]=$new_trader->nocookie_pr["$adom"];
            $trader->badref_click["$adom"]=$new_trader->badref_click["$adom"];
            $trader->badref_cl_pr["$adom"]=$new_trader->badref_cl_pr["$adom"];
            $trader->proxy_cl_pr["$adom"]=$new_trader->proxy_cl_pr["$adom"];
            $trader->nojs_rule["$adom"]=$new_trader->nojs_rule["$adom"];
            $trader->site_name["$adom"]=$new_trader->site_name["$adom"];
            $trader->e_mail["$adom"]=$new_trader->e_mail["$adom"];
            $trader->nick["$adom"]=$new_trader->nick["$adom"];
            $trader->icq["$adom"]=$new_trader->icq["$adom"];
            $trader->toplist_allowed["$adom"]=$new_trader->toplist_allowed["$adom"];
            $trader->time_added["$adom"]=$new_trader->time_added["$adom"];
            $trader->num++;
            $new_trader->num--;
            unset($new_trader->url["$adom"]);
        }
        if($bc){
            $this->backup_traders();
            $this->write_traders();
            $this->write_new_traders();
        }
        $this->shortstats(false,false);
    }

    function delete_new(){
        global $new_trader;

        $to_del=$_POST['checked'];
        if(!is_array($to_del) || count($to_del)<1) $this->shortstats();

        $this->read_new_traders();
        $bc=true;
        foreach($to_del as $ddom){
            if(!$new_trader->url["$ddom"]) continue;
            $bc=true;

            unset($new_trader->url["$ddom"]);
            $new_trader->num--;
        }
        if($bc) $this->write_new_traders();
        $this->shortstats(true,false);
    }

    function blacklist_new(){
        global $new_trader,$global;

        $to_del=$_POST['checked'];
        if(!is_array($to_del) || count($to_del)<1) $this->shortstats();

        $this->read_new_traders();
        $global->read_blacklist();
        $bc=true;
        foreach($to_del as $ddom){
            if(!$new_trader->url["$ddom"]) continue;
            $global->in_blacklist["$ddom"]=time();
            $bc=true;

            unset($new_trader->url["$ddom"]);
            $new_trader->num--;
        }
        if($bc){
            $this->write_new_traders();
            $global->save_blacklist();
        }
        $this->shortstats(true,false);
    }


    function write_traders(){
        // Writing traders
        global $trader,$settings,$log;

        if(!$fp=@fopen($settings->data_path.'/traders.dat','w')){
            $log->error('Can not access Traders database file for writing');
            @chmod($settings->data_path.'/traders.dat', 0777);
            return false;
        }
        @flock($fp,LOCK_EX);
        ksort($trader->url);
        foreach($trader->url as $dom=>$url){
            $p1=$trader->set_ratio["$dom"];
            $p2=$trader->trade_type["$dom"];
            $p3=$trader->proxy_an["$dom"];
            $p4=$trader->proxy_ds["$dom"];
            $p5=$trader->proxy_tr["$dom"];
            $p6=$trader->badref_in["$dom"];
            $p7=@join('.',$trader->main_pages["$dom"]);
            $p8=$trader->click_rule["$dom"];
            $p9=$trader->content_skim["$dom"];
            $p10=$trader->mintrade["$dom"];
            $p11=$trader->nocookie_pr["$dom"];
            $p12=$trader->badref_click["$dom"];
            $p13=$trader->badref_cl_pr["$dom"];
            $p14=$trader->proxy_cl_pr["$dom"];
            $p15=$trader->nojs_rule["$dom"];
            $p16=$trader->site_name["$dom"];
            $p17=$trader->e_mail["$dom"];
            $p18=$trader->nick["$dom"];
            $p19=$trader->icq["$dom"];
            $p20=$trader->toplist_allowed["$dom"];
            $p21=$trader->time_added["$dom"];
            @fwrite($fp,$dom.'|'.$url.'|'.$p1.'|'.$p2.'|'.$p3.'|'.$p4.'|'.$p5.'|'.$p6.'|'.$p7.'|'.$p8.'|'.$p9.'|'.$p10.'|'.$p11.'|'.$p12.'|'.$p13.'|'.$p14.'|'.$p15.'|'.$p16.'|'.$p17.'|'.$p18.'|'.$p19.'|'.$p20.'|'.$p21."\n");
        }
        @flock($fp,LOCK_UN);
        @fclose($fp);
        @chmod($settings->data_path.'/traders.dat', 0777);
        return true;
    }

    function write_new_traders(){
        // Writing traders
        global $new_trader,$settings,$log;

        if(!$fp=@fopen($settings->data_path.'/new_traders.dat','w')){
            $log->error('Can not access New Traders database file for writing');
            @chmod($settings->data_path.'/new_traders.dat', 0777);
            return false;
        }
        @flock($fp,LOCK_EX);
        foreach($new_trader->url as $dom=>$url){
            $p1=$new_trader->set_ratio["$dom"];
            $p2=$new_trader->trade_type["$dom"];
            $p3=$new_trader->proxy_an["$dom"];
            $p4=$new_trader->proxy_ds["$dom"];
            $p5=$new_trader->proxy_tr["$dom"];
            $p6=$new_trader->badref_in["$dom"];
            $p7=@join('.',$new_trader->main_pages["$dom"]);
            $p8=$new_trader->click_rule["$dom"];
            $p9=$new_trader->content_skim["$dom"];
            $p10=$new_trader->mintrade["$dom"];
            $p11=$new_trader->nocookie_pr["$dom"];
            $p12=$new_trader->badref_click["$dom"];
            $p13=$new_trader->badref_cl_pr["$dom"];
            $p14=$new_trader->proxy_cl_pr["$dom"];
            $p15=$new_trader->nojs_rule["$dom"];
            $p16=$new_trader->site_name["$dom"];
            $p17=$new_trader->e_mail["$dom"];
            $p18=$new_trader->nick["$dom"];
            $p19=$new_trader->icq["$dom"];
            $p20=$new_trader->toplist_allowed["$dom"];
            $p21=$new_trader->time_added["$dom"];
            $p22=$new_trader->from_ip["$dom"];
            @fwrite($fp,$dom.'|'.$url.'|'.$p1.'|'.$p2.'|'.$p3.'|'.$p4.'|'.$p5.'|'.$p6.'|'.$p7.'|'.$p8.'|'.$p9.'|'.$p10.'|'.$p11.'|'.$p12.'|'.$p13.'|'.$p14.'|'.$p15.'|'.$p16.'|'.$p17.'|'.$p18.'|'.$p19.'|'.$p20.'|'.$p21.'|'.$p22."\n");
        }
        @flock($fp,LOCK_UN);
        @fclose($fp);
        @chmod($settings->data_path.'/new_traders.dat', 0777);
    }

    function show_global_par(){
        global $html,$global,$trader,$settings,$intf,$log;

        $html->sub_page_header('Global parameters');
        $html->main_table_header('Trades Global Parameters');
        $this->read_traders();
        $this->read_new_traders();

        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=5><font size=1><b>Main Pages</b></font></tr>
            <tr align=center>
            <td bgcolor='".$intf->color['STB_HEADER']."' width=30 class=nt>Select</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' width=30 class=nt>Default</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' width=220 class=nt>Page</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' width=170 class=nt>Used in # of Trades</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' width=150 class=nt>File Size</td>
            </tr>
            ";
        $indb=array();
        if(is_array($global->main_page)){
            foreach($global->main_page as $mpid=>$mpname){
                $indb["$mpname"]=true;
                $use_num=0;
                if(is_array($trader->url)) foreach($trader->url as $dom=>$url) if(in_array($mpid,$trader->main_pages["$dom"])) $use_num++;
                if(is_array($new_trader->url)) foreach($new_trader->url as $dom=>$url) if(in_array($mpid,$new_trader->main_pages["$dom"])) $use_num++;
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='to_del[]' value='".$mpid."'></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='is_default[".$mpid."]' value='1'";
                if($global->main_default[$mpid]>0) echo ' checked';
                echo "></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>
                    <a href='".$admin->site_url.'/'.$mpname."' target=_blank><b>".$mpname."</b></a></font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1><b>".$use_num."</b> trades</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
                if(file_exists($settings->html_path.'/'.$mpname)) echo "<font color='".$intf->color['ONDISK']."' size=1><b>".filesize($settings->html_path.'/'.$mpname)."</b> bytes</font>";
                else echo "<font color='".$intf->color['NOTONDISK']."' size=1>NOT FOUND</font>";
                echo "</td></tr>";
            }
        }
        $to_read=array();
        if($dh=@opendir($settings->html_path)){
            while(($file=readdir($dh))!==false) if($file!='.' && $file!='..' && !$indb["$file"] && !is_dir($settings->html_path.'/'.$file)) $to_read[]=$file;
            @closedir($dh);
        } else $log->error('HTML dir not found or not readable');
        if(count($to_read)>0){
            echo "<tr>
                <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=5><font size=1>Choose page to add</font>&nbsp;
                <select name=new_mainpage>";
            foreach($to_read as $trn) echo "<option value='".$trn."'>".$trn;
            echo "</select>&nbsp;&nbsp;";
            $html->button('submit','Add Page','light');
            echo "</td></tr>";
        }
        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=5>";
        $html->button('submit','Delete Pages','light');
        echo ' &nbsp; ';
        $html->button('submit','Update Pages','light');
        echo "</td></tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=3><font size=1><b>Common settings</b></font></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=400><font size=1>Minimum Hits for NEW trades required</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=200><select name=new_min_hits_new>";
        for($i=0;$i<=100;$i++){
            $v=$i*10;
            if($v==$global->min_hits_new) $s=' selected'; else $s='';
            echo "<option value=".$v.$s.">".$v;
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Minimum Hits for MAIN trades required</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_min_hits_old>";
        for($i=0;$i<=100;$i++){
            $v=$i*10;
            if($v==$global->min_hits_old) $s=' selected'; else $s='';
            echo "<option value=".$v.$s.">".$v;
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Minimum Productivity for NEW trades required</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_min_prod_new>";
        for($i=0;$i<=100;$i++){
            if($i==$global->min_prod_new) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i."%";
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Minimum Productivity for MAIN trades required</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_min_prod_old>";
        for($i=0;$i<=100;$i++){
            if($i==$global->min_prod_old) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i."%";
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Minimum Click Time accepted, sec</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_min_click_time>";
        for($i=0;$i<=9;$i++){
            if($i==$global->min_click_time) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i;
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Send Fast Clicks to</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_fast_clicks><option value=1";
        if($global->fast_to_trade>0) echo ' selected';
        echo '>Trade<option value=0';
        if($global->fast_to_trade<1) echo ' selected';
        echo ">Special URLs</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Bot Filter level</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_botfilter>";
        for($i=0;$i<=9;$i++){
            if($i==$global->bot_filter) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i;
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Maximum Hits per user accepted</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_max_hits><option value=0";
        if($global->max_hits<1) echo ' selected';
        echo ">No Limit";
        for($i=10;$i<=500;$i++){
            if($i==$global->max_hits) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i;
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Maximum Clicks per user accepted</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_max_clicks><option value=0";
        if($global->max_hits<1) echo ' selected';
        echo ">No Limit";
        for($i=10;$i<=500;$i++){
            if($i==$global->max_clicks) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i;
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Lead overclicking traffic to</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_overclicks><option value=0";
        if($global->overclicks<1) echo ' selected';
        echo ">Trades<option value=1";
        if($global->overclicks>0) echo ' selected';
        echo ">ExOut Urls</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Use language factors</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_uselang><option value=0";
        if($global->use_langs<1) echo ' selected';
        echo ">No<option value=1";
        if($global->use_langs>0) echo ' selected';
        echo ">Yes</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Send specific languages Hits to</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_lnghitred><option value=0";
        if($global->lang_hits<1) echo ' selected';
        echo ">Main Pages<option value=1";
        if($global->lang_hits>0) echo ' selected';
        echo ">Special URLs</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Send specific languages Clicks to</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_lngclcred><option value=0";
        if($global->lang_clicks<1) echo ' selected';
        echo ">Trade<option value=1";
        if($global->lang_clicks>0) echo ' selected';
        echo ">Special URLs</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Hidden Link name</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        $html->input(11,'normal','text','new_hidden',15,165,$global->hidden_name);
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>IP block time, hours</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=new_time>";
        for($i=0;$i<=72;$i++){
            if($i==$global->hidden_time) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i;
        }
        echo "</select>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=4><font size=1><b>p=a# links settings</b></font></tr>
            <tr><td width=30 bgcolor='".$intf->color['STB_HEADER']."' class=nt align=center>Link</td>
            <td width=190 bgcolor='".$intf->color['STB_HEADER']."' class=nt align=center>Content Skim</td>
            <td width=190 bgcolor='".$intf->color['STB_HEADER']."' class=nt align=center>First Click to Content</td>
            <td width=190 bgcolor='".$intf->color['STB_HEADER']."' class=nt align=center>Use Individual Settings</td>
            </tr>
            ";
        for($i=1;$i<=9;$i++){
            echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1><b>a".$i."</b></font></td>
                  <td bgcolor='".$intf->color['NORM_CELL']."' align=center><select name='new_skim_a[".$i."]'>";
            for($j=0;$j<=100;$j++){
                if($j==$global->a[$i][0]) $s=' selected'; else $s='';
                echo "<option value=".$j.$s.">".$j."%";
            }
            echo "</select></td><td bgcolor='".$intf->color['NORM_CELL']."' align=center><select name='new_fc_a[".$i."]'><option value=0";
            if($global->a[$i][1]<1) echo ' selected';
            echo ">No<option value=1";
            if($global->a[$i][1]>0) echo ' selected';
            echo ">Yes</select></td><td align=center bgcolor='".$intf->color['NORM_CELL']."'><select name='new_ind_a[".$i."]'><option value=0";
            if($global->a[$i][2]<1) echo ' selected';
            echo ">No<option value=1";
            if($global->a[$i][2]>0) echo ' selected';
            echo ">Yes</select></td></tr>";
        }
        echo "<tr><td colspan=4 bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center>";
        $html->button('submit','Update Parameters','light');
        echo "</td></tr></table><br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=3><font size=1><b>Language factors</b></font></tr>";
        if(is_array($global->langs)){
            foreach($global->langs as $lang=>$factor){
                echo "<tr align=center>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=30><input type=checkbox name='chlang[]' value='".$lang."'></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=285><font size=1>".$lang."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=285><select name=\"new_lf[".$lang."]\">";
                for($i=0;$i<=300;$i++){
                    $v=$i/100;
                    if($i==$global->langs["$lang"]) $s=' selected'; else $s='';
                    echo "<option value='".$i."'".$s.">".$v;
                }
                echo "</select></td></tr>";
            }
        }
        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' colspan=3 align=center><font size=1>New language: &nbsp;";
        $html->input(11,'normal','text','new_language',12,30,'');
        echo ', &nbsp; factor: &nbsp;</font><select name=new_factor>';
        for($i=0;$i<=300;$i++){
            if($i==100) $s=' selected'; else $s='';
            $v=$i/100;
            echo "<option value=".$i.$s.">".$v;
        }
        echo "</select> &nbsp;";
        $html->button('submit','Add Language','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' colspan=3 align=center>";
        $html->button('submit','Delete Languages','light');
        echo ' &nbsp;';
        $html->button('submit','Update Factors','light');
        echo "</td></tr>
        </table><br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function update_languages(){
        global $global;

        $new_uselang=$_POST['new_uselang'];
        $new_factors=$_POST['new_lf'];
        if((!is_array($new_factors) || count($new_factors)<1) && $new_uselang==$global->use_langs) $this->show_global_par();
        $ul=false;
        if($new_uselang!=$global->use_langs){
            $global->use_langs=$new_uselang;
            $ul=true;
        }
        if(is_array($new_factors)){
            foreach($new_factors as $nlng=>$nlfc){
                if($global->langs["$nlng"]!=$nlfc){
                    $ul=true;
                    $global->langs["$nlng"]=$nlfc;
                }
            }
        }
        if($ul) $global->save_langs();
        $this->show_global_par();
    }

    function delete_languages(){
        global $global;
        $del_langs=$_POST['chlang'];
        if(!is_array($del_langs) || count($del_langs)<1) $this->show_global_par();
        $ul=false;
        foreach($del_langs as $dlng){
            if($global->langs["$dlng"]){
                $ul=true;
                unset($global->langs["$dlng"]);
            }
        }
        if($ul) $global->save_langs();
        $this->show_global_par();
    }

    function add_language(){
        global $global;

        $new_lang=strtolower(str_replace('|','',trim($_POST['new_language'])));
        $new_lf=$_POST['new_factor'];
        if(!$global->langs["$new_lang"] && strlen($new_lang)>0){
            $global->langs["$new_lang"]=$new_lf;
            $global->save_langs();
            $this->show_global_par();
        } else $this->show_global_par();
    }

    function update_parameters(){
        global $global;

        $new_a_skim=$_POST['new_skim_a'];
        $new_a_fc=$_POST['new_fc_a'];
        $new_a_ind=$_POST['new_ind_a'];

        $global->min_hits_new=$_POST['new_min_hits_new'];
        $global->min_hits_old=$_POST['new_min_hits_old'];
        $global->min_prod_new=$_POST['new_min_prod_new'];
        $global->min_prod_old=$_POST['new_min_prod_old'];
        $global->bot_filter=$_POST['new_botfilter'];
        $global->min_click_time=$_POST['new_min_click_time'];
        $global->fast_to_trade=$_POST['new_fast_clicks'];
        $global->max_hits=$_POST['new_max_hits'];
        $global->max_clicks=$_POST['new_max_clicks'];
        $global->overclicks=$_POST['new_overclicks'];
        $global->lang_hits=$_POST['new_lnghitred'];
        $global->lang_clicks=$_POST['new_lngclcred'];
        $global->a[1]=array(0=>$new_a_skim[1],1=>$new_a_fc[1],2=>$new_a_ind[1]);
        $global->a[2]=array(0=>$new_a_skim[2],1=>$new_a_fc[2],2=>$new_a_ind[2]);
        $global->a[3]=array(0=>$new_a_skim[3],1=>$new_a_fc[3],2=>$new_a_ind[3]);
        $global->a[4]=array(0=>$new_a_skim[4],1=>$new_a_fc[4],2=>$new_a_ind[4]);
        $global->a[5]=array(0=>$new_a_skim[5],1=>$new_a_fc[5],2=>$new_a_ind[5]);
        $global->a[6]=array(0=>$new_a_skim[6],1=>$new_a_fc[6],2=>$new_a_ind[6]);
        $global->a[7]=array(0=>$new_a_skim[7],1=>$new_a_fc[7],2=>$new_a_ind[7]);
        $global->a[8]=array(0=>$new_a_skim[8],1=>$new_a_fc[8],2=>$new_a_ind[8]);
        $global->a[9]=array(0=>$new_a_skim[9],1=>$new_a_fc[9],2=>$new_a_ind[9]);
        $global->hidden_name=str_replace('|','',$_POST['new_hidden']);
        $global->hidden_time=$_POST['new_time'];
        $global->use_langs=$_POST['new_uselang'];
        $global->save_glob_par();
        $global->save_langs();
        $this->show_global_par();
    }

    function add_mainpage(){
        global $global;

        $new_page=$_POST['new_mainpage'];
        if(!$new_page || strlen($new_page)<1 || (is_array($global->main_page) && in_array($new_page,$global->main_page))) $this->show_global_par;
        $found=false;
        $id=-1;
        if(is_array($global->main_page)){
            while(!$found){
                $id++;
                if(!array_key_exists($id,$global->main_page)) $found=true;
            }
        } else $id=0;
        $global->main_page[$id]=$new_page;
        $global->save_mainpages();
        $this->show_global_par();
    }

    function update_mainpages(){
        global $global;

        $is_default=$_POST['is_default'];
        if(!is_array($is_default)){
            reset($global->main_page);
            foreach($global->main_page as $mpid=>$mpnm)
                $global->main_default[$mpid]=0;
        } else {
            foreach($global->main_page as $mpid=>$mpnm)
                if($is_default[$mpid]>0) $global->main_default[$mpid]=1;
                else $global->main_default[$mpid]=0;
        }
        $global->save_mainpages();
        $this->show_global_par();
    }

    function delete_mainpages(){
        global $global,$trader,$new_trader;

        $to_del=$_POST['to_del'];
        if(!is_array($to_del) || count($to_del)<1) $this->show_global_par();
        $this->read_traders();
        $this->read_new_traders();
        $use_num=0;
        if(is_array($trader->url)) foreach($trader->url as $dom=>$url) if(in_array($mpid,$trader->main_pages["$dom"])) $use_num++;
        if(is_array($new_trader->url)) foreach($new_trader->url as $dom=>$url) if(in_array($mpid,$new_trader->main_pages["$dom"])) $use_num++;
        $sv=false;
        foreach($to_del as $chid){
            if(array_key_exists($chid,$global->main_page)){
                $use_num=0;
                if(is_array($trader->url)) foreach($trader->url as $dom=>$url) if(in_array($chid,$trader->main_pages["$dom"])) $use_num++;
                if(is_array($new_trader->url)) foreach($new_trader->url as $dom=>$url) if(in_array($chid,$new_trader->main_pages["$dom"])) $use_num++;
                if($use_num<1){
                    $sv=true;
                    unset($global->main_page[$chid]);
                }
            }
        }
        if($sv) $global->save_mainpages();
        $this->show_global_par();
    }

    function sort_trades($sort_field){
        global $trader,$stats;

        switch($sort_field){
            case 'trade':
                @arsort($trader->trade_type);
                $stats->dom_sorted=@array_keys($trader->trade_type);
            break;
            case 'hrin':
                @arsort($stats->hour_in);
                $stats->dom_sorted=@array_keys($stats->hour_in);
            break;
            case 'htruin':
                @arsort($stats->hour_in_trad_uniq);
                $stats->dom_sorted=@array_keys($stats->hour_in_trad_uniq);
            break;
            case 'hgluin':
                @arsort($stats->hour_in_glob_uniq);
                $stats->dom_sorted=@array_keys($stats->hour_in_glob_uniq);
            break;
            case 'hout':
                @arsort($stats->hour_out);
                $stats->dom_sorted=@array_keys($stats->hour_out);
            break;
            case 'hclicks':
                @arsort($stats->hour_click);
                $stats->dom_sorted=@array_keys($stats->hour_click);
            break;
            case 'hnojs':
                @arsort($stats->hour_click_nojs);
                $stats->dom_sorted=@array_keys($stats->hour_click_nojs);
            break;
            case 'hcont':
                @arsort($stats->hour_click_cont);
                $stats->dom_sorted=@array_keys($stats->hour_click_cont);
            break;
            case 'hprod':
                @arsort($stats->hour_prod);
                $stats->dom_sorted=@array_keys($stats->hour_prod);
            break;
            case 'hca':
                @arsort($stats->hour_ca);
                $stats->dom_sorted=@array_keys($stats->hour_ca);
            break;
            case 'hact':
                @arsort($stats->hour_act);
                $stats->dom_sorted=@array_keys($stats->hour_act);
            break;
            case 'hupr':
                @arsort($stats->hour_uniq_prod);
                $stats->dom_sorted=@array_keys($stats->hour_uniq_prod);
            break;
            case 'hlang':
                @arsort($stats->hour_lf);
                $stats->dom_sorted=@array_keys($stats->hour_lf);
            break;
            case 'drin':
                @arsort($stats->day_in);
                $stats->dom_sorted=@array_keys($stats->day_in);
            break;
            case 'dtruin':
                @arsort($stats->day_in_trad_uniq);
                $stats->dom_sorted=@array_keys($stats->day_in_trad_uniq);
            break;
            case 'dgluin':
                @arsort($stats->day_in_glob_uniq);
                $stats->dom_sorted=@array_keys($stats->day_in_glob_uniq);
            break;
            case 'dout':
                @arsort($stats->day_out);
                $stats->dom_sorted=@array_keys($stats->day_out);
            break;
            case 'dclicks':
                @arsort($stats->day_click);
                $stats->dom_sorted=@array_keys($stats->day_click);
            break;
            case 'dnojs':
                @arsort($stats->day_click_nojs);
                $stats->dom_sorted=@array_keys($stats->day_click_nojs);
            break;
            case 'dcont':
                @arsort($stats->day_click_cont);
                $stats->dom_sorted=@array_keys($stats->day_click_cont);
            break;
            case 'dprod':
                @arsort($stats->day_prod);
                $stats->dom_sorted=@array_keys($stats->day_prod);
            break;
            case 'dca':
                @arsort($stats->day_ca);
                $stats->dom_sorted=@array_keys($stats->day_ca);
            break;
            case 'dact':
                @arsort($stats->day_act);
                $stats->dom_sorted=@array_keys($stats->day_act);
            break;
            case 'dupr':
                @arsort($stats->day_uniq_prod);
                $stats->dom_sorted=@array_keys($stats->day_uniq_prod);
            break;
            case 'dlang':
                @arsort($stats->day_lf);
                $stats->dom_sorted=@array_keys($stats->day_lf);
            break;
            case 'mintrade':
                @arsort($trader->mintrade);
                $stats->dom_sorted=@array_keys($trader->mintrade);
            break;
            case 'setratio':
                @arsort($trader->set_ratio_sort);
                $stats->dom_sorted=@array_keys($trader->set_ratio_sort);
            break;
            case 'return':
                @arsort($stats->day_ret);
                $stats->dom_sorted=@array_keys($stats->day_ret);
            break;
            case 'effect':
                @arsort($stats->day_eff);
                $stats->dom_sorted=@array_keys($stats->day_eff);
            break;
            case 'debt':
                @arsort($stats->debt);
                $stats->dom_sorted=@array_keys($stats->debt);
            break;
            case 'date':
                @asort($trader->time_added);
                $stats->dom_sorted=@array_keys($trader->time_added);
            break;
            case 'webmaster':
                @asort($trader->nick);
                $stats->dom_sorted=@array_keys($trader->nick);
            break;
            default:
                @ksort($trader->url);
                $stats->dom_sorted=@array_keys($trader->url);
            break;
        }

    }

    function read_traders(){
        // Reading traders
        global $settings,$log,$trader;

        if(!$fp=@fopen($settings->data_path.'/traders.dat','r')){
            $log->error('Traders database file not found or not readable');
            @chmod($settings->data_path.'/traders.dat', 0777);
            // Fatal error
            echo "<center><font face=arial size=2 color=red><b>Traders database file not found or not readable</b></font></center>";
            exit;
            return false;
        }
        @flock($fp,LOCK_EX);
        $trd=@fread($fp,filesize($settings->data_path.'/traders.dat'));
        $tr_dat=explode("\n",$trd);
        foreach($tr_dat as $tr_dl){
            if(strlen($tr_dl)<30) continue;
            list($dom,$url,$set_ratio,$trade_type,$proxy_an,$proxy_ds,$proxy_tr,$badref_in,$m_pages,$c_rule,$c_skim,$f_rule,$nc_pr,$acc_badref,$badref_cl_pr,$proxy_cl_pr,$njs_r,$s_name,$e_mail,$nick,$icq,$toplist,$time_added)=explode('|',trim($tr_dl));
            if(!$dom) continue;

            $trader->url["$dom"]=$url;
            $trader->set_ratio["$dom"]=$set_ratio;
            $trader->trade_type["$dom"]=$trade_type;
            if($trade_type==0 || $trade_type==2 || $trade_type==3 || $trade_type==4) $trader->set_ratio_sort["$dom"]=$set_ratio;
            else $trader->set_ratio_sort["$dom"]='Auto';
            $trader->proxy_an["$dom"]=$proxy_an;
            $trader->proxy_ds["$dom"]=$proxy_ds;
            $trader->proxy_tr["$dom"]=$proxy_tr;
            $trader->badref_in["$dom"]=$badref_in;
            $trader->main_pages["$dom"]=explode('.',$m_pages);
            $trader->click_rule["$dom"]=$c_rule;
            $trader->content_skim["$dom"]=$c_skim;
            $trader->mintrade["$dom"]=$f_rule;
            $trader->nocookie_pr["$dom"]=$nc_pr;
            $trader->badref_click["$dom"]=$acc_badref;
            $trader->badref_cl_pr["$dom"]=$badref_cl_pr;
            $trader->proxy_cl_pr["$dom"]=$proxy_cl_pr;
            $trader->nojs_rule["$dom"]=$njs_r;
            $trader->site_name["$dom"]=$s_name;
            $trader->e_mail["$dom"]=$e_mail;
            $trader->nick["$dom"]=$nick;
            $trader->icq["$dom"]=$icq;
            $trader->toplist_allowed["$dom"]=$toplist;
            $trader->time_added["$dom"]=$time_added;
            $trader->num++;
        }
        $trader->listed=$trader->num;
        @flock($fp,LOCK_UN);
        @fclose($fp);

        return true;
    }

    function read_new_traders(){
        // Reading new traders
        global $settings,$new_trader;

        if(!$tr_dat=@file($settings->data_path.'/new_traders.dat')){
            @chmod($settings->data_path.'/new_traders.dat', 0777);
            return false;
        }

        foreach($tr_dat as $tr_dl){
            if(strlen($tr_dl)<30) continue;
            list($dom,$url,$set_ratio,$trade_type,$proxy_an,$proxy_ds,$proxy_tr,$badref_in,$m_pages,$c_rule,$c_skim,$f_rule,$nc_pr,$acc_badref,$badref_cl_pr,$proxy_cl_pr,$njs_r,$s_name,$e_mail,$nick,$icq,$toplist,$time_added,$from_ip)=explode('|',trim($tr_dl));
            if(!$dom) continue;

            $new_trader->url["$dom"]=$url;
            $new_trader->set_ratio["$dom"]=$set_ratio;
            $new_trader->trade_type["$dom"]=$trade_type;
            $new_trader->proxy_an["$dom"]=$proxy_an;
            $new_trader->proxy_ds["$dom"]=$proxy_ds;
            $new_trader->proxy_tr["$dom"]=$proxy_tr;
            $new_trader->badref_in["$dom"]=$badref_in;
            $new_trader->main_pages["$dom"]=explode('.',$m_pages);
            $new_trader->click_rule["$dom"]=$c_rule;
            $new_trader->content_skim["$dom"]=$c_skim;
            $new_trader->mintrade["$dom"]=$f_rule;
            $new_trader->nocookie_pr["$dom"]=$nc_pr;
            $new_trader->badref_click["$dom"]=$acc_badref;
            $new_trader->badref_cl_pr["$dom"]=$badref_cl_pr;
            $new_trader->proxy_cl_pr["$dom"]=$proxy_cl_pr;
            $new_trader->nojs_rule["$dom"]=$njs_r;
            $new_trader->site_name["$dom"]=$s_name;
            $new_trader->e_mail["$dom"]=$e_mail;
            $new_trader->nick["$dom"]=$nick;
            $new_trader->icq["$dom"]=$icq;
            $new_trader->toplist_allowed["$dom"]=$toplist;
            $new_trader->time_added["$dom"]=$time_added;
            $new_trader->from_ip["$dom"]=$from_ip;
            $new_trader->num++;
        }
    }

    function read_stats(){
        global $settings,$log,$stats;
        // Reading Main stats
        if($st_dat=@file($settings->data_path.'/short_stats.dat')){
            // Reading express stats
            foreach($st_dat as $st_dl){
                if(strlen($st_dl)<5) continue;
                list($dom,$hour_in,$hour_trad_uin,$hour_glob_uin,$hour_in_proxy,$hour_out,$hour_out_proxy,$hour_click,$hour_click_proxy,$hour_click_uniq,$hour_nojs,$hour_cont,$hour_rclicks,$hour_lang,$day_in,$day_trad_uin,$day_glob_uin,$day_in_proxy,$day_out,$day_out_proxy,$day_click,$day_click_proxy,$day_click_uniq,$day_nojs,$day_cont,$day_rclicks,$day_lang,$debt)=explode('|',trim($st_dl));

                $stats->hour_in["$dom"]=$hour_in or $stats->hour_in["$dom"]=0;
                $stats->tot_hour_in+=$hour_in;
                $stats->hour_in_trad_uniq["$dom"]=$hour_trad_uin or $stats->hour_in_trad_uniq["$dom"]=0;
                $stats->tot_hour_in_trad_uniq+=$hour_trad_uin;
                $stats->hour_in_glob_uniq["$dom"]=$hour_glob_uin or $stats->hour_in_glob_uniq["$dom"]=0;
                $stats->tot_hour_in_glob_uniq+=$hour_glob_uin;
                $stats->hour_in_proxy["$dom"]=$hour_in_proxy or $stats->hour_in_proxy["$dom"]=0;
                $stats->tot_hour_in_proxy+=$hour_in_proxy;

                $stats->hour_out["$dom"]=$hour_out or $stats->hour_out["$dom"]=0;
                $stats->tot_hour_out+=$hour_out;
                $stats->hour_out_proxy["$dom"]=$hour_out_proxy or $stats->hour_out_proxy["$dom"]=0;
                $stats->tot_hour_out_proxy+=$hour_out_proxy;

                $stats->hour_click["$dom"]=$hour_click or $stats->hour_click["$dom"]=0;
                $stats->tot_hour_click+=$hour_click;
                $stats->hour_click_proxy["$dom"]=$hour_click_proxy or $stats->hour_click_proxy["$dom"]=0;
                $stats->tot_hour_click_proxy+=$hour_click_proxy;
                $stats->hour_click_nojs["$dom"]=$hour_nojs or $stats->hour_click_nojs["$dom"]=0;
                $stats->tot_hour_click_nojs+=$hour_nojs;
                $stats->hour_click_cont["$dom"]=$hour_cont or $stats->hour_click_cont["$dom"]=0;
                $stats->tot_hour_click_cont+=$hour_cont;
                $stats->hour_click_uniq["$dom"]=$hour_click_uniq or $stats->hour_click_uniq["$dom"]=0;
                $stats->tot_hour_click_uniq+=$hour_click_uniq;
                $stats->hour_click_repeats["$dom"]=$hour_rclicks or $stats->hour_click_repeats["$dom"]=0;
                $stats->tot_hour_click_repeats+=$hour_rclicks;

                $stats->hour_lang["$dom"]=$hour_lang or $stats->hour_lang["$dom"]=0;
                $stats->tot_hour_lang+=$hour_lang;

                $stats->day_in["$dom"]=$day_in or $stats->day_in["$dom"]=0;
                $stats->tot_day_in+=$day_in;
                $stats->day_in_trad_uniq["$dom"]=$day_trad_uin or $stats->day_in_trad_uniq["$dom"]=0;
                $stats->tot_day_in_trad_uniq+=$day_trad_uin;
                $stats->day_in_glob_uniq["$dom"]=$day_glob_uin or $stats->day_in_glob_uniq["$dom"]=0;
                $stats->tot_day_in_glob_uniq+=$day_glob_uin;
                $stats->day_in_proxy["$dom"]=$day_in_proxy or $stats->day_in_proxy["$dom"]=0;
                $stats->tot_day_in_proxy+=$day_in_proxy;

                $stats->day_out["$dom"]=$day_out or $stats->day_out["$dom"]=0;
                $stats->tot_day_out+=$day_out;
                $stats->day_out_proxy["$dom"]=$day_out_proxy or $stats->day_out_proxy["$dom"]=0;
                $stats->tot_day_out_proxy+=$day_out_proxy;

                $stats->day_click["$dom"]=$day_click or $stats->day_click["$dom"]=0;
                $stats->tot_day_click+=$day_click;
                $stats->day_click_proxy["$dom"]=$day_click_proxy or $stats->day_click_proxy["$dom"]=0;
                $stats->tot_day_click_proxy+=$day_click_proxy;
                $stats->day_click_nojs["$dom"]=$day_nojs or $stats->day_click_nojs["$dom"]=0;
                $stats->tot_day_click_nojs+=$day_nojs;
                $stats->day_click_cont["$dom"]=$day_cont or $stats->day_click_cont["$dom"]=0;
                $stats->tot_day_click_cont+=$day_cont;
                $stats->day_click_uniq["$dom"]=$day_click_uniq or $stats->day_click_uniq["$dom"]=0;
                $stats->tot_day_click_uniq+=$day_click_uniq;
                $stats->day_click_repeats["$dom"]=$day_rclicks or $stats->day_click_repeats["$dom"]=0;
                $stats->tot_day_click_repeats+=$day_rclicks;

                $stats->day_lang["$dom"]=$day_lang or $stats->day_lang["$dom"]=0;
                $stats->tot_day_lang+=$day_lang;

                if($hour_in>0){
                    $stats->hour_prod["$dom"]=$hour_click/$hour_in;
                    $stats->hour_lf["$dom"]=$hour_lang/100/$hour_in;
                } else {
                    $stats->hour_prod["$dom"]=0;
                    $stats->hour_lf["$dom"]=0;
                }
                if($hour_out>0){
                    $stats->hour_ca["$dom"]=$hour_rclicks/$hour_out;
                    if($stats->hour_ca["$dom"]>1) $stats->hour_ca["$dom"]=1;
                } else $stats->hour_ca["$dom"]=0;
                if($hour_click>0 && $hour_click_uniq>0){
                    $ucpr=$hour_click_uniq/$hour_click;
                    $stats->hour_act["$dom"]=$stats->hour_prod["$dom"]/$ucpr;
                } else $stats->hour_act["$dom"]=0;
                if($hour_out>0) $stats->hour_eff["$dom"]=$hour_click/$hour_out; else $stats->hour_eff["$dom"]=0;

                if($day_in>0){
                    $stats->day_prod["$dom"]=$day_click/$day_in;
                    $stats->day_ret["$dom"]=$day_out/$day_in;
                    $stats->day_lf["$dom"]=$day_lang/100/$day_in;
                }  else {
                    $stats->day_prod["$dom"]=0;
                    $stats->day_ret["$dom"]=0;
                    $stats->day_lf["$dom"]=0;
                }
                if($day_out>0){
                    $stats->day_ca["$dom"]=$day_rclicks/$day_out;
                    if($stats->day_ca["$dom"]>1) $stats->day_ca["$dom"]=1;
                    $stats->day_eff["$dom"]=$day_click/$day_out;
                } else {
                    $stats->day_ca["$dom"]=0;
                    $stats->day_eff["$dom"]=0;
                }
                if($day_click>0 && $day_click_uniq>0){
                    $ucpr=$day_click_uniq/$day_click;
                    $stats->day_act["$dom"]=$stats->day_prod["$dom"]/$ucpr;
                } else $stats->day_act["$dom"]=0;
                $stats->debt["$dom"]=$debt;
                if($hour_trad_uin>0) $stats->hour_uniq_prod["$dom"]=$hour_click_uniq/$hour_trad_uin; else $stats->hour_uniq_prod["$dom"]=0;
                if($day_trad_uin>0) $stats->day_uniq_prod["$dom"]=$day_click_uniq/$day_trad_uin; else $stats->day_uniq_prod["$dom"]=0;
            }

            $stats->trades_tot_hour_in=$stats->tot_hour_in-$stats->hour_in['exout']-$stats->hour_in['content']-$stats->hour_in['noref']-$stats->hour_in['notrade']-$stats->hour_in['nocookie']-$stats->hour_in['filtered'];
            $stats->trades_tot_hour_in_proxy=$stats->tot_hour_in_proxy-$stats->hour_in_proxy['exout']-$stats->hour_in_proxy['content']-$stats->hour_in_proxy['noref']-$stats->hour_in_proxy['notrade']-$stats->hour_in_proxy['nocookie']-$stats->hour_in_proxy['filtered'];
            $stats->trades_tot_hour_in_trad_uniq=$stats->tot_hour_in_trad_uniq-$stats->hour_in_trad_uniq['exout']-$stats->hour_in_trad_uniq['content']-$stats->hour_in_trad_uniq['noref']-$stats->hour_in_trad_uniq['notrade']-$stats->hour_in_trad_uniq['nocookie']-$stats->hour_in_trad_uniq['filtered'];
            $stats->trades_tot_hour_in_glob_uniq=$stats->tot_hour_in_glob_uniq-$stats->hour_in_glob_uniq['exout']-$stats->hour_in_glob_uniq['content']-$stats->hour_in_glob_uniq['noref']-$stats->hour_in_glob_uniq['notrade']-$stats->hour_in_glob_uniq['nocookie']-$stats->hour_in_glob_uniq['filtered'];

            $stats->books_tot_hour_in=$stats->hour_in['noref']+$stats->hour_in['notrade'];
            $stats->books_tot_hour_in_proxy=$stats->hour_in_proxy['noref']+$stats->hour_in_proxy['notrade'];
            $stats->books_tot_hour_in_glob_uniq=$stats->hour_in_glob_uniq['noref']+$stats->hour_in_glob_uniq['notrade'];

            $stats->trades_tot_hour_out=$stats->tot_hour_out-$stats->hour_out['exout']-$stats->hour_out['content']-$stats->hour_out['noref']-$stats->hour_out['notrade']-$stats->hour_out['nocookie']-$stats->hour_out['filtered'];
            $stats->trades_tot_hour_out_proxy=$stats->tot_hour_out_proxy-$stats->hour_out_proxy['exout']-$stats->hour_out_proxy['content']-$stats->hour_out_proxy['noref']-$stats->hour_out_proxy['notrade']-$stats->hour_out_proxy['nocookie']-$stats->hour_out_proxy['filtered'];

            $stats->trades_tot_hour_click=$stats->tot_hour_click-$stats->hour_click['exout']-$stats->hour_click['content']-$stats->hour_click['noref']-$stats->hour_click['notrade']-$stats->hour_click['nocookie']-$stats->hour_click['filtered'];
            $stats->trades_tot_hour_click_proxy=$stats->tot_hour_click_proxy-$stats->hour_click_proxy['exout']-$stats->hour_click_proxy['content']-$stats->hour_click_proxy['noref']-$stats->hour_click_proxy['notrade']-$stats->hour_click_proxy['nocookie']-$stats->hour_click_proxy['filtered'];
            $stats->trades_tot_hour_click_repeats=$stats->tot_hour_click_repeats-$stats->hour_click_repeats['exout']-$stats->hour_click_repeats['content']-$stats->hour_click_repeats['noref']-$stats->hour_click_repeats['notrade']-$stats->hour_click_repeats['nocookie']-$stats->hour_click_repeats['filtered'];
            $stats->trades_tot_hour_click_uniq=$stats->tot_hour_click_uniq-$stats->hour_click_uniq['exout']-$stats->hour_click_uniq['content']-$stats->hour_click_uniq['noref']-$stats->hour_click_uniq['notrade']-$stats->hour_click_uniq['nocookie']-$stats->hour_click_uniq['filtered'];
            $stats->trades_tot_hour_click_cont=$stats->tot_hour_click_cont-$stats->hour_click_cont['exout']-$stats->hour_click_cont['content']-$stats->hour_click_cont['noref']-$stats->hour_click_cont['notrade']-$stats->hour_click_cont['nocookie']-$stats->hour_click_cont['filtered'];
            $stats->trades_tot_hour_click_nojs=$stats->tot_hour_click_nojs-$stats->hour_click_nojs['exout']-$stats->hour_click_nojs['content']-$stats->hour_click_nojs['noref']-$stats->hour_click_nojs['notrade']-$stats->hour_click_nojs['nocookie']-$stats->hour_click_nojs['filtered'];

            $stats->books_tot_hour_click=$stats->hour_click['noref']+$stats->hour_click['notrade'];
            $stats->books_tot_hour_click_proxy=$stats->hour_click_proxy['noref']+$stats->hour_click_proxy['notrade'];
            $stats->books_tot_hour_click_repeats=$stats->hour_click_repeats['noref']+$stats->hour_click_repeats['notrade'];
            $stats->books_tot_hour_click_uniq=$stats->hour_click_uniq['noref']+$stats->hour_click_uniq['notrade'];
            $stats->books_tot_hour_click_cont=$stats->hour_click_cont['noref']+$stats->hour_click_cont['notrade'];
            $stats->books_tot_hour_click_nojs=$stats->hour_click_nojs['noref']+$stats->hour_click_nojs['notrade'];

            $stats->trades_tot_day_in=$stats->tot_day_in-$stats->day_in['exout']-$stats->day_in['content']-$stats->day_in['noref']-$stats->day_in['notrade']-$stats->day_in['nocookie']-$stats->day_in['filtered'];
            $stats->trades_tot_day_in_proxy=$stats->tot_day_in_proxy-$stats->day_in_proxy['exout']-$stats->day_in_proxy['content']-$stats->day_in_proxy['noref']-$stats->day_in_proxy['notrade']-$stats->day_in_proxy['nocookie']-$stats->day_in_proxy['filtered'];
            $stats->trades_tot_day_in_trad_uniq=$stats->tot_day_in_trad_uniq-$stats->day_in_trad_uniq['exout']-$stats->day_in_trad_uniq['content']-$stats->day_in_trad_uniq['noref']-$stats->day_in_trad_uniq['notrade']-$stats->day_in_trad_uniq['nocookie']-$stats->day_in_trad_uniq['filtered'];
            $stats->trades_tot_day_in_glob_uniq=$stats->tot_day_in_glob_uniq-$stats->day_in_glob_uniq['exout']-$stats->day_in_glob_uniq['content']-$stats->day_in_glob_uniq['noref']-$stats->day_in_glob_uniq['notrade']-$stats->day_in_glob_uniq['nocookie']-$stats->day_in_glob_uniq['filtered'];

            $stats->books_tot_day_in=$stats->day_in['noref']+$stats->day_in['notrade'];
            $stats->books_tot_day_in_proxy=$stats->day_in_proxy['noref']+$stats->day_in_proxy['notrade'];
            $stats->books_tot_day_in_glob_uniq=$stats->day_in_glob_uniq['noref']+$stats->day_in_glob_uniq['notrade'];

            $stats->trades_tot_day_out=$stats->tot_day_out-$stats->day_out['exout']-$stats->day_out['content']-$stats->day_out['noref']-$stats->day_out['notrade']-$stats->day_out['nocookie']-$stats->day_out['filtered'];
            $stats->trades_tot_day_out_proxy=$stats->tot_day_out_proxy-$stats->day_out_proxy['exout']-$stats->day_out_proxy['content']-$stats->day_out_proxy['noref']-$stats->day_out_proxy['notrade']-$stats->day_out_proxy['nocookie']-$stats->day_out_proxy['filtered'];

            $stats->trades_tot_day_click=$stats->tot_day_click-$stats->day_click['exout']-$stats->day_click['content']-$stats->day_click['noref']-$stats->day_click['notrade']-$stats->day_click['nocookie']-$stats->day_click['filtered'];
            $stats->trades_tot_day_click_proxy=$stats->tot_day_click_proxy-$stats->day_click_proxy['exout']-$stats->day_click_proxy['content']-$stats->day_click_proxy['noref']-$stats->day_click_proxy['notrade']-$stats->day_click_proxy['nocookie']-$stats->day_click_proxy['filtered'];
            $stats->trades_tot_day_click_repeats=$stats->tot_day_click_repeats-$stats->day_click_repeats['exout']-$stats->day_click_repeats['content']-$stats->day_click_repeats['noref']-$stats->day_click_repeats['notrade']-$stats->day_click_repeats['nocookie']-$stats->day_click_repeats['filtered'];
            $stats->trades_tot_day_click_uniq=$stats->tot_day_click_uniq-$stats->day_click_uniq['exout']-$stats->day_click_uniq['content']-$stats->day_click_uniq['noref']-$stats->day_click_uniq['notrade']-$stats->day_click_uniq['nocookie']-$stats->day_click_uniq['filtered'];
            $stats->trades_tot_day_click_cont=$stats->tot_day_click_cont-$stats->day_click_cont['exout']-$stats->day_click_cont['content']-$stats->day_click_cont['noref']-$stats->day_click_cont['notrade']-$stats->day_click_cont['nocookie']-$stats->day_click_cont['filtered'];
            $stats->trades_tot_day_click_nojs=$stats->tot_day_click_nojs-$stats->day_click_nojs['exout']-$stats->day_click_nojs['content']-$stats->day_click_nojs['noref']-$stats->day_click_nojs['notrade']-$stats->day_click_nojs['nocookie']-$stats->day_click_nojs['filtered'];

            $stats->books_tot_day_click=$stats->day_click['noref']+$stats->day_click['notrade'];
            $stats->books_tot_day_click_proxy=$stats->day_click_proxy['noref']+$stats->day_click_proxy['notrade'];
            $stats->books_tot_day_click_repeats=$stats->day_click_repeats['noref']+$stats->day_click_repeats['notrade'];
            $stats->books_tot_day_click_uniq=$stats->day_click_uniq['noref']+$stats->day_click_uniq['notrade'];
            $stats->books_tot_day_click_cont=$stats->day_click_cont['noref']+$stats->day_click_cont['notrade'];
            $stats->books_tot_day_click_nojs=$stats->day_click_nojs['noref']+$stats->day_click_nojs['notrade'];
        } else {
            @chmod($settings->data_path.'/short_stats.dat', 0777);
            $log->error('Main stats file not found or not readable');
        }
    }

    function add_rule(){
        global $admin;

        $new_rule=str_replace("\n",'',$_POST['new_rule']);
        if(!$new_rule) $this->settings();
        $admin->read_rules();
        $admin->trade_rules[]=$new_rule;
        $admin->save_rules();
        $this->settings(true,0,false);
    }

    function delete_rule(){
        global $admin;

        $to_del=$_POST['checkedrule'];
        if(!is_array($to_del)) $this->settings();
        $admin->read_rules();
        foreach($to_del as $did) unset($admin->trade_rules[$did]);
        $admin->save_rules();
        $this->settings(true,0,false);
    }

    function settings($ra=true,$psn=0,$rr=true){
        global $admin,$html,$intf,$global;

        if($psn<=4 && $psn>0){
            $msg="<table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
                <tr><td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            if($psn==1) $msg.='<font size=1 color='.$intf->color["PSW_FAIL"].'><b>Error: New passwords does not match</b></font>';
            if($psn==2) $msg.='<font size=1 color='.$intf->color["PSW_FAIL"].'><b>Error: Old password does not match</b></font>';
            if($psn==3) $msg.='<font size=1 color='.$intf->color["PSW_FAIL"].'><b>System error: can not save password</b></font>';
            if($psn==4) $msg.='<font size=1 color='.$intf->color["PSW_GOOD"].'><b>Password successfully changed</b></font>';
            $msg.="</tr>
                </table>
                <br>";
        } else $msg='';

        $html->sub_page_header('System settings');
        $html->main_table_header('System settings');
        $html->script_sdmnt();
        $html->script_sdrto();
        if($ra) $admin->read_autosignup();
        if($rr) $admin->read_rules();
        echo "
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Trade Rules for Webmasters</b></font></tr>";
        if(is_array($admin->trade_rules)){
            $ind=0;
            foreach($admin->trade_rules as $rtxt){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=20><input type=checkbox name='checkedrule[]' value='".$ind."'></td><td bgcolor='".$intf->color['NORM_CELL']."' width=580><font size=1>".$rtxt."</font></td></tr>";
                $ind++;
            }
        }
        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=2><font size=1>New Rule: &nbsp</font>";
        $html->input(11,'normal','text','new_rule',45,165,'');
        echo " &nbsp ";
        $html->button('submit','Add Rule','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=2>";
        $html->button('submit','Delete Rule','light');
        echo "</td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>New Trades Auto Signup Settings</b></font></tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Trade Type</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><select name=as_tradetype><option value=0";
        if($admin->as_tradetype==0) echo ' selected';
        echo ">Stopped<option value=1";
        if($admin->as_tradetype==1) echo ' selected';
        echo ">Normal<option value=2";
        if($admin->as_tradetype==2) echo ' selected';
        echo ">Normal+<option value=3";
        if($admin->as_tradetype==3) echo ' selected';
        echo ">Ratio<option value=4";
        if($admin->as_tradetype==4) echo ' selected';
        echo ">Capped<option value=5";
        if($admin->as_tradetype==5) echo ' selected';
        echo ">Boost<option value=6";
        if($admin->as_tradetype==6) echo ' selected';
        echo ">Quality<option value=7";
        if($admin->as_tradetype>=7) echo ' selected';
        echo ">Quality+</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Minimum Hourly Trade</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><script>sdmnt(".$admin->as_mintrade.")</script></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Set Ratio</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><script>sdrto(".$admin->as_ratio.")</script></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Main Page</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=as_mainpage>";
        foreach($global->main_page as $pid=>$pnm){
            if($pid==$admin->as_mainpage) $s=' selected'; else $s='';
            echo "<option value=".$pid.$s.">".$pnm;
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show in Toplist</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=as_toplist><option value=1";
        if($admin->as_toplist>0) echo ' selected';
        echo ">Yes<option value=0";
        if($admin->as_toplist<1) echo ' selected';
        echo ">No</select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Clicks Order</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        $html->input(11,'normal','text','as_clicksorder',20,30,$admin->as_clicksorder);
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Content Skim</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=as_contentskim>";
        for($i=0;$i<=100;$i++){
            if($i==$admin->as_contentskim) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i."%";
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=middle><font size=1>Accept Proxy Traffic</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=checkbox name=as_accepttrpr value=1";
        if($admin->as_accept_trpr>0) echo ' checked';
        echo "> &nbsp;Transparent<br><input type=checkbox name=as_acceptdspr value=1";
        if($admin->as_accept_dspr>0) echo ' checked';
        echo "> &nbsp;Distorting<br><input type=checkbox name=as_acceptanpr value=1";
        if($admin->as_accept_anpr>0) echo ' checked';
        echo "> &nbsp;Anonimous</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept NoRef Hits</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=as_acceptnrh><option value=1";
        if($admin->as_accept_nrh>0) echo ' selected';
        echo ">Yes<option value=0";
        if($admin->as_accept_nrh<1) echo ' selected';
        echo ">No</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept NoRef Clicks</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=as_acceptnrc><option value=1";
        if($admin->as_accept_nrc>0) echo ' selected';
        echo ">Yes<option value=0";
        if($admin->as_accept_nrc<1) echo ' selected';
        echo ">No</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>No JSCookie click counts as</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=as_nojs><option value=1";
        if($admin->as_nojs>0) echo ' selected';
        echo ">Normal Click<option value=0";
        if($admin->as_nojs<1) echo ' selected';
        echo ">NoCookie Click</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=as_proxyprc>";
        for($i=0;$i<=100;$i++){
            if($i==$admin->as_proxy_prc) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i."%";
        }
        echo "</select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>NoCookie traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=as_nocookprc>";
        for($i=0;$i<=100;$i++){
            if($i==$admin->as_nocook_prc) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i."%";
        }
        echo "</select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>NoRef traffic % to send</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=as_norefprc>";
        for($i=0;$i<=100;$i++){
            if($i==$admin->as_noref_prc) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i."%";
        }
        echo "</select></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Accept second level domains only</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=as_domlevel value=1";
        if($admin->as_domlevel>0) echo ' checked';
        echo "> Yes &nbsp; &nbsp; <input type=radio name=as_domlevel value=0";
        if($admin->as_domlevel<1) echo ' checked';
        echo "> No</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Allow Auto Signup</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=as_opened value=1";
        if($admin->as_opened>0) echo ' checked';
        echo "> Yes &nbsp; &nbsp; <input type=radio name=as_opened value=0";
        if($admin->as_opened<1) echo ' checked';
        echo "> No</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Maximum Not Reviewed Signups</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=as_maxsigns>";
        for($i=1;$i<=50;$i++){
            if($i==$admin->as_maxsigns) $s=' selected'; else $s='';
            echo "<option value=".$i.$s.">".$i;
        }
        echo "</select></td>
            </tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."' colspan=2></td>
            </tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Site's Information</b></font></tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."' width=250><font size=1>Trade URL</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=350>";
        $html->input(11,'normal','text','trade_url',40,165,$admin->site_url);
        echo "</td>
            </tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Contact ICQ UIN</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        $html->input(11,'normal','text','my_new_icq',15,30,$admin->my_icq);
        echo "</td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Contact E-Mail</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        $html->input(11,'normal','text','my_new_email',40,30,$admin->my_email);
        echo "</td>
            </tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."' colspan=2></td>
            </tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Interface settings</b></font></tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."' width=350><font size=1>Colour scheme</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=250><select name=col_scheme>";
        arsort($intf->avail_colors);
        foreach($intf->avail_colors as $avcol){
            if($avcol==$admin->color) $s=' selected'; else $s='';
            echo "<option value='".$avcol."'".$s.">".$avcol;
        }
        echo "</select></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show Webmaster info</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=showwm value=1";
        if($admin->show_wm>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=showwm value=0";
        if($admin->show_wm<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show ICQ image</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=showicq value=1";
        if($admin->show_icq>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=showicq value=0";
        if($admin->show_icq<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show Site Name</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=showsname value=1";
        if($admin->show_sname>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=showsname value=0";
        if($admin->show_sname<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show Trade Start Date</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=showdate value=1";
        if($admin->show_date>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=showdate value=0";
        if($admin->show_date<1) echo ' checked';
        echo "> No</td>
            </tr>";
            /*
        echo "<tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show Traffic Analyzer Column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=showanalyzer value=1";
        if($admin->show_analyzer>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=showanalyzer value=0";
        if($admin->show_analyzer<1) echo ' checked';
        echo "> No</td>
            </tr>";
            */
        echo "<tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show Trades Checker Mark</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=showchecker value=1";
        if($admin->show_checker>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=showchecker value=0";
        if($admin->show_checker<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>&quot;Totals&quot; block position</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name=totals_position><option value=0";
        if($admin->totals_pos<1) echo ' selected';
        echo ">Only Top<option value=1";
        if($admin->totals_pos==1) echo ' selected';
        echo ">Only Bottom<option value=2";
        if($admin->totals_pos>1) echo ' selected';
        echo ">Top and Bottom</select></td>
            </tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."' colspan=2></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Hour Uniq Hits from Trader&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_htruin value=1";
        if($admin->show_h_truin>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_htruin value=0";
        if($admin->show_h_truin<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Hour Global Uniq Hits&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_hgluin value=1";
        if($admin->show_h_gluin>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_hgluin value=0";
        if($admin->show_h_gluin<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Hour Productivity&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_hprod value=1";
        if($admin->show_h_prod>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_hprod value=0";
        if($admin->show_h_prod<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Hour No JSCookie clicks&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_hnojs value=1";
        if($admin->show_h_nojs>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_hnojs value=0";
        if($admin->show_h_nojs<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Hour Content clicks&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_hcont value=1";
        if($admin->show_h_cont>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_hcont value=0";
        if($admin->show_h_cont<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Hour Click Again&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_hca value=1";
        if($admin->show_h_ca>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_hca value=0";
        if($admin->show_h_ca<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Hour Activity&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_hact value=1";
        if($admin->show_h_act>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_hact value=0";
        if($admin->show_h_act<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Hour Uniq Prod&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_huprod value=1";
        if($admin->show_h_uniq_prod>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_huprod value=0";
        if($admin->show_h_uniq_prod<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Hour Language factor&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_hlang value=1";
        if($admin->show_h_lang>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_hlang value=0";
        if($admin->show_h_lang<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."' colspan=2></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Day Uniq Hits from Trader&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_dtruin value=1";
        if($admin->show_d_truin>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_dtruin value=0";
        if($admin->show_d_truin<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Day Global Uniq Hits&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_dgluin value=1";
        if($admin->show_d_gluin>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_dgluin value=0";
        if($admin->show_d_gluin<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Day Productivity&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_dprod value=1";
        if($admin->show_d_prod>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_dprod value=0";
        if($admin->show_d_prod<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Day No JSCookie clicks&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_dnojs value=1";
        if($admin->show_d_nojs>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_dnojs value=0";
        if($admin->show_d_nojs<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Day Content clicks&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_dcont value=1";
        if($admin->show_d_cont>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_dcont value=0";
        if($admin->show_d_cont<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Day Click Again&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_dca value=1";
        if($admin->show_d_ca>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_dca value=0";
        if($admin->show_d_ca<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Day Activity&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_dact value=1";
        if($admin->show_d_act>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_dact value=0";
        if($admin->show_d_act<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Day Uniq Prod&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_duprod value=1";
        if($admin->show_d_uniq_prod>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_duprod value=0";
        if($admin->show_d_uniq_prod<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Show &quot;Day Language factor&quot; column</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><input type=radio name=show_dlang value=1";
        if($admin->show_d_lang>0) echo ' checked';
        echo "> Yes &nbsp <input type=radio name=show_dlang value=0";
        if($admin->show_d_lang<1) echo ' checked';
        echo "> No</td>
            </tr>
            <tr><td bgcolor='".$intf->color['MAIN_BGCOLOR']."' colspan=2 align=center>";
        $html->button('submit','Save Settings','light');
        echo "</td>
            </tr>
            </table>
            <br>".$msg."
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center><font size=1><b>Password Change</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>Old password: ";
        $html->input(11,'normal','password','old_password',15,30,'');
        echo ", &nbsp; New Password: ";
        $html->input(11,'normal','password','new_password_1',15,30,'');
        echo ", &nbsp; Repeat: ";
        $html->input(11,'normal','password','new_password_2',15,30,'');
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
        $html->button('submit','Save New Password','light');
        echo "</td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
             <tr>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center><font size=1><b>Full Stats Reset</b></font></td></tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
        $html->button('submit','Full Reset','light');
        echo "</td></tr></table>
            <br>
            ";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function full_reset(){
        global $settings,$log;

        if(!$fp=@fopen($settings->data_path.'/all_reset.dat','w')){
            $log->error('Can not Write FULL RESET mark file');
            $this->settings();
        }
        @fclose($fp);
        $this->settings();
    }

    function save_settings(){
        global $admin;

        $admin->as_tradetype=$_POST['as_tradetype'];
        $admin->as_mintrade=$_POST['new_mintrade'];
        $admin->as_ratio=$_POST['new_ratio'];
        $admin->as_mainpage=$_POST['as_mainpage'];
        $admin->as_toplist=$_POST['as_toplist'];
        $admin->as_clicksorder=str_replace('|','',$_POST['as_clicksorder']);
        $admin->as_contentskim=$_POST['as_contentskim'];
        $admin->as_accept_trpr=$_POST['as_accepttrpr'];
        $admin->as_accept_dspr=$_POST['as_acceptdspr'];
        $admin->as_accept_anpr=$_POST['as_acceptanpr'];
        $admin->as_accept_nrh=$_POST['as_acceptnrh'];
        $admin->as_accept_nrc=$_POST['as_acceptnrc'];
        $admin->as_nojs=$_POST['as_nojs'];
        $admin->as_proxy_prc=$_POST['as_proxyprc'];
        $admin->as_nocook_prc=$_POST['as_nocookprc'];
        $admin->as_noref_prc=$_POST['as_norefprc'];
        $admin->as_domlevel=$_POST['as_domlevel'];
        $admin->as_opened=$_POST['as_opened'];
        $admin->as_maxsigns=$_POST['as_maxsigns'];

        $admin->save_autosignup();

        $admin->color=$_POST['col_scheme'];
        $admin->site_url=str_replace('|','',$_POST['trade_url']);
        $admin->show_h_truin=$_POST['show_htruin'];
        $admin->show_h_gluin=$_POST['show_hgluin'];
        $admin->show_h_prod=$_POST['show_hprod'];
        $admin->show_h_nojs=$_POST['show_hnojs'];
        $admin->show_h_cont=$_POST['show_hcont'];
        $admin->show_h_ca=$_POST['show_hca'];
        $admin->show_h_act=$_POST['show_hact'];
        $admin->show_h_uniq_prod=$_POST['show_huprod'];
        $admin->show_h_lang=$_POST['show_hlang'];
        $admin->show_d_truin=$_POST['show_dtruin'];
        $admin->show_d_gluin=$_POST['show_dgluin'];
        $admin->show_d_prod=$_POST['show_dprod'];
        $admin->show_d_nojs=$_POST['show_dnojs'];
        $admin->show_d_cont=$_POST['show_dcont'];
        $admin->show_d_ca=$_POST['show_dca'];
        $admin->show_d_act=$_POST['show_dact'];
        $admin->show_d_uniq_prod=$_POST['show_duprod'];
        $admin->show_d_lang=$_POST['show_dlang'];
        $admin->show_icq=$_POST['showicq'];
        $admin->show_wm=$_POST['showwm'];
        $admin->show_sname=$_POST['showsname'];
        $admin->show_date=$_POST['showdate'];
        //$admin->show_analyzer=$_POST['showanalyzer'];
        $admin->show_analyzer=0;
        $admin->show_checker=$_POST['showchecker'];
        $admin->totals_pos=$_POST['totals_position'];
        $admin->my_icq=str_replace('|','',$_POST['my_new_icq']);
        $admin->my_email=str_replace('|','',$_POST['my_new_email']);

        $admin->save_settings();
        $this->settings(false);
    }

    function show_system_logs(){
        global $settings,$html,$intf;

        $show_th=$_GET['th'];

        $html->sub_page_header('System Logs');
        $html->main_table_header('System Logs');

        $tmf=@file($settings->data_path.'/day_timing.dat');
        $hit_timing=array();
        $out_timing=array();
        if(is_array($tmf)){
            foreach($tmf as $tml){
                $tmle=explode('|',trim($tml));
                if($tmle[0]=='hit'){
                    for($i=0;$i<1440;$i++) $hit_timing[$i]=$tmle[$i+1];
                } elseif($tmle[0]=='out'){
                    for($i=0;$i<1440;$i++) $out_timing[$i]=$tmle[$i+1];
                }
            }
        }
        echo "<br>
            <table width=633 border=0 cellpadding=2 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=12><font size=1><b>Script Timing, msec. Average per hour.</b></font></td></tr>
            <tr align=center>
            ";
        for($i=0;$i<12;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."' width=8%><font size=1>".$i."h</font></td>";
        echo "</tr>
            <tr align=center>";
        for($i=0;$i<12;$i++){
            $hb=$i*60;
            $he=$hb+60;
            $hav=0;
            $oav=0;
            for($j=$hb;$j<$he;$j++){
                $hav+=$hit_timing[$j];
                $oav+=$out_timing[$j];
            }
            $hav=round($hav/60,2);
            $oav=round($oav/60,2);
            echo "<td bgcolor='".$intf->color['NORM_CELL']."'><nobr>in: <a href='?cmd=logs&th=".$i."'>".$hav."</a></nobr><br><nobr>out: <a href='?cmd=logs&th=".$i."'>".$oav."</a></nobr></td>";
        }
        echo "</tr>
            <tr align=center>";
        for($i=12;$i<24;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$i."h</font></td>";
        echo "
            </tr>
            <tr align=center>";
        for($i=12;$i<24;$i++){
            $hb=$i*60;
            $he=$hb+60;
            $hav=0;
            $oav=0;
            for($j=$hb;$j<$he;$j++){
                $hav+=$hit_timing[$j];
                $oav+=$out_timing[$j];
            }
            $hav=round($hav/60,2);
            $oav=round($oav/60,2);
            echo "<td bgcolor='".$intf->color['NORM_CELL']."'><nobr>in: <a href='?cmd=logs&th=".$i."'>".$hav."</a></nobr><br><nobr>out: <a href='?cmd=logs&th=".$i."'>".$oav."</a></nobr></td>";
        }
        echo "</tr>
            </table>
            <br>";
        if($show_th!='' && $show_th>=0 && $how_th<24){
            echo "<table width=633 border=0 cellpadding=2 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=12><font size=1><b>Script Timing, msec. ".$show_th."h detailed.</b></font></td></tr>";
            for($z=0;$z<5;$z++){
                $s=$z*12;
                $e=$s+12;
                echo "<tr align=center>";
                for($i=$s;$i<$e;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$i."m</font></td>";
                echo "</tr><tr align=center>";
                $bm=$show_th*60+$s;
                $em=$bm+12;
                for($i=$bm;$i<$em;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."'><nobr>in: <a href='#'>".$hit_timing[$i]."</a></nobr><br><nobr>out: <a href='#'>".$out_timing[$i]."</a></nobr></td>";
                echo "</tr>";
            }
            /*
            echo "<tr align=center>";
            for($i=0;$i<12;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$i."m</font></td>";
            echo "</tr><tr align=center>";
            $bm=$show_th*60;
            $em=$bm+12;
            for($i=$bm;$i<$em;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."'><nobr>in: ".$hit_timing[$i]."</nobr><br><nobr>out: >".$out_timing[$i]."</nobr></td>";
            echo "</tr><tr>align=center>";
            for($i=12;$i<24;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$i."m</font></td>";
            echo "</tr><tr align=center>";
            $bm=$show_th*60+12;
            $em=$bm+12;
            for($i=$bm;$i<$em;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."'><nobr>in: ".$hit_timing[$i]."</nobr><br><nobr>out: >".$out_timing[$i]."</nobr></td>";
            echo "</tr><tr>align=center>";
            for($i=24;$i<48;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$i."m</font></td>";
            echo "</tr><tr align=center>";
            $bm=$show_th*60+24;
            $em=$bm+12;
            for($i=$bm;$i<$em;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."'><nobr>in: ".$hit_timing[$i]."</nobr><br><nobr>out: >".$out_timing[$i]."</nobr></td>";
            echo "</tr><tr>align=center>";
            for($i=48;$i<60;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$i."m</font></td>";
            echo "</tr><tr align=center>";
            $bm=$show_th*60+48;
            $em=$bm+12;
            for($i=$bm;$i<$em;$i++) echo "<td bgcolor='".$intf->color['NORM_CELL']."'><nobr>in: ".$hit_timing[$i]."</nobr><br><nobr>out: >".$out_timing[$i]."</nobr></td>";
            echo "</tr><tr>align=center>";
            */
            echo "</table><br>";
        }
        echo "
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center><font size=1><b>Error Log</b></font></tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."'><textarea rows=15 cols=120 readonly>";
        $lf=@file($settings->log_path.'/error.log');
        if($lf) foreach($lf as $lfl) if(strlen($lfl)>2) echo $lfl;
        echo "</textarea></td>
            </tr></table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center><font size=1><b>Access Log</b></font></tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."'><textarea rows=15 cols=120 readonly>";
        $lf=@file($settings->log_path.'/access.log');
        if($lf) foreach($lf as $lfl) if(strlen($lfl)>2) echo $lfl;
        echo "</textarea></td>
            </tr></table><br>";


        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function read_hourly_stats(){
        global $hour_stats,$settings;

        $hdat=@file($settings->data_path.'/day_in.dat');
        if($hdat){
            foreach($hdat as $hdl){
                $dhe=explode('|',trim($hdl));
                $dom=$dhe[0];
                for($i=0;$i<24;$i++){
                    $hour_stats->hour_in["$dom"][$i]+=$dhe[$i*5+1];
                    $hour_stats->day_in["$dom"]+=$dhe[$i*5+1];
                    $hour_stats->hour_proxy_in["$dom"][$i]+=$dhe[$i*5+4];
                    $hour_stats->day_proxy_in["$dom"]+=$dhe[$i*5+4];
                    $hour_stats->tot_hour_in[$i]+=$dhe[$i*5+1];
                    $hour_stats->tot_hour_proxy_in[$i]+=$dhe[$i*5+4];
                    $hour_stats->tot_in+=$dhe[$i*5+1];
                    $hour_stats->tot_proxy_in+=$dhe[$i*5+4];
                }
            }
        }
        $hdat=@file($settings->data_path.'/day_out.dat');
        if($hdat){
            foreach($hdat as $hdl){
                $dhe=explode('|',trim($hdl));
                $dom=$dhe[0];
                for($i=0;$i<24;$i++){
                    $hour_stats->hour_out["$dom"][$i]+=$dhe[$i*2+1];
                    $hour_stats->day_out["$dom"]+=$dhe[$i*2+1];
                    $hour_stats->hour_proxy_out["$dom"][$i]+=$dhe[$i*2+2];
                    $hour_stats->day_proxy_out["$dom"]+=$dhe[$i*2+2];
                    $hour_stats->tot_hour_out[$i]+=$dhe[$i*2+1];
                    $hour_stats->tot_hour_proxy_out[$i]+=$dhe[$i*2+2];
                    $hour_stats->tot_out+=$dhe[$i*2+1];
                    $hour_stats->tot_proxy_out+=$dhe[$i*2+2];
                }
            }
        }
        $hdat=@file($settings->data_path.'/day_clicks.dat');
        if($hdat){
            foreach($hdat as $hdl){
                $dhe=explode('|',trim($hdl));
                $dom=$dhe[0];
                for($i=0;$i<24;$i++){
                    $hour_stats->hour_clicks["$dom"][$i]+=$dhe[$i*6+1];
                    $hour_stats->day_clicks["$dom"]+=$dhe[$i*6+1];
                    $hour_stats->hour_proxy_clicks["$dom"][$i]+=$dhe[$i*6+2];
                    $hour_stats->day_proxy_clicks["$dom"]+=$dhe[$i*6+2];
                    $hour_stats->tot_hour_clicks[$i]+=$dhe[$i*6+1];
                    $hour_stats->tot_hour_proxy_clicks[$i]+=$dhe[$i*6+2];
                    $hour_stats->tot_clicks+=$dhe[$i*6+1];
                    $hour_stats->tot_proxy_clicks+=$dhe[$i*6+2];
                }
            }
        }

    }

    function link_tracking(){
        global $settings,$html,$hour_stats,$intf;

        $html->sub_page_header('Links clicks');
        $html->main_table_header('Links clicks');
        $this->read_hourly_stats();

        $cur_hour=date('G');

        $ls=@file($settings->data_path.'/links_activity.dat');
        if($ls){
            foreach($ls as $lsl){
                $lsdat=explode('|',trim($lsl));
                $lnm=$lsdat[0];
                for($i=1;$i<=24;$i++){
                    $link_clicks["$lnm"][$i-1]=$lsdat[$i];
                    $tot_hour[$i-1]+=$lsdat[$i];
                    $tot_day+=$lsdat[$i];
                }
            }
        }

        echo "<br>
            <table width=800 border=0 cellpadding=1 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=26><font size=1><b>Links Clicks</b></font></tr>
            <tr><td width=40 bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt rowspan=2><font size=1><nobr>Link Name</nobr></font></td>
            <td width=40 bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt rowspan=2><font size=1><nobr>Total Clicks</nobr></font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt colspan=24>Clicks per Hour</td></tr>
            <tr align=center>";
        for($i=0;$i<24;$i++) echo "<td bgcolor='".$intf->color['STB_HEADER']."' class=nt>".$i."</td>";
            echo "</tr>";

        if(is_array($link_clicks)){
            foreach($link_clicks as $lname=>$hdat){
                $tot_clicks=array_sum($hdat);
                echo "<tr align=center><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$lname."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$tot_clicks."</font></td>";
                for($i=0;$i<24;$i++){
                    $hc=$hdat[$i] or $hc=0;
                    if($i!=$cur_hour) echo "<td bgcolor='".$intf->color['NORM_CELL']."'>".$hc."</td>"; else echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."'>".$hc."</td>";
                }
                echo "</tr>";
            }
        }

        echo "<tr align=center><td bgcolor='".$intf->color['NORM_CELL']."'><b>Totals</b></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>".$tot_day."</td>";
        for($i=0;$i<24;$i++) if($i!=$cur_hour) echo "<td bgcolor='".$intf->color['NORM_CELL']."'>".$tot_hour[$i]."</td>"; else echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."'>".$tot_hour[$i]."</td>";
        echo "</tr></table>
            <br>
            <table width=800 border=0 cellpadding=1 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=26><font size=1><b>Links Productivity</b></font></tr>
            <tr align=center>
            <td width=40 bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt rowspan=2><font size=1><nobr>Link Name</nobr></font></td>
            <td width=40 bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt rowspan=2><font size=1><nobr>Total Prod</nobr></font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' class=nt colspan=24>Productivity per Hour, %</td>
            </tr><tr align=center>";
        for($i=0;$i<24;$i++) echo "<td bgcolor='".$intf->color['STB_HEADER']."' class=nt>".$i."</td>";
            echo "</tr>";

        if(is_array($link_clicks)){
            foreach($link_clicks as $lname=>$hdat){
                $lt_clicks=array_sum($hdat);
                if($hour_stats->tot_in>0) $lt_prod=round($lt_clicks*100/$hour_stats->tot_in,1); else $lt_prod=0;
                echo "<tr align=center><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$lname."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$lt_prod."</font></td>";
                for($i=0;$i<24;$i++){
                    $hc=$hdat[$i] or $hc=0;
                    if($hour_stats->tot_hour_in[$i]>0) $lt_prod=round($hc*100/$hour_stats->tot_hour_in[$i],1); else $lt_prod=0;
                    if($i!=$cur_hour) echo "<td bgcolor='".$intf->color['NORM_CELL']."'>".$lt_prod."</td>"; else echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."'>".$lt_prod."</td>";
                }
                echo "</tr>";
            }
        }

        if($hour_stats->tot_in>0) $tot_prod=round($tot_day*100/$hour_stats->tot_in); else $tot_prod=0;
        echo "<tr align=center><td bgcolor='".$intf->color['NORM_CELL']."'><b>Totals</b></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'>".$tot_prod."</td>";

        for($i=0;$i<24;$i++){
            if($hour_stats->tot_hour_in[$i]>0) $h_prod=round($tot_hour[$i]*100/$hour_stats->tot_hour_in[$i],1); else $h_prod=0;
            if($i!=$cur_hour) echo "<td bgcolor='".$intf->color['NORM_CELL']."'>".$h_prod."</td>"; else echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."'>".$h_prod."</td>";
        }
        echo "</tr></table><br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function show_referers(){
        global $settings,$intf,$html;

        $html->sub_page_header('Referrers');
        $html->main_table_header('Referrers stats');

         echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=4><font size=1><b>Referrers Hits</b></font></tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2 class=nt width=50%>Sorted by Hits</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2 class=nt width=50%>Sorted by Domain</td>
            </tr>";

         $rf=@file($settings->data_path.'/referrers.dat');
         if($rf){
             foreach($rf as $rl){
                 list($rdom,$rhit)=explode('|',trim($rl));
                 $r_hits["$rdom"]=$rhit;
             }
             arsort($r_hits);
             $hits_sorted=array_keys($r_hits);
             ksort($r_hits);
             $dom_sorted=array_keys($r_hits);
             $d_num=count($r_hits);
             for($i=0;$i<$d_num;$i++){
                 $ld=$hits_sorted[$i];
                 $rd=$dom_sorted[$i];
                 $lh=$r_hits["$ld"];
                 $rh=$r_hits["$rd"];
                 echo "<tr align=center>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$ld."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$lh."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rd."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rh."</font></td>
                    </tr>";
             }
         }
         echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' colspan=4 align=center>";
         $html->button('submit','Refresh Referrers','light');
         echo "</td></tr>
            </table><br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function update_referrers(){
        global $settings;

        if($dh=opendir($settings->log_path.'/in_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'in_')) continue;
                $fl=@file($settings->log_path.'/in_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($rdom,$ref,)=explode('|',trim($fll));
                    $dom=strtolower(get_domain($ref));
                    $total_hits["$dom"]++;
                }
            }
            closedir($dh);
        }
        $fp=@fopen($settings->data_path.'/referrers.dat.new','w');
        @flock($fp,LOCK_EX);
        if(is_array($total_hits)){
            arsort($total_hits);
            foreach($total_hits as $dom=>$hit){
                if(!$dom || $hit<1 || $dom=='noref') continue;
                $dom=str_replace('|','',$dom);
                @fwrite($fp,$dom.'|'.$hit."\n");
            }
        }
        @flock($fp,LOCK_UN);
        @fclose($fp);
        @chmod($settings->data_path.'/referrers.dat.new',0777);
        @rename($settings->data_path.'/referrers.dat.new',$settings->data_path.'/referrers.dat');

        $this->show_referers();
    }

    function exout_detailed(){
        global $intf,$html,$settings;

        if($dh=opendir($settings->log_path.'/out_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'out_')) continue;
                $fl=@file($settings->log_path.'/out_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($go_dom,$link,$cook_dom,$u_ip,$u_xff,$u_ref,$prox_t,$cl_time,$bon_d,$cl_u,$u_lang,$no_js,$njs_fl,$lr_fl,$mc_fl,$bl_fl,$nr_fl,$pr_fl,$mt_fl,$nc_fl,$mt_ac,$nr_ac,$pr_ac,$bot_fl)=explode('|',trim($fll));
                    if($go_dom!='exout') continue;
                    $outs++;
                    if($prox_t>0) $prox_outs[$prox_t]++;
                    if(!$out_used["$u_ip"]){
                        $uniq_ip_outs++;
                        $out_used["$u_ip"]=true;
                    }
                    $trades_clicks["$cook_dom"]++;
                    $lang_clicks["$u_lang"]++;
                    $links_clicked["$link"]++;
                    $ref_clicks["$u_ref"]++;
                    $ip_clicks["$u_ip"]++;
                    $ip_cltime["$u_ip"]+=$cl_time;
                    $hff_clicks["$u_xff"]++;
                    $hff_cltime["$u_xff"]+=$cl_time;
                }
            }
        }

        $html->sub_page_header('ExOut Traffic detailed stats');
        $html->main_table_header('ExOut Traffic detailed stats');

        if($outs<1) $outs=0;
        $trpro=$prox_outs[1] or $trpro=0;
        $dspro=$prox_outs[2] or $dspro=0;
        $anpro=$prox_outs[3] or $anpro=0;
        $totpro=$trpro+$dspro+$anpro;
        if($uniq_ip_outs<1) $uniq_ip_outs=0;
        if($outs>0){
            $trpropc=round($trpro*100/$outs,2);
            $dspropc=round($dspro*100/$outs,2);
            $anpropc=round($anpro*100/$outs,2);
            $totpropc=round($totpro*100/$outs,2);
            $ipoprc=round($uniq_ip_outs*100/$outs,2);
        } else {
            $trpropc=0;
            $dspropc=0;
            $anpropc=0;
            $totpropc=0;
            $ipoprc=0;
        }
        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>ExOut Traffic</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Total ExOuts</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$outs."</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Uinq IP ExOuts,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$uniq_ip_outs." (<b>".$ipoprc."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy ExOuts,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Total - ".$totpro." (<b>".$totpropc."</b>%)<br>
            Transparent - ".$trpro." (<b>".$trpropc."</b>%)<br>
            Distorting - ".$dspro." (<b>".$dspropc."</b>%)<br>
            Anonimous - ".$anpro." (<b>".$anpropc."</b>%)<br>
            </td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>ExOuts from trades</b></font></td></tr>     ";
        if(is_array($trades_clicks)){
            arsort($trades_clicks);
            foreach($trades_clicks as $trdom=>$trex){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$trdom."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$trex."</td></tr>";
            }
        }
        echo "</table>
            <br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function content_detailed(){
        global $intf,$html,$settings;

        if($dh=opendir($settings->log_path.'/out_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'out_')) continue;
                $fl=@file($settings->log_path.'/out_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($go_dom,$link,$cook_dom,$u_ip,$u_xff,$u_ref,$prox_t,$cl_time,$bon_d,$cl_u,$u_lang,$no_js,$njs_fl,$lr_fl,$mc_fl,$bl_fl,$nr_fl,$pr_fl,$mt_fl,$nc_fl,$mt_ac,$nr_ac,$pr_ac,$bot_fl)=explode('|',trim($fll));
                    if($go_dom!='content') continue;
                    $outs++;
                    if($prox_t>0) $prox_outs[$prox_t]++;
                    if(!$out_used["$u_ip"]){
                        $uniq_ip_outs++;
                        $out_used["$u_ip"]=true;
                    }
                    $trades_clicks["$cook_dom"]++;
                    $lang_clicks["$u_lang"]++;
                    $links_clicked["$link"]++;
                    $ref_clicks["$u_ref"]++;
                    $ip_clicks["$u_ip"]++;
                    $ip_cltime["$u_ip"]+=$cl_time;
                    $hff_clicks["$u_xff"]++;
                    $hff_cltime["$u_xff"]+=$cl_time;
                }
            }
        }

        $html->sub_page_header('Content Clicks detailed stats');
        $html->main_table_header('Content Clicks detailed stats');

        if($outs<1) $outs=0;
        $trpro=$prox_outs[1] or $trpro=0;
        $dspro=$prox_outs[2] or $dspro=0;
        $anpro=$prox_outs[3] or $anpro=0;
        $totpro=$trpro+$dspro+$anpro;
        if($uniq_ip_outs<1) $uniq_ip_outs=0;
        if($outs>0){
            $trpropc=round($trpro*100/$outs,2);
            $dspropc=round($dspro*100/$outs,2);
            $anpropc=round($anpro*100/$outs,2);
            $totpropc=round($totpro*100/$outs,2);
            $ipoprc=round($uniq_ip_outs*100/$outs,2);
        } else {
            $trpropc=0;
            $dspropc=0;
            $anpropc=0;
            $totpropc=0;
            $ipoprc=0;
        }
        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Content Clicks</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Total Content Clicks</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$outs."</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Uinq IP Content Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$uniq_ip_outs." (<b>".$ipoprc."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy Content Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Total - ".$totpro." (<b>".$totpropc."</b>%)<br>
            Transparent - ".$trpro." (<b>".$trpropc."</b>%)<br>
            Distorting - ".$dspro." (<b>".$dspropc."</b>%)<br>
            Anonimous - ".$anpro." (<b>".$anpropc."</b>%)<br>
            </td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Content Clicks from trades</b></font></td></tr>     ";
        if(is_array($trades_clicks)){
            arsort($trades_clicks);
            foreach($trades_clicks as $trdom=>$trex){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$trdom."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$trex."</td></tr>";
            }
        }
        echo "</table>
            <br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function nocookie_detailed(){
        global $intf,$html,$settings;

        if($dh=opendir($settings->log_path.'/out_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'out_')) continue;
                $fl=@file($settings->log_path.'/out_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($go_dom,$link,$cook_dom,$u_ip,$u_xff,$u_ref,$prox_t,$cl_time,$bon_d,$cl_u,$u_lang,$no_js,$njs_fl,$lr_fl,$mc_fl,$bl_fl,$nr_fl,$pr_fl,$mt_fl,$nc_fl,$mt_ac,$nr_ac,$pr_ac,$bot_fl)=explode('|',trim($fll));
                    if($cook_dom!='nocookie') continue;
                    $outs++;
                    if($prox_t>0) $prox_outs[$prox_t]++;
                    if(!$out_used["$u_ip"]){
                        $uniq_ip_outs++;
                        $out_used["$u_ip"]=true;
                    }
                    $trades_clicks["$go_dom"]++;
                    $lang_clicks["$u_lang"]++;
                    $links_clicked["$link"]++;
                    $ref_clicks["$u_ref"]++;
                }
            }
        }

        $html->sub_page_header('Content Clicks detailed stats');
        $html->main_table_header('Content Clicks detailed stats');

        if($outs<1) $outs=0;
        $trpro=$prox_outs[1] or $trpro=0;
        $dspro=$prox_outs[2] or $dspro=0;
        $anpro=$prox_outs[3] or $anpro=0;
        $totpro=$trpro+$dspro+$anpro;
        if($uniq_ip_outs<1) $uniq_ip_outs=0;
        if($outs>0){
            $trpropc=round($trpro*100/$outs,2);
            $dspropc=round($dspro*100/$outs,2);
            $anpropc=round($anpro*100/$outs,2);
            $totpropc=round($totpro*100/$outs,2);
            $ipoprc=round($uniq_ip_outs*100/$outs,2);
        } else {
            $trpropc=0;
            $dspropc=0;
            $anpropc=0;
            $totpropc=0;
            $ipoprc=0;
        }
        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>NoCookie Clicks</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Total NoCookie Clicks</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$outs."</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Uinq IP NoCookie Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$uniq_ip_outs." (<b>".$ipoprc."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy NoCookie Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Total - ".$totpro." (<b>".$totpropc."</b>%)<br>
            Transparent - ".$trpro." (<b>".$trpropc."</b>%)<br>
            Distorting - ".$dspro." (<b>".$dspropc."</b>%)<br>
            Anonimous - ".$anpro." (<b>".$anpropc."</b>%)<br>
            </td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>NoCookie Clicks to trades</b></font></td></tr>     ";
        if(is_array($trades_clicks)){
            arsort($trades_clicks);
            foreach($trades_clicks as $trdom=>$trex){
                if(!$trdom) continue;
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$trdom."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$trex."</td></tr>";
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>More recent clicks Referrer pages</b></font></td></tr>";
        if(is_array($ref_clicks)){
            arsort($ref_clicks);
            $l=0;
            foreach($ref_clicks as $rp=>$rc){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rc."</font></td></tr>";
                $l++;
                if($l>=50) break;
            }
        }

        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>More recent Click refer pages</b></font></td></tr>";
        if(is_array($ref_clicks)){
            arsort($ref_clicks);
            $l=0;
            foreach($ref_clicks as $rp=>$rc){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rc."</font></td></tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>More recent Languages</b></font></td></tr>
            ";
        $l=0;
        if(is_array($lang_clicks)){
            arsort($lang_clicks);
            foreach($lang_clicks as $cl=>$ct){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$cl."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$ct."</font></td>
                    </tr>";
                $l++;
                if($ct<1 || $l>=30) break;
            }

        }
        echo "</table>
        <br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function notrade_detailed(){
        global $intf,$html,$settings;

        if($dh=opendir($settings->log_path.'/in_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'in_')) continue;
                $fl=@file($settings->log_path.'/in_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($rdom,$ref,$ip,$c_time,$prox_t,$http_xff,$lang,$tr_uniq,$glob_uniq,$main_p,$lng_redir,$maxh_fl,$black_fl,$noref_fl,$prox_fl,$bot_fl)=explode('|',trim($fll));
                    if($rdom!='notrade') continue;
                    $ip_hits["$ip"]++;
                    $hff_hits["$http_xff"]++;
                    $ref_hits["$ref"]++;
                    $lang_hits["$lang"]++;
                    if($lng_redir>0){
                        $na_lng_redir++;
                        $na_langs["$lang"]++;
                        continue;
                    }
                    if($bot_fl>0){
                        $bot_hits++;
                        continue;
                    }
                    if($prox_t>0){
                        if($prox_fl<1) $prox_hits[$prox_t]++;
                        else {
                            $na_prox_hits[$prox_t]++;
                            continue;
                        }
                    }
                    if($black_fl>0){ $na_black_hits["$rdom"]++; continue; }
                    if($noref_fl>0){ $na_noref_hits++; continue; }
                    if($maxh_fl>0){ $na_maxhits++; continue; }
                    $hits++;
                    $page_hits["$main_p"]++;
                    if($tr_uniq) $tr_uniq_hits++;
                    if($glob_uniq) $gl_uniq_hits++;
                    if(!$used["$ip"]){
                        $ip_uniq++;
                        $used["$ip"]=true;
                    }
                }
            }
            closedir($dh);
        }

        if($dh=opendir($settings->log_path.'/out_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'out_')) continue;
                $fl=@file($settings->log_path.'/out_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($go_dom,$link,$cook_dom,$u_ip,$u_xff,$u_ref,$prox_t,$cl_time,$bon_d,$cl_u,$u_lang,$no_js,$njs_fl,$lr_fl,$mc_fl,$bl_fl,$nr_fl,$pr_fl,$mt_fl,$nc_fl,$mt_ac,$nr_ac,$pr_ac,$bot_fl)=explode('|',trim($fll));
                    if($cook_dom=='notrade'){
                        $links_clicked["$link"]++;
                        $lang_clicks["$u_lang"]++;
                        $ref_clicks["$u_ref"]++;
                        $ip_clicks["$u_ip"]++;
                        $ip_cltime["$u_ip"]+=$cl_time;
                        $hff_clicks["$u_xff"]++;
                        $hff_cltime["$u_xff"]+=$cl_time;
                        if($lr_fl){
                            $na_clicks_lr++;
                            $lang_clred["$u_lang"]++;
                            continue;
                        }
                        if($bot_fl>0){ $na_bot_cl++; continue; }
                        if($mt_ac<0){ $na_clicks_mt++; continue; }
                        if($nr_ac<0){ $na_clicks_nr++; continue; }
                        if($pr_ac<0){ $na_clicks_pr++; continue; }
                        if($bl_fl>0){ $na_clicks_bl["$cook_dom"]++; continue; }
                        if($mt_fl>0){ $na_clicks_mt++; continue; }
                        if($mc_fl>0){ $na_clicks_mc++; continue; }
                        if($njs_fl>0){ $na_clicks_njs++; continue; }
                        if($go_dom!='content'){
                            $clicks++;
                            if($prox_t>0) $prox_clicks[$prox_t]++;
                            if($no_js>0) $nojs_clicks++;
                            if($cl_u>0) $click_uniq++;
                            if(!$clused["$u_ip"]){
                                $clipuniq++;
                                $clused["$u_ip"]=true;
                            }
                        } else $cont_clicks++;
                    }
                }
            }
        }

        $html->sub_page_header('NoTrade traffic detaled stats');
        $html->main_table_header('NoTrade traffic detaled stats');

        $trprh=$prox_hits[1] or $trprh=0;
        $dsprh=$prox_hits[2] or $dsprh=0;
        $anprh=$prox_hits[3] or $anprh=0;
        $tprh=$trprh+$dsprh+$anprh;
        if($na_lng_redir<1) $na_lng_redir=0;
        if($na_noref_hits<1) $na_noref_hits=0;
        if($na_maxhits<1) $na_maxhits=0;
        if($hits>0){
             $trup=round($tr_uniq_hits*100/$hits,2);
             $glup=round($gl_uniq_hits*100/$hits,2);
             $ipup=round($ip_uniq*100/$hits,2);
             $lrpr=round($na_lng_redir*100/$hits,2);
             $trprpc=round($prox_hits[1]*100/$hits,2);
             $dsprpc=round($prox_hits[2]*100/$hits,2);
             $anprpc=round($prox_hits[3]*100/$hits,2);
             $totprpc=round($tprh*100/$hits,2);
             $nrprc=round($na_noref_hits*100/$hits,2);
             $mhprc=round($na_maxhits*100/$hits,2);
             $both_pr=round($bot_hits*100/$hits,2);
        } else {
             $trup=0;
             $glup=0;
             $ipup=0;
             $lrpr=0;
             $trprpc=0;
             $dsprpc=0;
             $anprpc=0;
             $totprpc=0;
             $nrprc=0;
             $mhprc=0;
             $both_pr=0;
        }
        if($tr_uniq_hits<1) $tr_uniq_hits=0;
        if(($clicks+$cont_clicks)>0) $ccprc=round($cont_clicks*100/($clicks+$cont_clicks),2);
        else $ccprc=0;
        $tot_prcl=$prox_clicks[1]+$prox_clicks[2]+$prox_clicks[3];
        if($clicks>0){
            $uclpr=round($click_uniq*100/$clicks,2);
            $uipclpr=round($clipuniq*100/$clicks,2);
            $prxclpr=round($tot_prcl*100/$clicks,2);
            $tr_prxclpr=round($prox_clicks[1]*100/$clicks,2);
            $ds_prxclpr=round($prox_clicks[2]*100/$clicks,2);
            $an_prxclpr=round($prox_clicks[3]*100/$clicks,2);
            $cllrpr=round($na_clicks_lr*100/$clicks,2);
            $nrclpr=round($na_clicks_nr*100/$clicks,2);
            $mcclpr=round($na_clicks_mc*100/$clicks,2);
            $mtclpr=round($na_clicks_mt*100/$clicks,2);
            $prclpr=round($na_clicks_pr*100/$clicks,2);
            $njsclpr=round($na_clicks_njs*100/$clicks,2);
            $njsaccclpr=round($nojs_clicks*100/$clicks,2);
            $botc_pr=round($na_bot_cl*100/$clicks,2);
        } else {
            $uclpr=0;
            $uipclpr=0;
            $prxclpr=0;
            $tr_prxclpr=0;
            $ds_prxclpr=0;
            $an_prxclpr=0;
            $cllrpr=0;
            $nrclpr=0;
            $mcclpr=0;
            $mtclpr=0;
            $prclpr=0;
            $njsclpr=0;
            $njsaccclpr=0;
            $botc_pr=0;
        }
        if($na_clicks_njs<1) $na_clicks_njs=0;
        if($na_clicks_pr<1) $na_clicks_pr=0;
        if($na_clicks_mt<1) $na_clicks_mt=0;
        if($na_clicks_mc<1) $na_clicks_mc=0;
        if($na_clicks_nr<1) $na_clicks_nr=0;
        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Accepted Hits</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Total Accepted Hits</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$hits."</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>IP Uniques,(%)</td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$ip_uniq." (<b>".$ipup."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy Hits,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Total - ".$tprh." (<b>".$totprpc."</b>%)</font></br>
            Transparent - ".$trprh." (<b>".$trprpc."</b>%)<br>
            Distorting - ".$dsprh." (<b>".$dsprpc."</b>%)<br>
            Anonumous - ".$anprh." (<b>".$anprpc."</b>%)<br>
            </font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'>Main Pages</td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($page_hits)){
            arsort($page_hits);
            foreach($page_hits as $mpnm=>$mpht){
                if($hits>0) $mppr=round($mpht*100/$hits,2); else $mppr=0;
                echo $mpnm.' - '.$mpht.' (<b>'.$mppr.'</b>%)<br>';
            }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Not Accepted Hits</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>Redirected by language,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($na_langs)){
            echo $na_lng_redir.",(".$lrpr."%)<br>";
            arsort($na_langs);
            foreach($na_langs as $lng=>$hht){
                if($hits>0) $lrpr=round($hht*100/$hits,2); else $lrpr=0;
                echo $lng.' - '.$hht.' (<b>'.$lrpr.'</b>%)<br>';
            }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>Blacklisted Domains,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($na_black_hits)){
             arsort($na_black_hits);
             foreach($na_black_hits as $bld=>$blht){
                 if($hits>0) $blpr=round($blht*100/$hits,2); else $blpr=0;
                 echo $bld.' - '.$blht.' (<b>'.$blpr.'</b>%)<br>';
             }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>Bot Hits,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$bot_hits." (<b>".$both_pr."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>User Overlimited hits,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_maxhits." (<b>".$mhprc."</b>%)</font></td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Accepted Clicks</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Clicks</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$clicks."</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Content Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$cont_clicks." (<b>".$ccprc."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Uniq IP Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$clipuniq." (<b>".$uipclpr."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Total - ".$tot_prcl." (<b>".$prxclpr."%</b>)<br>
            Transparent - ".$prox_clicks[1]." (<b>".$tr_prxclpr."%</b>)<br>
            Distorting - ".$prox_clicks[2]." (<b>".$ds_prxclpr."%</b>)<br>
            Anonimous - ".$prox_clicks[3]." (<b>".$an_prxclpr."%</b>)</font>
            </td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>No JSCookie Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$nojs_clicks." (<b>".$njsaccclpr."%</b>)</font></td>
            </tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Not Accepted Clicks</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Redirected by language,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($lang_clred)){
            echo $na_clicks_lr.",(".$cllrpr."%)";
            arsort($lang_clred);
            foreach($lang_clred as $lng=>$hht){
                if($clicks>0) $lrpr=round($hht*100/$clicks,2); else $lrpr=0;
                echo $lng.' - '.$hht.' (<b>'.$lrpr.'</b>%)<br>';
            }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Blacklisted Domains,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($na_clicks_bl)){
             arsort($na_clicks_bl);
             foreach($na_clicks_bl as $bld=>$blht){
                 if($clicks>0) $blpr=round($blht*100/$clicks,2); else $blpr=0;
                 echo $bld.' - '.$blht.' (<b>'.$blpr.'</b>%)<br>';
             }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Bot Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_bot_cl." (<b>".$botc_pr."%</b>)</font></td>
            </tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Overlimited Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_clicks_mc." (<b>".$mcclpr."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Fast Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_clicks_mt." (<b>".$mtclpr."%</b>)</font></td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>More recent Referrer pages</b></font></td></tr>";
        if(is_array($ref_hits)){
            arsort($ref_hits);
            $l=0;
            foreach($ref_hits as $rp=>$rc){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rc."</font></td></tr>";
                $l++;
                if($l>=50) break;
            }
        }

        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>More recent Links clicked</b></font></td></tr>";
        if(is_array($links_clicked)){
            arsort($links_clicked);
            $l=0;
            foreach($links_clicked as $rp=>$rc){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$rc."</font></td></tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=4><font size=1><b>More recent Hitting IPs</b></font></td></tr>";
        if(is_array($ip_hits)){
            arsort($ip_hits);
            if(is_array($hff_hits)) arsort($hff_hits);
            $l=0;
            if(is_array($hff_hits)) $hffid=array_keys($hff_hits);
            foreach($ip_hits as $rp=>$rc){
                $hfip=$hffid[$l];
                $hfht=$hff_hits["$hfip"];
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$rc."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$hfht."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$hfip."</font></td>
                    </tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=6><font size=1><b>More recent Clicking IPs and average Click time, sec</b></font></td></tr>";
        if(is_array($ip_clicks)){
            arsort($ip_clicks);
            if(is_array($hff_clicks)) arsort($hff_clicks);
            $l=0;
            if(is_array($hff_clicks)) $hffid=array_keys($hff_clicks);
            foreach($ip_clicks as $rp=>$rc){
                $hfip=$hffid[$l];
                $hfcl=$hff_clicks["$hfip"];
                $hfclt=$hff_cltime["$hfip"];
                if($rc>0) $avct=round($ip_cltime["$rp"]/$rc,1); else $avct=0;
                if($hfcl>0) $achct=round($hfclt/$hfcl,1); else $achct=0;
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$rc."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=220><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=50><font size=1><nobr>".$avct." s</nobr></font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$hfcl."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=220><font size=1>".$hfip."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=50><font size=1><nobr>".$achct." s</nobr></font></td>
                    </tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>More recent Click refer pages</b></font></td></tr>";
        if(is_array($ref_clicks)){
            arsort($ref_clicks);
            $l=0;
            foreach($ref_clicks as $rp=>$rc){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rc."</font></td></tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=4><font size=1><b>More recent Languages</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=300 class=nt colspan=2><font size=1>Hitting</font</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=300 class=nt colspan=2><font size=1>Clicking</font</td>
            </tr>
            ";
        if(is_array($lang_hits)){
            arsort($lang_hits);
            if(is_array($lang_clicks)) arsort($lang_clicks);
            $l=0;
            if(is_array($lang_clicks)) $cllid=array_keys($lang_clicks);
            foreach($lang_hits as $hl=>$ht){
                $clid=$cllid[$l] or $clid='&nbsp;';
                $cllng=$lang_clicks["$clid"] or $cllng='&nbsp;';
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$ht."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$hl."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$cllng."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$clid."</font></td>
                    </tr>";
                $l++;
                if($ht<1 || $l>=30) break;
            }

        }
        echo "</table>
        <br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function noref_detailed(){
        global $intf,$html,$settings;

        if($dh=opendir($settings->log_path.'/in_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'in_')) continue;
                $fl=@file($settings->log_path.'/in_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($rdom,$ref,$ip,$c_time,$prox_t,$http_xff,$lang,$tr_uniq,$glob_uniq,$main_p,$lng_redir,$maxh_fl,$black_fl,$noref_fl,$prox_fl,$bot_fl)=explode('|',trim($fll));
                    if($rdom!='noref') continue;
                    $ip_hits["$ip"]++;
                    $hff_hits["$http_xff"]++;
                    $ref_hits["$ref"]++;
                    $lang_hits["$lang"]++;
                    if($lng_redir>0){
                        $na_lng_redir++;
                        $na_langs["$lang"]++;
                        continue;
                    }
                    if($bot_fl>0){
                        $bot_hits++;
                        continue;
                    }
                    if($prox_t>0){
                        if($prox_fl<1) $prox_hits[$prox_t]++;
                        else {
                            $na_prox_hits[$prox_t]++;
                            continue;
                        }
                    }
                    if($black_fl>0){ $na_black_hits["$rdom"]++; continue; }
                    if($noref_fl>0){ $na_noref_hits++; continue; }
                    if($maxh_fl>0){ $na_maxhits++; continue; }
                    $hits++;
                    $page_hits["$main_p"]++;
                    if($tr_uniq) $tr_uniq_hits++;
                    if($glob_uniq) $gl_uniq_hits++;
                    if(!$used["$ip"]){
                        $ip_uniq++;
                        $used["$ip"]=true;
                    }
                }
            }
            closedir($dh);
        }

        if($dh=opendir($settings->log_path.'/out_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'out_')) continue;
                $fl=@file($settings->log_path.'/out_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($go_dom,$link,$cook_dom,$u_ip,$u_xff,$u_ref,$prox_t,$cl_time,$bon_d,$cl_u,$u_lang,$no_js,$njs_fl,$lr_fl,$mc_fl,$bl_fl,$nr_fl,$pr_fl,$mt_fl,$nc_fl,$mt_ac,$nr_ac,$pr_ac,$bot_fl)=explode('|',trim($fll));
                    if($cook_dom=='noref'){
                        $links_clicked["$link"]++;
                        $lang_clicks["$u_lang"]++;
                        $ref_clicks["$u_ref"]++;
                        $ip_clicks["$u_ip"]++;
                        $ip_cltime["$u_ip"]+=$cl_time;
                        $hff_clicks["$u_xff"]++;
                        $hff_cltime["$u_xff"]+=$cl_time;
                        if($lr_fl){
                            $na_clicks_lr++;
                            $lang_clred["$u_lang"]++;
                            continue;
                        }
                        if($bot_fl>0){ $na_bot_cl++; continue; }
                        if($mt_ac<0){ $na_clicks_mt++; continue; }
                        if($nr_ac<0){ $na_clicks_nr++; continue; }
                        if($pr_ac<0){ $na_clicks_pr++; continue; }
                        if($bl_fl>0){ $na_clicks_bl["$cook_dom"]++; continue; }
                        if($mt_fl>0){ $na_clicks_mt++; continue; }
                        if($mc_fl>0){ $na_clicks_mc++; continue; }
                        if($njs_fl>0){ $na_clicks_njs++; continue; }
                        if($go_dom!='content'){
                            $clicks++;
                            if($prox_t>0) $prox_clicks[$prox_t]++;
                            if($no_js>0) $nojs_clicks++;
                            if($cl_u>0) $click_uniq++;
                            if(!$clused["$u_ip"]){
                                $clipuniq++;
                                $clused["$u_ip"]=true;
                            }
                        } else $cont_clicks++;
                    }
                }
            }
        }

        $html->sub_page_header('NoRef traffic detaled stats');
        $html->main_table_header('NoRef traffic detaled stats');

        $trprh=$prox_hits[1] or $trprh=0;
        $dsprh=$prox_hits[2] or $dsprh=0;
        $anprh=$prox_hits[3] or $anprh=0;
        $tprh=$trprh+$dsprh+$anprh;
        if($na_lng_redir<1) $na_lng_redir=0;
        if($na_noref_hits<1) $na_noref_hits=0;
        if($na_maxhits<1) $na_maxhits=0;
        if($hits>0){
             $trup=round($tr_uniq_hits*100/$hits,2);
             $glup=round($gl_uniq_hits*100/$hits,2);
             $ipup=round($ip_uniq*100/$hits,2);
             $lrpr=round($na_lng_redir*100/$hits,2);
             $trprpc=round($prox_hits[1]*100/$hits,2);
             $dsprpc=round($prox_hits[2]*100/$hits,2);
             $anprpc=round($prox_hits[3]*100/$hits,2);
             $totprpc=round($tprh*100/$hits,2);
             $nrprc=round($na_noref_hits*100/$hits,2);
             $mhprc=round($na_maxhits*100/$hits,2);
             $both_pr=round($bot_hits*100/$hits,2);
        } else {
             $trup=0;
             $glup=0;
             $ipup=0;
             $lrpr=0;
             $trprpc=0;
             $dsprpc=0;
             $anprpc=0;
             $totprpc=0;
             $nrprc=0;
             $mhprc=0;
             $both_pr=0;
        }
        if($tr_uniq_hits<1) $tr_uniq_hits=0;
        if(($clicks+$cont_clicks)>0) $ccprc=round($cont_clicks*100/($clicks+$cont_clicks),2);
        else $ccprc=0;
        $tot_prcl=$prox_clicks[1]+$prox_clicks[2]+$prox_clicks[3];
        if($clicks>0){
            $uclpr=round($click_uniq*100/$clicks,2);
            $uipclpr=round($clipuniq*100/$clicks,2);
            $prxclpr=round($tot_prcl*100/$clicks,2);
            $tr_prxclpr=round($prox_clicks[1]*100/$clicks,2);
            $ds_prxclpr=round($prox_clicks[2]*100/$clicks,2);
            $an_prxclpr=round($prox_clicks[3]*100/$clicks,2);
            $cllrpr=round($na_clicks_lr*100/$clicks,2);
            $nrclpr=round($na_clicks_nr*100/$clicks,2);
            $mcclpr=round($na_clicks_mc*100/$clicks,2);
            $mtclpr=round($na_clicks_mt*100/$clicks,2);
            $prclpr=round($na_clicks_pr*100/$clicks,2);
            $njsclpr=round($na_clicks_njs*100/$clicks,2);
            $njsaccclpr=round($nojs_clicks*100/$clicks,2);
            $botc_pr=round($na_bot_cl*100/$clicks,2);
        } else {
            $uclpr=0;
            $uipclpr=0;
            $prxclpr=0;
            $tr_prxclpr=0;
            $ds_prxclpr=0;
            $an_prxclpr=0;
            $cllrpr=0;
            $nrclpr=0;
            $mcclpr=0;
            $mtclpr=0;
            $prclpr=0;
            $njsclpr=0;
            $njsaccclpr=0;
            $botc_pr=0;
        }
        if($na_clicks_njs<1) $na_clicks_njs=0;
        if($na_clicks_pr<1) $na_clicks_pr=0;
        if($na_clicks_mt<1) $na_clicks_mt=0;
        if($na_clicks_mc<1) $na_clicks_mc=0;
        if($na_clicks_nr<1) $na_clicks_nr=0;
        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Accepted Hits</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Total Accepted Hits</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$hits."</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>IP Uniques,(%)</td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$ip_uniq." (<b>".$ipup."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy Hits,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Total - ".$tprh." (<b>".$totprpc."</b>%)</font></br>
            Transparent - ".$trprh." (<b>".$trprpc."</b>%)<br>
            Distorting - ".$dsprh." (<b>".$dsprpc."</b>%)<br>
            Anonumous - ".$anprh." (<b>".$anprpc."</b>%)<br>
            </font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'>Main Pages</td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($page_hits)){
            arsort($page_hits);
            foreach($page_hits as $mpnm=>$mpht){
                if($hits>0) $mppr=round($mpht*100/$hits,2); else $mppr=0;
                echo $mpnm.' - '.$mpht.' (<b>'.$mppr.'</b>%)<br>';
            }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Not Accepted Hits</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>Redirected by language,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($na_langs)){
            echo $na_lng_redir.",(".$lrpr."%)";
            arsort($na_langs);
            foreach($na_langs as $lng=>$hht){
                if($hits>0) $lrpr=round($hht*100/$hits,2); else $lrpr=0;
                echo $lng.' - '.$hht.' (<b>'.$lrpr.'</b>%)<br>';
            }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>Blacklisted Domains,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($na_black_hits)){
             arsort($na_black_hits);
             foreach($na_black_hits as $bld=>$blht){
                 if($hits>0) $blpr=round($blht*100/$hits,2); else $blpr=0;
                 echo $bld.' - '.$blht.' (<b>'.$blpr.'</b>%)<br>';
             }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>Bot Hits,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$bot_hits." (<b>".$both_pr."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>User Overlimited hits,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_maxhits." (<b>".$mhprc."</b>%)</font></td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Accepted Clicks</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Clicks</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$clicks."</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Content Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$cont_clicks." (<b>".$ccprc."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Uniq IP Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$clipuniq." (<b>".$uipclpr."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Total - ".$tot_prcl." (<b>".$prxclpr."%</b>)<br>
            Transparent - ".$prox_clicks[1]." (<b>".$tr_prxclpr."%</b>)<br>
            Distorting - ".$prox_clicks[2]." (<b>".$ds_prxclpr."%</b>)<br>
            Anonimous - ".$prox_clicks[3]." (<b>".$an_prxclpr."%</b>)</font>
            </td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>No JSCookie Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$nojs_clicks." (<b>".$njsaccclpr."%</b>)</font></td>
            </tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Not Accepted Clicks</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Redirected by language,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($lang_clred)){
            echo $na_clicks_lr.",(".$cllrpr."%)";
            arsort($lang_clred);
            foreach($lang_clred as $lng=>$hht){
                if($clicks>0) $lrpr=round($hht*100/$clicks,2); else $lrpr=0;
                echo $lng.' - '.$hht.' (<b>'.$lrpr.'</b>%)<br>';
            }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Blacklisted Domains,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($na_clicks_bl)){
             arsort($na_clicks_bl);
             foreach($na_clicks_bl as $bld=>$blht){
                 if($clicks>0) $blpr=round($blht*100/$clicks,2); else $blpr=0;
                 echo $bld.' - '.$blht.' (<b>'.$blpr.'</b>%)<br>';
             }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Bot Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_bot_cl." (<b>".$botc_pr."%</b>)</font></td>
            </tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Overlimited Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_clicks_mc." (<b>".$mcclpr."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Fast Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_clicks_mt." (<b>".$mtclpr."%</b>)</font></td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>More recent Links clicked</b></font></td></tr>";
        if(is_array($links_clicked)){
            arsort($links_clicked);
            $l=0;
            foreach($links_clicked as $rp=>$rc){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$rc."</font></td></tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=4><font size=1><b>More recent Hitting IPs</b></font></td></tr>";
        if(is_array($ip_hits)){
            arsort($ip_hits);
            if(is_array($hff_hits)) arsort($hff_hits);
            $l=0;
            if(is_array($hff_hits)) $hffid=array_keys($hff_hits);
            foreach($ip_hits as $rp=>$rc){
                $hfip=$hffid[$l];
                $hfht=$hff_hits["$hfip"];
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$rc."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$hfht."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$hfip."</font></td>
                    </tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=6><font size=1><b>More recent Clicking IPs and average Click time, sec</b></font></td></tr>";
        if(is_array($ip_clicks)){
            arsort($ip_clicks);
            if(is_array($hff_clicks)) arsort($hff_clicks);
            $l=0;
            if(is_array($hff_clicks)) $hffid=array_keys($hff_clicks);
            foreach($ip_clicks as $rp=>$rc){
                $hfip=$hffid[$l];
                $hfcl=$hff_clicks["$hfip"];
                $hfclt=$hff_cltime["$hfip"];
                if($rc>0) $avct=round($ip_cltime["$rp"]/$rc,1); else $avct=0;
                if($hfcl>0) $achct=round($hfclt/$hfcl,1); else $achct=0;
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$rc."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=220><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=50><font size=1><nobr>".$avct." s</nobr></font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$hfcl."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=220><font size=1>".$hfip."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=50><font size=1><nobr>".$achct." s</nobr></font></td>
                    </tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>More recent Click refer pages</b></font></td></tr>";
        if(is_array($ref_clicks)){
            arsort($ref_clicks);
            $l=0;
            foreach($ref_clicks as $rp=>$rc){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rc."</font></td></tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=4><font size=1><b>More recent Languages</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=300 class=nt colspan=2><font size=1>Hitting</font</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=300 class=nt colspan=2><font size=1>Clicking</font</td>
            </tr>
            ";
        if(is_array($lang_hits)){
            arsort($lang_hits);
            if(is_array($lang_clicks)) arsort($lang_clicks);
            $l=0;
            if(is_array($lang_clicks)) $cllid=array_keys($lang_clicks);
            foreach($lang_hits as $hl=>$ht){
                $clid=$cllid[$l] or $clid='&nbsp;';
                $cllng=$lang_clicks["$clid"] or $cllng='&nbsp;';
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$ht."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$hl."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$cllng."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$clid."</font></td>
                    </tr>";
                $l++;
                if($ht<1 || $l>=30) break;
            }

        }
        echo "</table>
        <br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function filtered_detailed(){
        global $intf,$html,$settings;

        if($dh=opendir($settings->log_path.'/in_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'in_')) continue;
                $fl=@file($settings->log_path.'/in_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($rdom,$ref,$ip,$c_time,$prox_t,$http_xff,$lang,$tr_uniq,$glob_uniq,$main_p,$lng_redir,$maxh_fl,$black_fl,$noref_fl,$prox_fl,$bot_fl)=explode('|',trim($fll));
                    if($maxh_fl<1 && $prox_fl<1 && $noref_fl<1 && $bot_fl<1 && $black_fl<1) continue;
                    if($black_fl>0) $fl_black["$rdom"]++;
                    if($maxh_fl>0) $fl_maxh["$rdom"]++;
                    if($prox_fl>0) $fl_prox["$rdom"]++;
                    if($bot_fl>0) $fl_bot["$rdom"]++;
                }
            }
            closedir($dh);
        }

        if($dh=opendir($settings->log_path.'/out_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'out_')) continue;
                $fl=@file($settings->log_path.'/out_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($go_dom,$link,$cook_dom,$u_ip,$u_xff,$u_ref,$prox_t,$cl_time,$bon_d,$cl_u,$u_lang,$no_js,$njs_fl,$lr_fl,$mc_fl,$bl_fl,$nr_fl,$pr_fl,$mt_fl,$nc_fl,$mt_ac,$nr_ac,$pr_ac,$bot_fl)=explode('|',trim($fll));
                    if($go_dom=='filtered'){
                        $tf++;
                        if($mt_ac<1) $ofl_mt++;
                        if($nr_ac<1) $ofl_nr++;
                        if($pr_ac<1) $ofl_pr++;
                        if($bot_fl>0) $ofl_bot++;
                    }
                    if($njs_fl>0) $cfl_njs["$cook_dom"]++;
                    if($mc_fl>0) $cfl_mc["$cook_dom"]++;
                    if($bl_fl>0) $cfl_bl["$cook_dom"]++;
                    if($nr_fl>0) $cfl_nrf["$cook_dom"]++;
                    if($pr_fl>0) $cfl_pr["$cook_dom"]++;
                    if($mt_fl>0) $cfl_mt["$cook_dom"]++;
                    if($bot_fl>0) $cfl_bt["$cook_dom"]++;
                }
            }
        }

        $html->sub_page_header('Filtered traffic detaled stats');
        $html->main_table_header('Filtered traffic detaled stats');

        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=4><font size=1><b>Filtered Hits</b></font></td></tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=150 valign=top>Maximum hits per user</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=150 valign=top>Proxies</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=150 valign=top>Bots</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=150 valign=top>Blacklisted</td>
            </tr><tr><td bgcolor='".$intf->color['NORM_CELL']."'>";
        if(is_array($maxh_fl)){
            arsort($maxh_fl);
            echo '<table width=100% cellpadding=0 cellspacing=2>';
            foreach($maxh_fl as $fld=>$flh) echo '<tr><td>'.$fld.'</td><td>'.$flh.'</td></tr>';
            echo '</table>';
        } else echo '&nbsp;';
        echo "</td><td bgcolor='".$intf->color['NORM_CELL']."'>";
        if(is_array($fl_prox)){
            arsort($fl_prox);
            echo '<table width=100% cellpadding=0 cellspacing=2>';
            foreach($fl_prox as $fld=>$flh) echo '<tr><td>'.$fld.'</td><td>'.$flh.'</td></tr>';
            echo '</table>';
        } else echo '&nbsp;';
        echo "</td><td bgcolor='".$intf->color['NORM_CELL']."'>";
        if(is_array($fl_bot)){
            arsort($fl_bot);
            echo '<table width=100% cellpadding=0 cellspacing=2>';
            foreach($fl_bot as $fld=>$flh) echo '<tr><td>'.$fld.'</td><td>'.$flh.'</td></tr>';
            echo '</table>';
        } else echo '&nbsp;';
        echo "</td><td bgcolor='".$intf->color['NORM_CELL']."'>";
        if(is_array($fl_black)){
            arsort($fl_black);
            echo '<table width=100% cellpadding=0 cellspacing=2>';
            foreach($fl_black as $fld=>$flh) echo '<tr><td>'.$fld.'</td><td>'.$flh.'</td></tr>';
            echo '</table>';
        } else echo '&nbsp;';
        echo "</td></tr></table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Filtered Outs - $tf</b></font></td></tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Due to Fast Click</font></td>
                <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$ofl_mt."</font></td>
            </tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Due to No HTTP_REFERER</font></td>
                <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$ofl_nr."</font></td>
            </tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Due to Proxy</font></td>
                <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$ofl_pr."</font></td>
            </tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Due to Bots</font></td>
                <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$ofl_bot."</font></td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=3><font size=1><b>Filtered Clicks</b></font></td></tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=200 valign=top>NoJSCookie</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=200 valign=top>Max Clicks per User</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=200 valign=top>Blacklisted</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'>";
        if(is_array($cfl_njs)){
            arsort($cfl_njs);
            echo '<table width=100% cellpadding=0 cellspacing=2>';
            foreach($cfl_njs as $fld=>$flh) echo '<tr><td>'.$fld.'</td><td>'.$flh.'</td></tr>';
            echo '</table>';
        } else echo '&nbsp;';
        echo "</td><td bgcolor='".$intf->color['NORM_CELL']."'>";
        if(is_array($cfl_mc)){
            arsort($cfl_mc);
            echo '<table width=100% cellpadding=0 cellspacing=2>';
            foreach($cfl_mc as $fld=>$flh) echo '<tr><td>'.$fld.'</td><td>'.$flh.'</td></tr>';
            echo '</table>';
        } else echo '&nbsp;';
        echo "</td><td bgcolor='".$intf->color['NORM_CELL']."'>";
        if(is_array( $cfl_bl)){
            arsort( $cfl_bl);
            echo '<table width=100% cellpadding=0 cellspacing=2>';
            foreach( $cfl_bl as $fld=>$flh) echo '<tr><td>'.$fld.'</td><td>'.$flh.'</td></tr>';
            echo '</table>';
        } else echo '&nbsp;';
        echo "</td></table>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=150 valign=top>No HTTP_REFERER</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=150 valign=top>Proxies</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=150 valign=top>Fast Clicks</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=150 valign=top>Bots</td>
            </tr>
            <tr><td bgcolor='".$intf->color['NORM_CELL']."'>";
        if(is_array($cfl_nrf)){
            arsort($cfl_nrf);
            echo '<table width=100% cellpadding=0 cellspacing=2>';
            foreach($cfl_nrf as $fld=>$flh) echo '<tr><td>'.$fld.'</td><td>'.$flh.'</td></tr>';
            echo '</table>';
        } else echo '&nbsp;';
        echo "</td><td bgcolor='".$intf->color['NORM_CELL']."'>";
        if(is_array($cfl_pr)){
            arsort($cfl_pr);
            echo '<table width=100% cellpadding=0 cellspacing=2>';
            foreach($cfl_pr as $fld=>$flh) echo '<tr><td>'.$fld.'</td><td>'.$flh.'</td></tr>';
            echo '</table>';
        } else echo '&nbsp;';
        echo "</td><td bgcolor='".$intf->color['NORM_CELL']."'>";
        if(is_array($cfl_mt)){
            arsort($cfl_mt);
            echo '<table width=100% cellpadding=0 cellspacing=2>';
            foreach($cfl_mt as $fld=>$flh) echo '<tr><td>'.$fld.'</td><td>'.$flh.'</td></tr>';
            echo '</table>';
        } else echo '&nbsp;';
        echo "</td><td bgcolor='".$intf->color['NORM_CELL']."'>";
        if(is_array($cfl_bt)){
            arsort($cfl_bt);
            echo '<table width=100% cellpadding=0 cellspacing=2>';
            foreach($cfl_bt as $fld=>$flh) echo '<tr><td>'.$fld.'</td><td>'.$flh.'</td></tr>';
            echo '</table>';
        } else echo '&nbsp;';
        echo "</td></tr>
            </table>
            <br>
        ";
        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function detailed_stats(){
        global $intf,$html,$settings;

        $ddom=$_GET['domain'];
        if(!$ddom) $this->shortstats();

        if($dh=opendir($settings->log_path.'/in_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'in_')) continue;
                $fl=@file($settings->log_path.'/in_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($rdom,$ref,$ip,$c_time,$prox_t,$http_xff,$lang,$tr_uniq,$glob_uniq,$main_p,$lng_redir,$maxh_fl,$black_fl,$noref_fl,$prox_fl,$bot_fl)=explode('|',trim($fll));
                    if($rdom!=$ddom) continue;
                    $ip_hits["$ip"]++;
                    $hff_hits["$http_xff"]++;
                    $ref_hits["$ref"]++;
                    $lang_hits["$lang"]++;
                    if($lng_redir>0){
                        $na_lng_redir++;
                        $na_langs["$lang"]++;
                        continue;
                    }
                    if($bot_fl>0){
                        $bot_hits++;
                        continue;
                    }
                    if($prox_t>0){
                        if($prox_fl<1) $prox_hits[$prox_t]++;
                        else {
                            $na_prox_hits[$prox_t]++;
                            continue;
                        }
                    }
                    if($black_fl>0){ $na_black_hits["$rdom"]++; continue; }
                    if($noref_fl>0){ $na_noref_hits++; continue; }
                    if($maxh_fl>0){ $na_maxhits++; continue; }
                    $hits++;
                    $page_hits["$main_p"]++;
                    if($tr_uniq) $tr_uniq_hits++;
                    if($glob_uniq) $gl_uniq_hits++;
                    if(!$used["$ip"]){
                        $ip_uniq++;
                        $used["$ip"]=true;
                    }
                }
            }
            closedir($dh);
        }

        if($dh=opendir($settings->log_path.'/out_archive')){
            while(($file=readdir($dh))!==false){
                if($file=='.' || $file=='..' || !stristr($file,'out_')) continue;
                $fl=@file($settings->log_path.'/out_archive/'.$file);
                if(!$fl) continue;
                foreach($fl as $fll){
                    list($go_dom,$link,$cook_dom,$u_ip,$u_xff,$u_ref,$prox_t,$cl_time,$bon_d,$cl_u,$u_lang,$no_js,$njs_fl,$lr_fl,$mc_fl,$bl_fl,$nr_fl,$pr_fl,$mt_fl,$nc_fl,$mt_ac,$nr_ac,$pr_ac,$bot_fl)=explode('|',trim($fll));
                    if($go_dom==$ddom){
                        $outs++;
                        if($prox_t>0) $prox_outs[$prox_t]++;
                        if(!$out_used["$u_ip"]){
                            $uniq_ip_outs++;
                            $out_used["$u_ip"]=true;
                        }
                    }
                    if($cook_dom==$ddom){
                        $links_clicked["$link"]++;
                        $lang_clicks["$u_lang"]++;
                        $ref_clicks["$u_ref"]++;
                        $ip_clicks["$u_ip"]++;
                        $ip_cltime["$u_ip"]+=$cl_time;
                        $hff_clicks["$u_xff"]++;
                        $hff_cltime["$u_xff"]+=$cl_time;
                        if($lr_fl){
                            $na_clicks_lr++;
                            $lang_clred["$u_lang"]++;
                            continue;
                        }
                        if($bot_fl>0){ $na_bot_cl++; continue; }
                        if($mt_ac<0){ $na_clicks_mt++; continue; }
                        if($nr_ac<0){ $na_clicks_nr++; continue; }
                        if($pr_ac<0){ $na_clicks_pr++; continue; }
                        if($bl_fl>0){ $na_clicks_bl["$cook_dom"]++; continue; }
                        if($mt_fl>0){ $na_clicks_mt++; continue; }
                        if($mc_fl>0){ $na_clicks_mc++; continue; }
                        if($njs_fl>0){ $na_clicks_njs++; continue; }
                        if($go_dom!='content'){
                            $clicks++;
                            if($prox_t>0) $prox_clicks[$prox_t]++;
                            if($no_js>0) $nojs_clicks++;
                            if($cl_u>0) $click_uniq++;
                            if(!$clused["$u_ip"]){
                                $clipuniq++;
                                $clused["$u_ip"]=true;
                            }
                        } else $cont_clicks++;
                    }
                }
            }
        }

        $html->sub_page_header('Trade &quot;'.$ddom.'&quot; detaled stats');
        $html->main_table_header('Trade &quot;'.$ddom.'&quot; detaled stats');

        $trprh=$prox_hits[1] or $trprh=0;
        $dsprh=$prox_hits[2] or $dsprh=0;
        $anprh=$prox_hits[3] or $anprh=0;
        $tprh=$trprh+$dsprh+$anprh;
        if($na_lng_redir<1) $na_lng_redir=0;
        if($na_noref_hits<1) $na_noref_hits=0;
        if($na_maxhits<1) $na_maxhits=0;
        if($hits>0){
             $trup=round($tr_uniq_hits*100/$hits,2);
             $glup=round($gl_uniq_hits*100/$hits,2);
             $ipup=round($ip_uniq*100/$hits,2);
             $lrpr=round($na_lng_redir*100/$hits,2);
             $trprpc=round($prox_hits[1]*100/$hits,2);
             $dsprpc=round($prox_hits[2]*100/$hits,2);
             $anprpc=round($prox_hits[3]*100/$hits,2);
             $totprpc=round($tprh*100/$hits,2);
             $nrprc=round($na_noref_hits*100/$hits,2);
             $mhprc=round($na_maxhits*100/$hits,2);
             $both_pr=round($bot_hits*100/$hits,2);
        } else {
             $trup=0;
             $glup=0;
             $ipup=0;
             $lrpr=0;
             $trprpc=0;
             $dsprpc=0;
             $anprpc=0;
             $totprpc=0;
             $nrprc=0;
             $mhprc=0;
             $both_pr=0;
        }
        if($outs<1) $outs=0;
        $trpro=$prox_outs[1] or $trpro=0;
        $dspro=$prox_outs[2] or $dspro=0;
        $anpro=$prox_outs[3] or $anpro=0;
        $totpro=$trpro+$dspro+$anpro;
        if($uniq_ip_outs<1) $uniq_ip_outs=0;
        if($outs>0){
            $trpropc=round($trpro*100/$outs,2);
            $dspropc=round($dspro*100/$outs,2);
            $anpropc=round($anpro*100/$outs,2);
            $totpropc=round($totpro*100/$outs,2);
            $ipoprc=round($uniq_ip_outs*100/$outs,2);
        } else {
            $trpropc=0;
            $dspropc=0;
            $anpropc=0;
            $totpropc=0;
            $ipoprc=0;
        }
        if($tr_uniq_hits<1) $tr_uniq_hits=0;
        if($gl_uniq_hits<1) $gl_uniq_hits=0;
        if(($clicks+$cont_clicks)>0) $ccprc=round($cont_clicks*100/($clicks+$cont_clicks),2);
        else $ccprc=0;
        $tot_prcl=$prox_clicks[1]+$prox_clicks[2]+$prox_clicks[3];
        if($clicks>0){
            $uclpr=round($click_uniq*100/$clicks,2);
            $uipclpr=round($clipuniq*100/$clicks,2);
            $prxclpr=round($tot_prcl*100/$clicks,2);
            $tr_prxclpr=round($prox_clicks[1]*100/$clicks,2);
            $ds_prxclpr=round($prox_clicks[2]*100/$clicks,2);
            $an_prxclpr=round($prox_clicks[3]*100/$clicks,2);
            $cllrpr=round($na_clicks_lr*100/$clicks,2);
            $nrclpr=round($na_clicks_nr*100/$clicks,2);
            $mcclpr=round($na_clicks_mc*100/$clicks,2);
            $mtclpr=round($na_clicks_mt*100/$clicks,2);
            $prclpr=round($na_clicks_pr*100/$clicks,2);
            $njsclpr=round($na_clicks_njs*100/$clicks,2);
            $njsaccclpr=round($nojs_clicks*100/$clicks,2);
            $botc_pr=round($na_bot_cl*100/$clicks,2);
        } else {
            $uclpr=0;
            $uipclpr=0;
            $prxclpr=0;
            $tr_prxclpr=0;
            $ds_prxclpr=0;
            $an_prxclpr=0;
            $cllrpr=0;
            $nrclpr=0;
            $mcclpr=0;
            $mtclpr=0;
            $prclpr=0;
            $njsclpr=0;
            $njsaccclpr=0;
            $botc_pr=0;
        }
        if($na_clicks_njs<1) $na_clicks_njs=0;
        if($na_clicks_pr<1) $na_clicks_pr=0;
        if($na_clicks_mt<1) $na_clicks_mt=0;
        if($na_clicks_mc<1) $na_clicks_mc=0;
        if($na_clicks_nr<1) $na_clicks_nr=0;
        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Accepted Hits</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Total Accepted Hits</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$hits."</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Trade Uniques,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$tr_uniq_hits." (<b>".$trup."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Global Uniques,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$gl_uniq_hits." (<b>".$glup."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>IP Uniques,(%)</td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$ip_uniq." (<b>".$ipup."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy Hits,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Total - ".$tprh." (<b>".$totprpc."</b>%)</font></br>
            Transparent - ".$trprh." (<b>".$trprpc."</b>%)<br>
            Distorting - ".$dsprh." (<b>".$dsprpc."</b>%)<br>
            Anonumous - ".$anprh." (<b>".$anprpc."</b>%)<br>
            </font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'>Main Pages</td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($page_hits)){
            arsort($page_hits);
            foreach($page_hits as $mpnm=>$mpht){
                if($hits>0) $mppr=round($mpht*100/$hits,2); else $mppr=0;
                echo $mpnm.' - '.$mpht.' (<b>'.$mppr.'</b>%)<br>';
            }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Not Accepted Hits</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>Redirected by language,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($na_langs)){
            echo $na_lng_redir.",(".$lrpr."%)";
            arsort($na_langs);
            foreach($na_langs as $lng=>$hht){
                if($hits>0) $lrpr=round($hht*100/$hits,2); else $lrpr=0;
                echo $lng.' - '.$hht.' (<b>'.$lrpr.'</b>%)<br>';
            }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>Blacklisted Domains,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($na_black_hits)){
             arsort($na_black_hits);
             foreach($na_black_hits as $bld=>$blht){
                 if($hits>0) $blpr=round($blht*100/$hits,2); else $blpr=0;
                 echo $bld.' - '.$blht.' (<b>'.$blpr.'</b>%)<br>';
             }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>Bot Hits,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$bot_hits." (<b>".$both_pr."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>NoRef hits,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_noref_hits." (<b>".$nrprc."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>User Overlimited hits,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_maxhits." (<b>".$mhprc."</b>%)</font></td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Outs</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Total Outs</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$outs."</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Unique IP Outs,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$uniq_ip_outs." (<b>".$ipoprc."</b>%)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy Outs,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Total - ".$totpro." (<b>".$totpropc."</b>%)<br>
            Transparent - ".$trpro." (<b>".$trpropc."</b>%)<br>
            Distorting - ".$dspro." (<b>".$dspropc."</b>%)<br>
            Anonimous - ".$anpro." (<b>".$anpropc."</b>%)<br>
            </td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Accepted Clicks</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>Trade Clicks</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$clicks."</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Content Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$cont_clicks." (<b>".$ccprc."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Uniq IP Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$clipuniq." (<b>".$uipclpr."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Total - ".$tot_prcl." (<b>".$prxclpr."%</b>)<br>
            Transparent - ".$prox_clicks[1]." (<b>".$tr_prxclpr."%</b>)<br>
            Distorting - ".$prox_clicks[2]." (<b>".$ds_prxclpr."%</b>)<br>
            Anonimous - ".$prox_clicks[3]." (<b>".$an_prxclpr."%</b>)</font>
            </td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>No JSCookie Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$nojs_clicks." (<b>".$njsaccclpr."%</b>)</font></td>
            </tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>Not Accepted Clicks</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Redirected by language,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($lang_clred)){
            echo $na_clicks_lr.",(".$cllrpr."%)";
            arsort($lang_clred);
            foreach($lang_clred as $lng=>$hht){
                if($clicks>0) $lrpr=round($hht*100/$clicks,2); else $lrpr=0;
                echo $lng.' - '.$hht.' (<b>'.$lrpr.'</b>%)<br>';
            }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Blacklisted Domains,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
        if(is_array($na_clicks_bl)){
             arsort($na_clicks_bl);
             foreach($na_clicks_bl as $bld=>$blht){
                 if($clicks>0) $blpr=round($blht*100/$clicks,2); else $blpr=0;
                 echo $bld.' - '.$blht.' (<b>'.$blpr.'</b>%)<br>';
             }
        } else echo 'none';
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Bot Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_bot_cl." (<b>".$botc_pr."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>NoRef Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_clicks_nr." (<b>".$nrclpr."%</b>)</font></td>
            </tr>
            </tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Overlimited Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_clicks_mc." (<b>".$mcclpr."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Fast Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_clicks_mt." (<b>".$mtclpr."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>Proxy Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_clicks_pr." (<b>".$prclpr."%</b>)</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>No JSCookie Clicks,(%)</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$na_clicks_njs." (<b>".$njsclpr."%</b>)</font></td>
            </tr>
            </table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>More recent Referrer pages</b></font></td></tr>";
        if(is_array($ref_hits)){
            arsort($ref_hits);
            $l=0;
            foreach($ref_hits as $rp=>$rc){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rc."</font></td></tr>";
                $l++;
                if($l>=50) break;
            }
        }

        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>More recent Links clicked</b></font></td></tr>";
        if(is_array($links_clicked)){
            arsort($links_clicked);
            $l=0;
            foreach($links_clicked as $rp=>$rc){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=300><font size=1>".$rc."</font></td></tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=4><font size=1><b>More recent Hitting IPs</b></font></td></tr>";
        if(is_array($ip_hits)){
            arsort($ip_hits);
            if(is_array($hff_hits)) arsort($hff_hits);
            $l=0;
            if(is_array($hff_hits)) $hffid=array_keys($hff_hits);
            foreach($ip_hits as $rp=>$rc){
                $hfip=$hffid[$l];
                $hfht=$hff_hits["$hfip"];
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$rc."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$hfht."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$hfip."</font></td>
                    </tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=6><font size=1><b>More recent Clicking IPs and average Click time, sec</b></font></td></tr>";
        if(is_array($ip_clicks)){
            arsort($ip_clicks);
            if(is_array($hff_clicks)) arsort($hff_clicks);
            $l=0;
            if(is_array($hff_clicks)) $hffid=array_keys($hff_clicks);
            foreach($ip_clicks as $rp=>$rc){
                $hfip=$hffid[$l];
                $hfcl=$hff_clicks["$hfip"];
                $hfclt=$hff_cltime["$hfip"];
                if($rc>0) $avct=round($ip_cltime["$rp"]/$rc,1); else $avct=0;
                if($hfcl>0) $achct=round($hfclt/$hfcl,1); else $achct=0;
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$rc."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=220><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=50><font size=1><nobr>".$avct." s</nobr></font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$hfcl."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=220><font size=1>".$hfip."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=50><font size=1><nobr>".$achct." s</nobr></font></td>
                    </tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1><b>More recent Click refer pages</b></font></td></tr>";
        if(is_array($ref_clicks)){
            arsort($ref_clicks);
            $l=0;
            foreach($ref_clicks as $rp=>$rc){
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rp."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$rc."</font></td></tr>";
                $l++;
                if($l>=50) break;
            }
        }
        echo "</table>
            <br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=4><font size=1><b>More recent Languages</b></font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=300 class=nt colspan=2><font size=1>Hitting</font</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=300 class=nt colspan=2><font size=1>Clicking</font</td>
            </tr>
            ";
        if(is_array($lang_hits)){
            arsort($lang_hits);
            if(is_array($lang_clicks)) arsort($lang_clicks);
            $l=0;
            if(is_array($lang_clicks)) $cllid=array_keys($lang_clicks);
            foreach($lang_hits as $hl=>$ht){
                $clid=$cllid[$l] or $clid='&nbsp;';
                $cllng=$lang_clicks["$clid"] or $cllng='&nbsp;';
                echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$ht."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$hl."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=30><font size=1>".$cllng."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' width=270><font size=1>".$clid."</font></td>
                    </tr>";
                $l++;
                if($ht<1 || $l>=30) break;
            }

        }
        echo "</table>
        <br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;

    }

    function toplists($rr=true){
        global $intf,$html,$settings,$global,$log;

        $html->sub_page_header('Toplists control');
        $html->main_table_header('Toplists control');

        if($rr) $global->read_toplists();

        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=4><font size=1>Templates in use</font></td></tr>
            <tr align=center>
            <td bgcolor='".$intf->color['STB_HEADER']."' width=20 class=nt>&nbsp;</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' width=215 class=nt><font size=1>Template File</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' width=215 class=nt><font size=1>Destination File</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' width=150 class=nt><font size=1>Trades Sorting</font></td>
            </tr>
        ";
        if(is_array($global->top_pages)){
            foreach($global->top_pages as $pgn=>$dst){
                $indb["$pgn"]=true;
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><input type=checkbox name='todel[]' value='".$pgn."'></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$pgn."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>";
                $html->input(11,'normal','text','cur_dest['.$pgn.']',30,165,$dst);
                echo"</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><select name=cur_sort[".$pgn."]><option value=0";
                if($global->top_sort["$pgn"]<1) echo ' selected';
                echo ">Hits IN<option value=1";
                if($global->top_sort["$pgn"]==1) echo ' selected';
                echo ">Productivity<option value=2";
                if($global->top_sort["$pgn"]==2) echo ' selected';
                echo ">Effectivity<option value=3";
                if($global->top_sort["$pgn"]==3) echo ' selected';
                echo ">Debt</select></td>
                </tr>";
            }
        }
        $to_read=array();
        if($dh=@opendir($settings->templates_path)){
            while(($file=@readdir($dh))!==false) if($file!='.' && $file!='..' && !$indb["$file"] && !is_dir($settings->html_path.'/'.$file)) $to_read[]=$file;
            @closedir($dh);
        } else $log->error('TEMPLATES dir not found or not readable');
        if(count($to_read)>0){
            echo "<tr>
                <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=4>
                <table width=100% border=0><tr align=center>
                <td width=33%><font size=1>Choose Template<br>
                <select name=new_template>";
            foreach($to_read as $trn) echo "<option value='".$trn."'>".$trn;
            echo "</select></td><td width=34%><font size=1>Destination File<br></font>";
            $html->input(11,'normal','text','new_dest',30,165,'');
            echo "</td><td width=33%><font size=1>Sorting Type</font><br><select name=new_sort><option value=0 selected>Hits IN<option value=1>Productivity<option value=2>Effectivity<option value=3>Debt</select></td></tr></table><br>";
            $html->button('submit','Add Template','light');
            echo "</td></tr>";
        }

        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=4>";
        $html->button('submit','Update Templates','light');
        echo "&nbsp;&nbsp;&nbsp;&nbsp;";
        $html->button('submit','Delete Templates','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=4>";
        $html->button('submit','Generate Toplists','light');
        echo "</td>
            </tr>
        </table><br>
        <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=6><font size=1>Toplists Updates schedule</font></td></tr>";

        for($i=0;$i<4;$i++){
            echo "<tr align=center>";
            for($j=0;$j<6;$j++){
                echo "<td bgcolor='".$intf->color['NORM_CELL']."'>";
                for($z=0;$z<4;$z++){
                    $h=$i*6+$j;
                    $min=$z*15;
                    $dmin=$h*60+$min;
                    $blnum=$h*4+$z;
                    if($h<10) $h='0'.$h;
                    if($min<10) $min='0'.$min;
                    echo "<input type=checkbox name='block[".$blnum."]' value=1";
                    if($global->top_times[$blnum]>0) echo ' checked';
                    echo ">".$h.":".$min."<br>";
                }
                echo "</td>";
            }
            echo "</tr>";
        }
        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=6>";
        $html->button('submit','Update Schedule','light');
        echo "</td></tr>
        </table><br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function update_schedule(){
        global $global;

        $to_update=$_POST['block'];
        $global->read_toplists();
        for($i=0;$i<96;$i++) $global->top_times[$i]=$to_update[$i];
        $global->save_top_times();
        $this->toplists(false);
    }

    function add_template(){
        global $global;

        $new_tpl=$_POST['new_template'];
        $new_dst=str_replace('|','',$_POST['new_dest']);

        if(!$new_tpl || !$new_dst) $this->toplists();
        $global->read_toplists();
        $new_sort=$_POST['new_sort'];
        if(!$new_sort) $new_sort=0;
        $global->top_pages["$new_tpl"]=$new_dst;
        $global->top_sort["$new_tpl"]=$new_sort;
        $global->save_top_pages();
        $this->toplists(false);
    }

    function delete_templates(){
        global $global;

        $to_del=$_POST['todel'];
        if(!is_array($to_del) || count($to_del)<1) $this->toplists();
        $global->read_toplists();
        foreach($to_del as $delp){
            unset($global->top_pages["$delp"]);
            unset($global->top_sort["$delp"]);
        }
        $global->save_top_pages();
        $this->toplists(false);
    }

    function update_templates(){
        global $global;

        $cur_dest=$_POST['cur_dest'];
        $cur_sort=$_POST['cur_sort'];
        if(!is_array($cur_dest)) $this->toplists();
        $global->read_toplists();
        foreach($cur_dest as $tpln=>$dst){
            if(!$dst || stristr($dst,'|')) continue;
            $global->top_pages["$tpln"]=$dst;
            $global->top_sort["$tpln"]=$cur_sort["$tpln"];
        }
        $global->save_top_pages();
        $this->toplists(false);
    }

    function generate_toplists(){
        global $settings;
        // Reading trades

        $tr_dat=@file($settings->data_path.'/traders.dat');
        if($tr_dat){
            foreach($tr_dat as $tr_dl){
                if(strlen($tr_dl)<30) continue;
                list($dom,$url,$set_ratio,$trade_type,$proxy_an,$proxy_ds,$proxy_tr,$badref_in,$m_pages,$c_rule,$c_skim,$f_rule,$nc_pr,$acc_badref,$badref_cl_pr,$proxy_cl_pr,$njs_r,$s_name,$e_mail,$nick,$icq,$toplist,$time_added)=explode('|',trim($tr_dl));
                if(!$dom || !$s_name || $trade_type<1) continue;

                $trader_url["$dom"]=$url;
                $trader_trade_type["$dom"]=$trade_type;
                $trader_toplist["$dom"]=$toplist;
                $trader_site_name["$dom"]=$s_name;
            }
        }

        // Reading new trades

        $ntr_dat=@file($settings->data_path.'/new_traders.dat');
        if($ntr_dat){
            foreach($ntr_dat as $tr_dl){
                if(strlen($tr_dl)<30) continue;
                list($dom,$url,$set_ratio,$trade_type,$proxy_an,$proxy_ds,$proxy_tr,$badref_in,$m_pages,$c_rule,$c_skim,$f_rule,$nc_pr,$acc_badref,$badref_cl_pr,$proxy_cl_pr,$njs_r,$s_name,$e_mail,$nick,$icq,$toplist,$time_added,$from_ip)=explode('|',trim($tr_dl));
                if(!$dom || !$s_name || $trade_type<1) continue;

                $trader_url["$dom"]=$url;
                $trader_trade_type["$dom"]=$trade_type;
                $trader_toplist["$dom"]=$toplist;
                $trader_site_name["$dom"]=$s_name;
            }
        }

        // Reading stats

        if($st_dat=@file($settings->data_path.'/short_stats.dat')){
            // Reading express stats
            foreach($st_dat as $st_dl){
                if(strlen($st_dl)<5) continue;
                list($dom,$hour_in,$hour_trad_uin,$hour_glob_uin,$hour_in_proxy,$hour_out,$hour_out_proxy,$hour_click,$hour_click_proxy,$hour_click_uniq,$hour_nojs,$hour_cont,$hour_rclicks,$hour_lang,$day_in,$day_trad_uin,$day_glob_uin,$day_in_proxy,$day_out,$day_out_proxy,$day_click,$day_click_proxy,$day_click_uniq,$day_nojs,$day_cont,$day_rclicks,$day_lang,$debt)=explode('|',trim($st_dl));
                if(!$dom || !$s_name || !$trader_url["$dom"] || $day_in<1) continue;

                $stats_day_in["$dom"]=$day_in or $stats_day_in["$dom"]=0;
                $stats_day_click["$dom"]=$day_click or $stats_day_click["$dom"]=0;

                if($day_in>0) $stats_day_prod["$dom"]=$day_click/$day_in; else $stats_day_prod["$dom"]=0;
                if($day_out>0) $stats_day_eff["$dom"]=$day_click/$day_out; else $stats_day_eff["$dom"]=0;
                $stats_debt["$dom"]=$debt;
            }

        } else $this->toplists();

        if(!$pages=@file($settings->data_path.'/top_pages.dat')) $this->toplists();

        foreach($pages as $pgl){
            if(strlen($pgl)<3) continue;
            list($tpl,$dst,$st)=explode('|',trim($pgl));
            $top_html["$tpl"]=$dst;
            $top_sort["$tpl"]=$st;
        }

        if(!is_array($top_html)) $this->toplists();

        foreach($top_html as $tpl_file=>$dst_file){
            $html=@file($settings->templates_path.'/'.$tpl_file);
            if(!$html) continue;
            $html=@join('',$html);

            $top_places=substr_count($html,'<!--FTOP_TRURL');
            $dom_sorted=array();

            switch($top_sort["$tpl_file"]){
            case 0:
                if(is_array($stats_day_in)){
                    arsort($stats_day_in);
                    $dom_sorted=array_keys($stats_day_in);
                }
                break;
            case 1:
                if(is_array($stats_day_prod)){
                    arsort($stats_day_prod);
                    $dom_sorted=array_keys($stats_day_prod);
                }
                break;
            case 2:
                if(is_array($stats_day_eff)){
                    arsort($stats_day_eff);
                    $dom_sorted=array_keys($stats_day_eff);
                }
                break;
            case 3:
                if(is_array($stats_debt)){
                    arsort($stats_debt);
                    $dom_sorted=array_keys($stats_debt);
                }
                break;
            }

            for($i=0;$i<$top_places;$i++){
                $dom=$dom_sorted[$i];
                $pln=$i+1;
                $html=str_replace('<!--FTOP_TRURL_'.$pln.'-->',$trader_url["$dom"],$html);
                $html=str_replace('<!--FTOP_TRNAME_'.$pln.'-->',$trader_site_name["$dom"],$html);
                $html=str_replace('<!--FTOP_TRHITS_'.$pln.'-->',$stats_day_in["$dom"],$html);
            }
            $html=str_replace('<!--FDATA-->',date('H:i, jS of F Y'),$html);
            // Writing HTML
            $fp=@fopen($settings->html_path.'/'.$dst_file,'w');
            if($fp){
                @flock($fp,LOCK_EX);
                @fwrite($fp,$html);
                @flock($fp,LOCK_UN);
                @fclose($fp);
            }
            @chmod($settings->html_path.'/'.$dst_file,0777);
        }
        $this->toplists();
    }

    function exit_traffic($rf=true){
        global $global,$intf,$html;

        $dayname=array(1=>'Sunday',2=>'Monday',3=>'Tuesday',4=>'Wednesday',5=>'Thursday',6=>'Friday',7=>'Saturday');

        $html->sub_page_header('Exit Traffic control');
        $html->script_evf();
        $html->main_table_header('Exit Traffic Control');
        if($rf) $global->read_exit_urls();
        $this->read_traders();

        echo "<br>
            <table width=800 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=30>&nbsp;</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=340 class=nt><font size=1>URL</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=150 class=nt><font size=1>Time</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=150 class=nt><font size=1>Traffic, %</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=150 class=nt><font size=1>State</font></td>
            </tr>";

        if(is_array($global->exit_urls)){
            $ch=date('G');
            $cm=date('i');
            $cd=date('w');
            foreach($global->exit_urls as $enum=>$eurl){
                if($global->exit_st_day[$enum]==0 || $global->exit_ed_day[$enum]==0){
                    $st_time=$global->exit_st_hour[$enum]*60+$global->exit_st_min[$enum];
                    $ed_time=$global->exit_ed_hour[$enum]*60+$global->exit_ed_min[$enum];
                    $ct_time=$ch*60+$cm;
                    $t_str='Daily<br>From: '.$global->exit_st_hour[$enum].':'.$global->exit_st_min[$enum].'<br>Until: '.$global->event_ed_hour[$enum].':'.$global->exit_ed_min[$enum];
                } else {
                    $st_time=($global->exit_st_day[$enum]-1)*60*24+$global->exit_st_hour[$enum]*60+$global->exit_st_min[$enum];
                    $ed_time=($global->exit_ed_day[$enum]-1)*60*24+$global->exit_ed_hour[$enum]*60+$global->exit_ed_min[$enum];
                    $ct_time=$cd*60*24+$ch*60+$cm;
                    $t_str='From: '.$dayname[$global->exit_st_day[$enum]].', '.$global->exit_st_hour[$enum].':'.$global->exit_st_min[$enum].'<br>Until: '.$dayname[$global->exit_ed_day[$enum]].', '.$global->exit_ed_hour[$enum].':'.$global->exit_ed_min[$enum];
                }
                $tp_str=$global->exit_prc[$enum];
                if($st_time<$ed_time){
                    if($ct_time>=$st_time && $ct_time<=$ed_time) $state='<font color='.$intf->color['ACT_EVENT'].'>Active</font>';
                    else $state='<font color='.$intf->color['INACT_EV'].'>Inactive</font>';
                } else {
                    if($ct_time>=$st_time || $ct_time<=$ed_time) $state='<font color='.$intf->color['ACT_EVENT'].'>Active</font>';
                    else $state='<font color='.$intf->color['INACT_EV'].'>Inactive</font>';
                }
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='del_exit[]' value='".$enum."'></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><a href='".$eurl."' target=_blank>".$eurl."</a></font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center>".$t_str."</td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>".$tp_str."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>".$state."</font></td>
                    </tr>";
            }
        }

        echo "<tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' colspan=5></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' colspan=5 align=center>
            <table width=100% border=0>
            <tr>
            <td align=center><font size=1>New Exit Traffic URL</font><br>";
        $html->input(11,'normal','text','new_exit',45,165,'');
        echo "</td>
            <td align=center><font size=1>Starts at:<br><select name=st_day><option value=0 selected>Daily";
        foreach($dayname as $did=>$dnm) echo "<option value=".$did.">".$dnm;
        echo "</select><br><select name=st_hour>";
        for($i=0;$i<=23;$i++){
            if($i<10) $v='0'.$i; else $v=$i;
            echo "<option value=".$v.">".$v;
        }
        echo "</select> : <select name=st_min>";
        for($i=0;$i<=59;$i++){
            if($i<10) $v='0'.$i; else $v=$i;
            echo "<option value=".$v.">".$v;
        }
        echo "</select></td>
            <td align=center><font size=1>Stops at:<br><select name=ed_day><option value=0 selected>Daily";
        foreach($dayname as $did=>$dnm) echo "<option value=".$did.">".$dnm;
        echo "</select><br><select name=ed_hour>";
        for($i=0;$i<=23;$i++){
            if($i<10) $v='0'.$i; else $v=$i;
            echo "<option value=".$v.">".$v;
        }
        echo "</select> : <select name=ed_min>";
        for($i=0;$i<=59;$i++){
            if($i<10) $v='0'.$i; else $v=$i;
            echo "<option value=".$v.">".$v;
        }
        echo "</select></td>
            <td align=center><font size=1>Traffic: <select name=exit_prc>";
        for($i=1;$i<=100;$i++) echo "<option value=".$i.">".$i."%";
        echo "</select></td>
            </tr>
            <tr>
            <td align=center colspan=4>";
        $html->button('submit','Add URL','light');
        echo "</td>
            </tr>
            <tr>
            </tr>
            </table>
            </td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' colspan=5 align=center>";
        $html->button('submit','Delete URLs','light');
        echo "</td>
            </tr>
            </table>
            <br>";

        $html->main_table_footer();
        $html->sub_page_footer();

        exit;
    }

    function add_exit(){
        global $global;

        $eurl=str_replace('|','',$_POST['new_exit']);
        $st_day=$_POST['st_day'];
        $st_hour=$_POST['st_hour'];
        $st_min=$_POST['st_min'];
        $ed_day=$_POST['ed_day'];
        $ed_hour=$_POST['ed_hour'];
        $ed_min=$_POST['ed_min'];
        $e_force=$_POST['exit_prc'];
        if($st_day==0 || $ed_day==0){ $st_day=0; $ed_day=0; }
        if(strlen($eurl)<10 || $e_force<1 || ($st_day==$ed_day && $st_hour==$ed_hour && $st_min==$ed_min)) $this->exit_traffic();
        $global->read_exit_urls();
        if(is_array($global->exit_urls)) $fnum=count($global->exit_urls); else $fnum=0;
        $global->exit_urls[$fnum]=$eurl;
        $global->exit_st_day[$fnum]=$st_day;
        $global->exit_st_hour[$fnum]=$st_hour;
        $global->exit_st_min[$fnum]=$st_min;
        $global->exit_ed_day[$fnum]=$ed_day;
        $global->exit_ed_hour[$fnum]=$ed_hour;
        $global->exit_ed_min[$fnum]=$ed_min;
        $global->exit_prc[$fnum]=$e_force;
        $global->save_exit_urls();
        $this->exit_traffic(false);
    }

    function delete_exits(){
        global $global;

        $to_del=$_POST['del_exit'];
        if(!is_array($to_del)) $this->exit_traffic();
        $global->read_exit_urls();
        foreach($to_del as $did){
            unset($global->exit_urls[$did]);
            unset($global->exit_st_day[$did]);
            unset($global->exit_st_hour[$did]);
            unset($global->exit_st_min[$did]);
            unset($global->exit_ed_day[$did]);
            unset($global->exit_ed_hour[$did]);
            unset($global->exit_ed_min[$did]);
            unset($global->exit_prc[$did]);
        }
        $global->save_exit_urls();
        $this->exit_traffic(false);
    }

    function show_backups(){
        global $intf,$html,$settings;

        $html->sub_page_header('DB Management');
        $html->main_table_header('DB Management');

        if($dh=@opendir($settings->bakup_path)){
            while(($file=readdir($dh))!==false) if($file!='.' && $file!='..' && !is_dir($settings->bakup_path.'/'.$file) && stristr($file,'traders') && stristr($file,'.dat')){
                list($d1,$btime,$d2)=explode('.',$file);
                $back_list[]=$btime;
            }
            @closedir($dh);
        }

        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1>Backups list</font></td></tr>
            <tr align=center>
            <td bgcolor='".$intf->color['NORM_CELL']."'><select name='use_backups[]' multiple size=10>";
        if(is_array($back_list)){
            rsort($back_list);
            foreach($back_list as $btime){
                $bts=date('Y F d, H:i:s',$btime);
                echo "<option value=".$btime.">".$bts;
            }
        }
        echo "</select></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=middle>";
        $html->button('submit','Use Backups','light');
        echo "<br><br><br>";
        $html->button('submit','Delete Backups','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' colspan=2 align=center>";
        $html->button('submit','Create Backup','light');
        echo "</td>
            </tr>
            </table>
            <br>
        ";

        $html->main_table_footer();
        $html->sub_page_footer();
        exit;
    }

    function delete_backups(){
        global $settings;

        $to_del=$_POST['use_backups'];
        if(!is_array($to_del)) $this->show_backups();

        foreach($to_del as $dtime) @unlink($settings->bakup_path.'/traders.'.$dtime.'.dat');
        $this->show_backups();
    }

    function use_backups(){
        global $intf,$html,$settings,$trader,$new_trader;

        $to_use=$_POST['use_backups'];
        if(!is_array($to_use)) $this->show_backups();

        $this->read_traders();
        $this->read_new_traders();

        foreach($to_use as $btime){
            $bf=@file($settings->bakup_path.'/traders.'.$btime.'.dat');
            if(!$bf) continue;
            foreach($bf as $bfl){
                list($td,$turl,)=explode('|',$bfl);
                if(!$td) continue;
                if(!$backed_trader["$td"] && !$trader->url["$td"] && !$new_trader->url["$td"]){
                    $backed_trader["$td"]=$btime;
                    $backed_url["$td"]=$turl;
                }
            }
        }

        $html->sub_page_header('Selected Backups');
        $html->main_table_header('Selected Backups');

        echo "<br>
            <table width=800 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=2><font size=1>Select Trades to Restore</font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=400><font size=1>In Backups</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=400><font size=1>In Database</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>";
        if(is_array($backed_trader)){
            ksort($backed_trader);
            foreach($backed_trader as $bdom=>$btime){
                $burl=$backed_url["$bdom"];
                echo "<input type=checkbox name=to_restore[".$bdom."] value='".$btime."'> &nbsp;".$bdom.': '.$burl."<br>";
            }
        } else echo '<center><b>No Trades to Restore</b></center>';
        echo "</font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' valign=top><font size=1>";
        if(is_array($trader->url)){
            echo "<b>Main Trades</b><br><br>";
            foreach($trader->url as $tdom=>$trul) echo $tdom.': '.$trul.'<br>';
        }
        if(is_array($new_trader->url)){
            echo "<br><b>New Trades</b><br><br>";
            foreach($new_trader->url as $tdom=>$trul) echo $tdom.': '.$trul.'<br>';
        }
        echo "</font></td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=2>";
        $html->button('submit','Restore Trades','light');
        echo "</td>
            </tr>
            </table>
            ";

        $html->main_table_footer();
        $html->sub_page_footer();
        exit;
    }

    function restore_traders(){
        global $settings,$trader;

        $to_restore=$_POST['to_restore'];
        if(!is_array($to_restore)) $this->show_backups();
        $this->read_traders();
        $restored=false;
        foreach($to_restore as $rdom=>$rtime){
            $rf=@file($settings->bakup_path.'/traders.'.$rtime.'.dat');
            if(!$rf) continue;
            foreach($rf as $rfl){
                list($dom,$url,$set_ratio,$trade_type,$proxy_an,$proxy_ds,$proxy_tr,$badref_in,$m_pages,$c_rule,$c_skim,$f_rule,$nc_pr,$acc_badref,$badref_cl_pr,$proxy_cl_pr,$njs_r,$s_name,$e_mail,$nick,$icq,$toplist,$time_added)=explode('|',trim($rfl));
                if($rdom==$dom && !$trader->url["$rdom"]){
                    $trader->url["$rdom"]=$url;
                    $trader->set_ratio["$rdom"]=$set_ratio;
                    $trader->trade_type["$rdom"]=$trade_type;
                    $trader->proxy_an["$rdom"]=$proxy_an;
                    $trader->proxy_ds["$rdom"]=$proxy_ds;
                    $trader->proxy_tr["$rdom"]=$proxy_tr;
                    $trader->badref_in["$rdom"]=$badref_in;
                    $trader->main_pages["$rdom"]=explode('.',$m_pages);
                    $trader->click_rule["$rdom"]=$c_rule;
                    $trader->content_skim["$rdom"]=$c_skim;
                    $trader->mintrade["$rdom"]=$f_rule;
                    $trader->nocookie_pr["$rdom"]=$nc_pr;
                    $trader->badref_click["$rdom"]=$acc_badref;
                    $trader->badref_cl_pr["$rdom"]=$badref_cl_pr;
                    $trader->proxy_cl_pr["$rdom"]=$proxy_cl_pr;
                    $trader->nojs_rule["$rdom"]=$njs_r;
                    $trader->site_name["$rdom"]=$s_name;
                    $trader->e_mail["$rdom"]=$e_mail;
                    $trader->nick["$rdom"]=$nick;
                    $trader->icq["$rdom"]=$icq;
                    $trader->toplist_allowed["$rdom"]=$toplist;
                    $trader->time_added["$rdom"]=time();
                    $restored=true;
                }
            }
        }
        if($restored){
            $this->backup_traders();
            $this->write_traders();
        }
        $this->show_backups();
    }

    function day_stats(){
        global $intf,$html,$trader,$hour_stats;

        $html->sub_page_header('24h Stats');
        $html->main_table_header('24h Stats');
        $this->read_traders();
        $this->read_hourly_stats();
        $cur_hour=date('G');

        echo "<br>
            <table width=870 border=0 cellpadding=1 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=26><font size=1><b>24h Stas</b>: Hits In, Hits Out, Clicks, Proxy Traffic %, Productivity</font></td></tr>
            <tr align=center>
            <td bgcolor='".$intf->color['STB_HEADER']."' class=nt width=110><font size=1>Trader</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' class=nt width=5%><font size=1><nobr>Day Total</nobr></font></td>";
        for($i=0;$i<24;$i++) echo "<td bgcolor='".$intf->color['STB_HEADER']."' class=nt width=5%><font size=1>".$i."h</font></td>";
        echo "</tr>";
        if(is_array($trader->url)){
            foreach($trader->url as $tdom=>$turl){
                if($hour_stats->day_in["$tdom"]>0){
                    $dhpr=round($hour_stats->day_proxy_in["$tdom"]*100/$hour_stats->day_in["$tdom"]);
                    $dprod=round($hour_stats->day_clicks["$tdom"]*100/$hour_stats->day_in["$tdom"]);
                } else {
                    $dhpr=0;
                    $dprod=0;
                }
                if($hour_stats->day_clicks["$tdom"]>0) $dcpr=round($hour_stats->day_proxy_clicks["$tdom"]*100/$hour_stats->day_clicks["$tdom"]); else $dcpr=0;
                if($hour_stats->day_out["$tdom"]>0) $dopr=round($hour_stats->day_proxy_out["$tdom"]*100/$hour_stats->day_out["$tdom"]); else $dopr=0;
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><a href='".$turl."' target=_blank><font color='".$intf->color['TRAFFIC_HIGH']."' size=1><b>".$tdom."</b></font></a></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><nobr>".$hour_stats->day_in["$tdom"].":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$hour_stats->day_out["$tdom"].":".$html->proxy_col($dopr)."</nobr><br><nobr>".$hour_stats->day_clicks["$tdom"].":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>
                ";
                for($i=0;$i<24;$i++){
                    if($hour_stats->hour_in["$tdom"][$i]>0){
                        $dhpr=round($hour_stats->hour_proxy_in["$tdom"][$i]*100/$hour_stats->hour_in["$tdom"][$i]);
                        $dprod=round($hour_stats->hour_clicks["$tdom"][$i]*100/$hour_stats->hour_in["$tdom"][$i]);
                    }  else {
                        $dhpr=0;
                        $dprod=0;
                    }
                    if($hour_stats->hour_clicks["$tdom"][$i]>0) $dcpr=round($hour_stats->hour_proxy_clicks["$tdom"][$i]*100/$hour_stats->hour_clicks["$tdom"][$i]); else $dcpr=0;
                    if($hour_stats->hour_out["$tdom"][$i]>0) $dopr=round($hour_stats->hour_proxy_out["$tdom"][$i]*100/$hour_stats->hour_out["$tdom"][$i]); else $dopr=0;
                    if($i==$cur_hour) echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."' align=center>";
                    else echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
                    echo "<nobr>".$hour_stats->hour_in["$tdom"][$i].":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$hour_stats->hour_out["$tdom"][$i].":".$html->proxy_col($dopr)."</nobr><br><nobr>".$hour_stats->hour_clicks["$tdom"][$i].":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
                }
                echo "</tr>";
            }
        }
        // Exout
        if($hour_stats->day_out["exout"]>0) $dopr=round($hour_stats->day_proxy_out["exout"]*100/$hour_stats->day_out["exout"]); else $dopr=0;
        echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font color='".$intf->color['TRAFFIC_HIGH']."' size=1><b><br>ExOut</br>&nbsp;</b></font></a></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center>".$hour_stats->day_out["exout"].":".$html->proxy_col($dopr)."</nobr></td>";
        for($i=0;$i<24;$i++){
            if($hour_stats->hour_out["exout"][$i]>0) $dopr=round($hour_stats->hour_proxy_out["exout"][$i]*100/$hour_stats->hour_out["exout"][$i]); else $dopr=0;
            if($i==$cur_hour) echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."' align=center>";
            else echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$hour_stats->hour_out["exout"][$i].":".$html->proxy_col($dopr)."</td>";
        }
        if($hour_stats->day_out["exout"]>0) $dopr=round($hour_stats->day_proxy_out["content"]*100/$hour_stats->day_out["content"]); else $dopr=0;
        echo "</tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><a href='".$turl."' target=_blank><font color='".$intf->color['TRAFFIC_HIGH']."' size=1><br><b>Content</b><br>&nbsp;</font></a></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' align=center>".$hour_stats->day_out["content"].":".$html->proxy_col($dopr)."</nobr></td>";
        for($i=0;$i<24;$i++){
            if($hour_stats->hour_out["content"][$i]>0) $dopr=round($hour_stats->hour_proxy_out["content"][$i]*100/$hour_stats->hour_out["content"][$i]); else $dopr=0;
            if($i==$cur_hour) echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."' align=center>";
            else echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$hour_stats->hour_out["content"][$i].":".$html->proxy_col($dopr)."</td>";
        }
        // Noref
        if($hour_stats->day_in["noref"]>0){
            $dhpr=round($hour_stats->day_proxy_in["noref"]*100/$hour_stats->day_in["noref"]);
            $dprod=round($hour_stats->day_clicks["noref"]*100/$hour_stats->day_in["noref"]);
        }  else {
            $dhpr=0;
            $dprod=0;
        }
        if($hour_stats->day_clicks["noref"]>0) $dcpr=round($hour_stats->day_proxy_clicks["noref"]*100/$hour_stats->day_clicks["noref"]); else $dcpr=0;
        echo "</tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font color='".$intf->color['TRAFFIC_HIGH']."' size=1><br><b>NoRef</b><br>&nbsp;</font></a></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' align=center><nobr>".$hour_stats->day_in["noref"].":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$hour_stats->day_clicks["noref"].":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
        for($i=0;$i<24;$i++){
            if($hour_stats->hour_in["noref"][$i]>0){
                $dhpr=round($hour_stats->hour_proxy_in["noref"][$i]*100/$hour_stats->hour_in["noref"][$i]);
                $dprod=round($hour_stats->hour_clicks["noref"][$i]*100/$hour_stats->hour_in["noref"][$i]);
            } else {
                $dhpr=0;
                $dprod=0;
            }
            if($hour_stats->hour_clicks["noref"][$i]>0) $dcpr=round($hour_stats->hour_proxy_clicks["noref"][$i]*100/$hour_stats->hour_clicks["noref"][$i]); else $dcpr=0;
            if($i==$cur_hour) echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."' align=center>";
            else echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$hour_stats->hour_in["noref"][$i].":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$hour_stats->hour_clicks["noref"][$i].":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
        }
        // Notrade
        if($hour_stats->day_in["notrade"]>0){
            $dhpr=round($hour_stats->day_proxy_in["notrade"]*100/$hour_stats->day_in["notrade"]);
            $dprod=round($hour_stats->day_clicks["notrade"]*100/$hour_stats->day_in["notrade"]);
        }  else {
            $dhpr=0;
            $dprod=0;
        }
        if($hour_stats->day_clicks["notrade"]>0) $dcpr=round($hour_stats->day_proxy_clicks["notrade"]*100/$hour_stats->day_clicks["notrade"]); else $dcpr=0;
        echo "</tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font color='".$intf->color['TRAFFIC_HIGH']."' size=1><b>NoTrade</b></font></td>
            <td bgcolor='".$intf->color['NORM_CELL']."' align=center><nobr>".$hour_stats->day_in["notrade"].":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$hour_stats->day_clicks["notrade"].":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
        for($i=0;$i<24;$i++){
            if($hour_stats->hour_in["notrade"][$i]>0){
                $dhpr=round($hour_stats->hour_proxy_in["notrade"][$i]*100/$hour_stats->hour_in["notrade"][$i]);
                $dprod=round($hour_stats->hour_clicks["notrade"][$i]*100/$hour_stats->hour_in["notrade"][$i]);
            } else {
                $dhpr=0;
                $dprod=0;
            }
            if($hour_stats->hour_clicks["notrade"][$i]>0) $dcpr=round($hour_stats->hour_proxy_clicks["notrade"][$i]*100/$hour_stats->hour_clicks["notrade"][$i]); else $dcpr=0;
            if($i==$cur_hour) echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."' align=center>";
            else echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$hour_stats->hour_in["notrade"][$i].":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$hour_stats->hour_clicks["notrade"][$i].":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
        }
        // Nocookie
        if($hour_stats->day_clicks["nocookie"]>0) $dcpr=round($hour_stats->day_proxy_clicks["nocookie"]*100/$hour_stats->day_clicks["nocookie"]); else $dcpr=0;
        echo "</tr>
            <tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font color='".$intf->color['TRAFFIC_HIGH']."' size=1><br><b>NoCookie</b></font><br>&nbsp;</td>
            <td bgcolor='".$intf->color['NORM_CELL']."' align=center><nobr>".$hour_stats->day_clicks["nocookie"].":".$html->proxy_col($dcpr)."</nobr></td>";
        for($i=0;$i<24;$i++){
            if($hour_stats->hour_clicks["nocookie"][$i]>0) $dcpr=round($hour_stats->hour_proxy_clicks["nocookie"][$i]*100/$hour_stats->hour_clicks["nocookie"][$i]); else $dcpr=0;
            if($i==$cur_hour) echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."' align=center>";
            else echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr><nobr>".$hour_stats->hour_clicks["nocookie"][$i].":".$html->proxy_col($dcpr)."</nobr></td>";
        }
        // Trades
        $tr_day_in=$hour_stats->tot_in-$hour_stats->day_in["noref"]-$hour_stats->day_in["notrade"]-$hour_stats->day_in["nocookie"]-$hour_stats->day_in["filtered"]-$hour_stats->day_in["exout"]-$hour_stats->day_in["content"];
        $tr_day_proxy_in=$hour_stats->tot_proxy_in-$hour_stats->day_proxy_in["noref"]-$hour_stats->day_proxy_in["notrade"]-$hour_stats->day_proxy_in["nocookie"]-$hour_stats->day_proxy_in["filtered"]-$hour_stats->day_proxy_in["exout"]-$hour_stats->day_proxy_in["content"];
        $tr_day_out=$hour_stats->tot_out-$hour_stats->day_out["noref"]-$hour_stats->day_out["notrade"]-$hour_stats->day_out["nocookie"]-$hour_stats->day_out["filtered"]-$hour_stats->day_out["exout"]-$hour_stats->day_out["content"];
        $tr_day_proxy_out=$hour_stats->tot_proxy_out-$hour_stats->day_proxy_out["noref"]-$hour_stats->day_proxy_out["notrade"]-$hour_stats->day_proxy_out["nocookie"]-$hour_stats->day_proxy_out["filtered"]-$hour_stats->day_proxy_out["exout"]-$hour_stats->day_proxy_out["content"];
        $tr_day_click=$hour_stats->tot_clicks-$hour_stats->day_clicks["noref"]-$hour_stats->day_clicks["nocookie"]-$hour_stats->day_clicks["exout"]-$hour_stats->day_clicks["content"]-$hour_stats->day_clicks["notrade"]-$hour_stats->day_clicks["filtered"];
        $tr_day_proxy_click=$hour_stats->tot_proxy_clicks-$hour_stats->day_proxy_clicks["noref"]-$hour_stats->day_proxy_clicks["nocookie"]-$hour_stats->day_proxy_clicks["exout"]-$hour_stats->day_proxy_clicks["content"]-$hour_stats->day_proxy_clicks["notrade"]-$hour_stats->day_proxy_clicks["filtered"];
        if($tr_day_in>0){
            $dhpr=round($tr_day_proxy_in*100/$tr_day_in);
            $dprod=round($tr_day_click*100/$tr_day_in);
        } else {
            $dhpr=0;
            $dprod=0;
        }
        if($tr_day_click>0) $dcpr=round($tr_day_proxy_click*100/$tr_day_click); else $dcpr=0;
        if($tr_day_out>0) $dopr=round($tr_day_proxy_out*100/$tr_day_out); else $dopr=0;
        echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><b>Trades</b></font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><nobr>".$tr_day_in.":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$tr_day_out.":".$html->proxy_col($dopr)."</nobr><br><nobr>".$tr_day_click.":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>
        ";
        for($i=0;$i<24;$i++){
            $tr_h_in=$hour_stats->tot_hour_in[$i]-$hour_stats->hour_in["noref"][$i]-$hour_stats->hour_in["notrade"][$i]-$hour_stats->hour_in["nocookie"][$i]-$hour_stats->hour_in["content"][$i]-$hour_stats->hour_in["exout"][$i]-$hour_stats->hour_in["filtered"][$i];
            $tr_h_proxy_in=$hour_stats->tot_hour_proxy_in[$i]-$hour_stats->hour_proxy_in["notrade"][$i]-$hour_stats->hour_proxy_in["noref"][$i]-$hour_stats->hour_proxy_in["nocookie"][$i]-$hour_stats->hour_proxy_in["exout"][$i]-$hour_stats->hour_proxy_in["filtered"][$i]-$hour_stats->hour_proxy_in["content"][$i];
            $tr_h_out=$hour_stats->tot_hour_out[$i]-$hour_stats->hour_out["noref"][$i]-$hour_stats->hour_out["notrade"][$i]-$hour_stats->hour_out["nocookie"][$i]-$hour_stats->hour_out["exout"][$i]-$hour_stats->hour_out["content"][$i]-$hour_stats->hour_out["filtered"][$i];
            $tr_h_proxy_out=$hour_stats->tot_hour_proxy_out[$i]-$hour_stats->hour_proxy_out["noref"][$i]-$hour_stats->hour_proxy_out["notrade"][$i]-$hour_stats->hour_proxy_out["exout"][$i]-$hour_stats->hour_proxy_out["filtered"][$i]-$hour_stats->hour_proxy_out["nocookie"][$i]-$hour_stats->hour_proxy_out["content"][$i];
            $tr_h_click=$hour_stats->tot_hour_clicks[$i]-$hour_stats->hour_clicks["noref"][$i]-$hour_stats->hour_clicks["notrade"][$i]-$hour_stats->hour_clicks["nocookie"][$i]-$hour_stats->hour_clicks["filtered"][$i]-$hour_stats->hour_clicks["exout"][$i]-$hour_stats->hour_clicks["content"][$i];
            $tr_h_proxy_click=$hour_stats->tot_hour_proxy_clicks[$i]-$hour_stats->hour_proxy_clicks["noref"][$i]-$hour_stats->hour_proxy_clicks["notrade"][$i]-$hour_stats->hour_proxy_clicks["nocookie"][$i]-$hour_stats->hour_proxy_clicks["exout"][$i]-$hour_stats->hour_proxy_clicks["filtered"][$i]-$hour_stats->hour_proxy_clicks["content"][$i];
            if($tr_h_in>0){
                $dhpr=round($tr_h_proxy_in*100/$tr_h_in);
                $dprod=round($tr_h_click*100/$tr_h_in);
            }  else {
                $dhpr=0;
                $dprod=0;
            }
            if($tr_h_click>0) $dcpr=round($tr_h_proxy_click*100/$tr_h_click); else $dcpr=0;
            if($tr_h_out>0) $dopr=round($tr_h_proxy_out*100/$tr_h_out); else $dopr=0;
            if($i==$cur_hour) echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."' align=center>";
            else echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$tr_h_in.":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$tr_h_out.":".$html->proxy_col($dopr)."</nobr><br><nobr>".$tr_h_click.":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
        }
        // Totals
        if($hour_stats->tot_in>0){
            $dhpr=round($hour_stats->tot_proxy_in*100/$hour_stats->tot_in);
            $dprod=round($hour_stats->tot_clicks*100/$hour_stats->tot_in);
        } else {
            $dhpr=0;
            $dprod=0;
        }
        if($hour_stats->tot_clicks>0) $dcpr=round($hour_stats->tot_proxy_clicks*100/$hour_stats->tot_clicks); else $dcpr=0;
        if($hour_stats->tot_out>0) $dopr=round($hour_stats->tot_proxy_out*100/$hour_stats->tot_out); else $dopr=0;
        echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><b>Total</b></font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><nobr>".$hour_stats->tot_in.":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$hour_stats->tot_out.":".$html->proxy_col($dopr)."</nobr><br><nobr>".$hour_stats->tot_clicks.":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>
        ";
        for($i=0;$i<24;$i++){
            if($hour_stats->tot_hour_in[$i]>0){
                $dhpr=round($hour_stats->tot_hour_proxy_in[$i]*100/$hour_stats->tot_hour_in[$i]);
                $dprod=round($hour_stats->tot_hour_clicks[$i]*100/$hour_stats->tot_hour_in[$i]);
            }  else {
                $dhpr=0;
                $dprod=0;
            }
            if($hour_stats->tot_hour_clicks[$i]>0) $dcpr=round($hour_stats->tot_hour_proxy_clicks[$i]*100/$hour_stats->tot_hour_clicks[$i]); else $dcpr=0;
            if($hour_stats->tot_hour_out[$i]>0) $dopr=round($hour_stats->tot_hour_proxy_out[$i]*100/$hour_stats->tot_hour_out[$i]); else $dopr=0;
            if($i==$cur_hour) echo "<td bgcolor='".$intf->color['HL_HOUR_CELL']."' align=center>";
            else echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$hour_stats->tot_hour_in[$i].":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$hour_stats->tot_hour_out[$i].":".$html->proxy_col($dopr)."</nobr><br><nobr>".$hour_stats->tot_hour_clicks[$i].":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
        }
        echo "</table><br>";

        $html->main_table_footer();
        $html->sub_page_footer();
        exit;
    }

    function ip_blacklist($cmd=''){
        global $intf,$html,$settings,$global,$log;

        $html->sub_page_header('Blacklisted IPs');
        $html->main_table_header('Blacklisted IPs');

        $ips=@file($settings->data_path.'/banned_ips.dat');
        if($ips){
            foreach($ips as $ipl){
                list($ipa,$ipt)=explode('|',trim($ipl));
                if(!$ipa) continue;
                $iplist["$ipa"]=$ipt;
            }
        }
        if($cmd=='add'){
            $to_add=$_POST['new_ip'];
            $to_time=$_POST['blacklist_time'];
            if($to_time && $to_add && !$iplist["$to_add"]){
                $iplist["$to_add"]=time()+$to_time*3600;
                $sf=true;
            }
        }
        if($cmd=='remove'){
            $to_remove=$_POST['ipchecked'];
            if(is_array($to_remove)){
                $sf=true;
                foreach($to_remove as $rip) unset($iplist["$rip"]);
            }
        }
        if($sf){
            $fp=@fopen($settings->data_path.'/banned_ips.dat.new','w');
            if($fp){
                @flock($fp,LOCK_EX);
                if(is_array($iplist)) foreach($iplist as $ipa=>$ipt) @fwrite($fp,$ipa.'|'.$ipt."\n");
                @flock($fp,LOCK_UN);
                @fclose($fp);
                @rename($settings->data_path.'/banned_ips.dat.new',$settings->data_path.'/banned_ips.dat');
                @chmod($settings->data_path.'/banned_ips.dat',0777);
            } else $log->error('Can not access Banned IPs file to write');
        }
        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=3><font size=1>Blacklisted IPs</font></td></tr>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center width=20 class=nt>-</td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=290 class=nt><font size=1>IP</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center width=290 class=nt><font size=1>Time Until Removement</font></td>
            </tr>
        ";
        if($iplist){
            arsort($iplist);
            $ctime=time();
            foreach($iplist as $ipa=>$ipt){
                $ttl=ceil(($ipt-$ctime)/60);
                $tth=floor($ttl/60);
                $ttm=$ttl-$tth*60;
                $s='';
                if($tth>0) $s.=$tth.' hours, ';
                $s.=$ttm.' minutes';
                echo "
                    <tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><input type=checkbox name='ipchecked[]' value='".$ipa."'></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$ipa."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>".$s."</font></td>
                    </tr>
                    ";
            }
        }

        echo "
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3><font size=1>New IP: ";
        $html->input(11,'normal','text','new_ip',16,165,'');
        echo ' &nbsp; Blacklist for: </font><select name=blacklist_time>';
        for($i=1;$i<=240;$i++) echo "<option value=".$i.">".$i." Hours";
        echo "</select> &nbsp;";
        $html->button('submit','Add New IP','light');
        echo "</td>
            </tr>
            <tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' align=center colspan=3>";
        $html->button('submit','Remove IPs','light');
        echo "</td>
            </tr>
            </table><br>";

        $html->main_table_footer();
        $html->sub_page_footer();
        exit;
    }

    function trades_checker(){
        global $settings,$html,$intf,$trader,$new_trader;

        $this->read_traders();
        $this->read_new_traders();

        $rep=@file($settings->data_path.'/checker.dat');
        if($rep){
            foreach($rep as $rpl){
                list($tdom,$ifr,$jsc,$obj,$app)=explode('|',trim($rpl));
                if(!$trader->url["$tdom"] && !$new_trader->url["$tdom"]) continue;
                $report["$tdom"][0]=$ifr;
                $report["$tdom"][1]=$jsc;
                $report["$tdom"][2]=$obj;
                $report["$tdom"][3]=$app;
            }
        }

        $html->sub_page_header('Trades Checker');
        $html->main_table_header('Trades Checker Reports');

        echo "<br>
            <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=5><font size=1>Trades Checker Report</font></td></tr>
            <tr>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=200><font size=1>Trade</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=100><font size=1>Iframes</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=100><font size=1>JavaScripts</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=100><font size=1>Objects</font></td>
            <td bgcolor='".$intf->color['STB_HEADER']."' align=center class=nt width=100><font size=1>Applets</font></td>
            </tr>
            ";

        if(is_array($trader->url)){
            foreach($trader->url as $tdom=>$turl){
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><a href='".$turl."' target=_blank>".$turl."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>";
                if($report["$tdom"][0]) echo "<a href='?cmd=showx&domain=".$tdom."'><font color='".$intf->color['X_ALERT']."'>Found</font>";
                else echo "<font color='".$intf->color['X_GOOD']."'>Not Found</font>";
                echo "</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>";
                if($report["$tdom"][1]) echo "<a href='?cmd=showx&domain=".$tdom."'><font color='".$intf->color['X_ALERT']."'>Found</font>";
                else echo "<font color='".$intf->color['X_GOOD']."'>Not Found</font>";
                echo "</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>";
                if($report["$tdom"][2]) echo "<a href='?cmd=showx&domain=".$tdom."'><font color='".$intf->color['X_ALERT']."'>Found</font>";
                else echo "<font color='".$intf->color['X_GOOD']."'>Not Found</font>";
                echo "</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>";
                if($report["$tdom"][3]) echo "<a href='?cmd=showx&domain=".$tdom."'><font color='".$intf->color['X_ALERT']."'>Found</font>";
                else echo "<font color='".$intf->color['X_GOOD']."'>Not Found</font>";
                echo "</font></td>
                    </tr>";
            }
        }

        if(is_array($new_trader->url)){
            echo "<tr><td bgcolor='".$intf->color['NORM_CELL']."' colspan=5></td></tr>";
            foreach($new_trader->url as $tdom=>$turl){
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><a href='".$turl."' target=_blank>".$turl."</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>";
                if($report["$tdom"][0]) echo "<a href='?cmd=showx&domain=".$tdom."'><font color='".$intf->color['X_ALERT']."'>Found</font>";
                else echo "<font color='".$intf->color['X_GOOD']."'>Not Found</font>";
                echo "</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>";
                if($report["$tdom"][1]) echo "<a href='?cmd=showx&domain=".$tdom."'><font color='".$intf->color['X_ALERT']."'>Found</font>";
                else echo "<font color='".$intf->color['X_GOOD']."'>Not Found</font>";
                echo "</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>";
                if($report["$tdom"][2]) echo "<a href='?cmd=showx&domain=".$tdom."'><font color='".$intf->color['X_ALERT']."'>Found</font>";
                else echo "<font color='".$intf->color['X_GOOD']."'>Not Found</font>";
                echo "</font></td>
                    <td bgcolor='".$intf->color['NORM_CELL']."' align=center><font size=1>";
                if($report["$tdom"][3]) echo "<a href='?cmd=showx&domain=".$tdom."'><font color='".$intf->color['X_ALERT']."'>Found</font>";
                else echo "<font color='".$intf->color['X_GOOD']."'>Not Found</font>";
                echo "</font></td>
                    </tr>";
            }
        }
        echo "</table><br>";

        $html->main_table_footer();
        $html->sub_page_footer();
        exit;
    }

    function showx(){
        global $settings,$html,$intf;

        $to_show=$_GET['domain'];
        if(!$to_show) $this->trades_checker();

        $html->sub_page_header("Trade &quot;".$to_show."&quot; Checker Report");
        $html->main_table_header("Trade &quot;".$to_show."&quot; Checker Report");

        $xfound=array();
        $xcode=array();
        $xa=@fopen($settings->log_path.'/checker/'.$to_show.'.ifr','rb');
        if($xa){
            $xfr=@fread($xa,filesize($settings->log_path.'/checker/'.$to_show.'.ifr'));
            @fclose($xa);
            $xfre=explode(chr(1),$xfr);
            foreach($xfre as $xfrs){
                list($xtm,$x64e)=explode(chr(2),$xfrs);
                if($xtm){
                    $x64d=base64_decode($x64e);
                    $xmd5=md5($x64d);
                    $xfound["$xmd5"]=$xtm;
                    $xcode["$xmd5"]=$x64d;
                }
            }
        }
        if(count($xfound)>0){
            echo "<br>
                  <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
                  <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center><font size=1>Invisible Iframes</font></td></tr>
            ";
            foreach($xfound as $xmd5=>$xtm){
                $xcod=$xcode["$xmd5"];
                $lstr=$xcod;
                $tcod='';
                while(strlen($lstr)>70){
                    $tcod.=substr($lstr,0,70)."\n";
                    $lstr=substr($lstr,70);
                }
                $x_str=$tcod.$lstr."\n";
                echo "<tr>
                      <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>
                      <b>Found last time at ".date('H:i, d M',$xtm)."</b><br><br>".nl2br(htmlentities($x_str))."<br><br><b>End Cut<b></font></td></tr>";
            }
            echo "</table></br>";
        }

        $xfound=array();
        $xcode=array();
        $xa=@fopen($settings->log_path.'/checker/'.$to_show.'.jsc','rb');
        if($xa){
            $xfr=@fread($xa,filesize($settings->log_path.'/checker/'.$to_show.'.jsc'));
            @fclose($xa);
            $xfre=explode(chr(1),$xfr);
            foreach($xfre as $xfrs){
                list($xtm,$x64e)=explode(chr(2),$xfrs);
                if($xtm){
                    $x64d=base64_decode($x64e);
                    $xmd5=md5($x64d);
                    $xfound["$xmd5"]=$xtm;
                    $xcode["$xmd5"]=$x64d;
                }
            }
        }
        if(count($xfound)>0){
            echo "<br>
                  <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
                  <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center><font size=1>Suspicious JavaScripts</font></td></tr>
            ";
            foreach($xfound as $xmd5=>$xtm){
                $xcod=$xcode["$xmd5"];
                $lstr=$xcod;
                $tcod='';
                while(strlen($lstr)>70){
                    $tcod.=substr($lstr,0,70)."\n";
                    $lstr=substr($lstr,70);
                }
                $x_str=$tcod.$lstr."\n";
                echo "<tr>
                      <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>
                      <b>Found last time at ".date('H:i, d M',$xtm)."</b><br><br>".nl2br(htmlentities($x_str))."<br><br><b>End Cut<b></font></td></tr>";
            }
            echo "</table></br>";
        }

        $xfound=array();
        $xcode=array();
        $xa=@fopen($settings->log_path.'/checker/'.$to_show.'.obj','rb');
        if($xa){
            $xfr=@fread($xa,filesize($settings->log_path.'/checker/'.$to_show.'.obj'));
            @fclose($xa);
            $xfre=explode(chr(1),$xfr);
            foreach($xfre as $xfrs){
                list($xtm,$x64e)=explode(chr(2),$xfrs);
                if($xtm){
                    $x64d=base64_decode($x64e);
                    $xmd5=md5($x64d);
                    $xfound["$xmd5"]=$xtm;
                    $xcode["$xmd5"]=$x64d;
                }
            }
        }
        if(count($xfound)>0){
            echo "<br>
                  <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
                  <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center><font size=1>Invisible Objects</font></td></tr>
            ";
            foreach($xfound as $xmd5=>$xtm){
                $xcod=$xcode["$xmd5"];
                $lstr=$xcod;
                $tcod='';
                while(strlen($lstr)>70){
                    $tcod.=substr($lstr,0,70)."\n";
                    $lstr=substr($lstr,70);
                }
                $x_str=$tcod.$lstr."\n";
                echo "<tr>
                      <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>
                      <b>Found last time at ".date('H:i, d M',$xtm)."</b><br><br>".nl2br(htmlentities($x_str))."<br><br><b>End Cut<b></font></td></tr>";
            }
            echo "</table></br>";
        }

        $xfound=array();
        $xcode=array();
        $xa=@fopen($settings->log_path.'/checker/'.$to_show.'.app','rb');
        if($xa){
            $xfr=@fread($xa,filesize($settings->log_path.'/checker/'.$to_show.'.app'));
            @fclose($xa);
            $xfre=explode(chr(1),$xfr);
            foreach($xfre as $xfrs){
                list($xtm,$x64e)=explode(chr(2),$xfrs);
                if($xtm){
                    $x64d=base64_decode($x64e);
                    $xmd5=md5($x64d);
                    $xfound["$xmd5"]=$xtm;
                    $xcode["$xmd5"]=$x64d;
                }
            }
        }
        if(count($xfound)>0){
            echo "<br>
                  <table width=600 border=0 cellpadding=5 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
                  <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center><font size=1>Invisible Applets</font></td></tr>
            ";
            foreach($xfound as $xmd5=>$xtm){
                $xcod=$xcode["$xmd5"];
                $lstr=$xcod;
                $tcod='';
                while(strlen($lstr)>70){
                    $tcod.=substr($lstr,0,70)."\n";
                    $lstr=substr($lstr,70);
                }
                $x_str=$tcod.$lstr."\n";
                echo "<tr>
                      <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1>
                      <b>Found last time at ".date('H:i, d M',$xtm)."</b><br><br>".nl2br(htmlentities($x_str))."<br><br><b>End Cut<b></font></td></tr>";
            }
            echo "</table></br>";
        }

        $html->main_table_footer();
        $html->sub_page_footer();
        exit;
    }

    function stats_history(){
        global $intf,$html,$trader,$settings;

        $html->sub_page_header('Stats History');
        $html->main_table_header('Stats History');
        $this->read_traders();

        $period=$_POST['period'] or $period=10;

        $span=$period+1;
        $ctime=time();

        $stats_history=@file($settings->data_path.'/stats_history.dat');
        if(is_array($stats_history)){
            foreach($stats_history as $sthl){
                if(strlen($sthl)<30) continue;
                $ldat=explode('|',trim($sthl));
                $dom=$ldat[0];
                for($i=0;$i<100;$i++){
                    $hist_hits["$dom"][$i]+=$ldat[$i*6+1];
                    $tot_hist_hits[$i]+=$ldat[$i*6+1];
                    $hist_pr_hits["$dom"][$i]+=$ldat[$i*6+2];
                    $tot_hist_pr_hits[$i]+=$ldat[$i*6+2];
                    $hist_outs["$dom"][$i]+=$ldat[$i*6+3];
                    $tot_hist_outs[$i]+=$ldat[$i*6+3];
                    $hist_pr_outs["$dom"][$i]+=$ldat[$i*6+4];
                    $tot_hist_pr_outs[$i]+=$ldat[$i*6+4];
                    $hist_clicks["$dom"][$i]+=$ldat[$i*6+5];
                    $tot_hist_clicks[$i]+=$ldat[$i*6+5];
                    $hist_pr_clicks["$dom"][$i]+=$ldat[$i*6+6];
                    $tot_hist_pr_clicks[$i]+=$ldat[$i*6+6];
                }
            }
        }

        echo "<br>
            <table width=100% border=0 cellpadding=1 cellspacing=1 bgcolor='".$intf->color['STB_BACKGROUND']."'>
            <tr><td bgcolor='".$intf->color['STB_HEADER']."' align=center colspan=".$span."><font size=1><b>Stats for last ".$period." days</b>: Hits In, Hits Out, Clicks, Proxy Traffic %, Productivity</font></td></tr>
            <tr align=center>
            <td bgcolor='".$intf->color['STB_HEADER']."' class=nt width=15%><font size=1>Trader</font></td>";
        for($i=0;$i<$period;$i++){
            $pd=$ctime-($period-$i)*86400;
            $ps=date('d M',$pd);
            echo "<td bgcolor='".$intf->color['STB_HEADER']."' class=nt width=8%><font size=1><nobr>".$ps."</nobr></font></td>";
        }
        echo "</tr>";
        if(is_array($trader->url)){
            foreach($trader->url as $tdom=>$turl){
                echo "<tr>
                    <td bgcolor='".$intf->color['NORM_CELL']."'><a href='".$turl."' target=_blank><font size=1 color='".$intf->color['TRAFFIC_HIGH']."'><b>".$tdom."</b></font></a></td>";
                for($i=0;$i<$period;$i++){
                    if($hist_hits["$tdom"][$period-$i-1]>0){
                        $dhpr=round($hist_pr_hits["$tdom"][$period-$i-1]*100/$hist_hits["$tdom"][$period-$i-1]);
                        $dprod=round($hist_clicks["$tdom"][$period-$i-1]*100/$hist_hits["$tdom"][$period-$i-1]);
                    } else {
                        $dhpr=0;
                        $dprod=0;
                    }
                    if($hist_clicks["$tdom"][$period-$i-1]>0) $dcpr=round($hist_pr_clicks["$tdom"][$period-$i-1]*100/$hist_clicks["$tdom"][$period-$i-1]); else $dcpr=0;
                    if($hist_outs["$tdom"][$period-$i-1]>0) $dopr=round($hist_pr_outs["$tdom"][$period-$i-1]*100/$hist_outs["$tdom"][$period-$i-1]); else $dopr=0;
                    echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center><nobr>".$hist_hits["$tdom"][$period-$i-1].":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$hist_outs["$tdom"][$period-$i-1].":".$html->proxy_col($dopr)."</nobr><br><nobr>".$hist_clicks["$tdom"][$period-$i-1].":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
                }
                echo "</tr>";
            }
        }
        // Exout
        echo "<tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><br><font size=1 color='".$intf->color['TRAFFIC_HIGH']."'><b>ExOut</b><br>&nbsp;</td>";
        for($i=0;$i<$period;$i++){
            if($hist_outs["exout"][$period-$i-1]>0) $dopr=round($hist_pr_outs["exout"][$period-$i-1]*100/$hist_outs["exout"][$period-$i-1]); else $dopr=0;
            echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$hist_outs["exout"][$period-$i-1].":".$html->proxy_col($dopr)."</td>";
        }
        echo "</tr>";
        // Noref
        echo "<tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><br><font size=1 color='".$intf->color['TRAFFIC_HIGH']."'><b>NoRef</b><br>&nbsp;</td>";
        for($i=0;$i<$period;$i++){
            if($hist_hits["noref"][$period-$i-1]>0){
                $dhpr=round($hist_pr_hits["noref"][$period-$i-1]*100/$hist_hits["noref"][$period-$i-1]);
                $dprod=round($hist_clicks["noref"][$period-$i-1]*100/$hist_hits["noref"][$period-$i-1]);
            } else {
                $dhpr=0;
                $dprod=0;
            }
            if($hist_clicks["noref"][$period-$i-1]>0) $dcpr=round($hist_pr_clicks["noref"][$period-$i-1]*100/$hist_clicks["noref"][$period-$i-1]); else $dcpr=0;
            echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$hist_hits["noref"][$period-$i-1].":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$hist_clicks["noref"][$period-$i-1].":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
        }
        echo "</tr>";
        // Notrade
        echo "<tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><br><font size=1 color='".$intf->color['TRAFFIC_HIGH']."'><b>NoTrade</b><br>&nbsp;</td>";
        for($i=0;$i<$period;$i++){
            if($hist_hits["notrade"][$period-$i-1]>0){
                $dhpr=round($hist_pr_hits["notrade"][$period-$i-1]*100/$hist_hits["notrade"][$period-$i-1]);
                $dprod=round($hist_clicks["notrade"][$period-$i-1]*100/$hist_hits["notrade"][$period-$i-1]);
            } else {
                $dhpr=0;
                $dprod=0;
            }
            if($hist_clicks["notrade"][$period-$i-1]>0) $dcpr=round($hist_pr_clicks["notrade"][$period-$i-1]*100/$hist_clicks["notrade"][$period-$i-1]); else $dcpr=0;
            echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$hist_hits["notrade"][$period-$i-1].":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$hist_clicks["notrade"][$period-$i-1].":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
        }
        echo "</tr>";
        // NoCookie
        echo "<tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><br><font size=1 color='".$intf->color['TRAFFIC_HIGH']."'><b>NoCookie</b><br>&nbsp;</td>";
        for($i=0;$i<$period;$i++){
            if($hist_clicks["nocookie"][$period-$i-1]>0) $dcpr=round($hist_pr_clicks["nocookie"][$period-$i-1]*100/$hist_clicks["nocookie"][$period-$i-1]); else $dcpr=0;
            echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$hist_clicks["nocookie"][$period-$i-1].":".$html->proxy_col($dcpr)."</nobr></td>";
        }
        echo "</tr>";
        // Trades
        echo "<tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><b>Trades</b></font></td>";
        for($i=0;$i<$period;$i++){
            $tr_h_in=$tot_hist_hits[$period-$i-1]-$hist_hits["noref"][$period-$i-1]-$hist_hits["notrade"][$period-$i-1]-$hist_hits["exout"][$period-$i-1]-$hist_hits["nocookie"][$period-$i-1]-$hist_hits["filtered"][$period-$i-1]-$hist_hits["content"][$period-$i-1];
            $tr_h_proxy_in=$tot_hist_pr_hits[$period-$i-1]-$hist_pr_hits["noref"][$period-$i-1]-$hist_pr_hits["notrade"][$period-$i-1]-$hist_pr_hits["exout"][$period-$i-1]-$hist_pr_hits["nocookie"][$period-$i-1]-$hist_pr_hits["filtered"][$period-$i-1]-$hist_pr_hits["content"][$period-$i-1];
            $tr_h_out=$tot_hist_outs[$period-$i-1]-$hist_outs["noref"][$period-$i-1]-$hist_outs["notrade"][$period-$i-1]-$hist_outs["exout"][$period-$i-1]-$hist_outs["nocookie"][$period-$i-1]-$hist_outs["filtered"][$period-$i-1]-$hist_outs["content"][$period-$i-1];
            $tr_h_proxy_out=$tot_hist_pr_outs[$period-$i-1]-$hist_pr_outs["noref"][$period-$i-1]-$hist_pr_outs["notrade"][$period-$i-1]-$hist_pr_outs["exout"][$period-$i-1]-$hist_pr_outs["nocookie"][$period-$i-1]-$hist_pr_outs["filtered"][$period-$i-1]-$hist_pr_outs["content"][$period-$i-1];
            $tr_h_click=$tot_hist_clicks[$period-$i-1]-$hist_clicks["noref"][$period-$i-1]-$hist_clicks["notrade"][$period-$i-1]-$hist_clicks["exout"][$period-$i-1]-$hist_clicks["nocookie"][$period-$i-1]-$hist_clicks["filtered"][$period-$i-1]-$hist_clicks["content"][$period-$i-1];
            $tr_h_proxy_click=$tot_hist_pr_clicks[$period-$i-1]-$hist_pr_clicks["noref"][$period-$i-1]-$hist_pr_clicks["notrade"][$period-$i-1]-$hist_pr_clicks["exout"][$period-$i-1]-$hist_pr_clicks["nocookie"][$period-$i-1]-$hist_pr_clicks["filtered"][$period-$i-1]-$hist_pr_clicks["content"][$period-$i-1];
            if($tr_h_in>0){
                $dhpr=round($tr_h_proxy_in*100/$tr_h_in);
                $dprod=round($tr_h_click*100/$tr_h_in);
            }  else {
                $dhpr=0;
                $dprod=0;
            }
            if($tr_h_click>0) $dcpr=round($tr_h_proxy_click*100/$tr_h_click); else $dcpr=0;
            if($tr_h_out>0) $dopr=round($tr_h_proxy_out*100/$tr_h_out); else $dopr=0;
            echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$tr_h_in.":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$tr_h_out.":".$html->proxy_col($dopr)."</nobr><br><nobr>".$tr_h_click.":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
        }
        // Totals
        echo "<tr>
            <td bgcolor='".$intf->color['NORM_CELL']."'><font size=1><b>Total</b></font></td>";
        for($i=0;$i<$period;$i++){
            if($tot_hist_hits[$period-$i-1]>0){
                $dhpr=round($tot_hist_pr_hits[$period-$i-1]*100/$tot_hist_hits[$period-$i-1]);
                $dprod=round($tot_hist_clicks[$period-$i-1]*100/$tot_hist_hits[$period-$i-1]);
            }  else {
                $dhpr=0;
                $dprod=0;
            }
            if($tot_hist_clicks[$period-$i-1]>0) $dcpr=round($tot_hist_pr_clicks[$period-$i-1]*100/$tot_hist_clicks[$period-$i-1]); else $dcpr=0;
            if($tot_hist_outs[$period-$i-1]>0) $dopr=round($tot_hist_pr_outs[$period-$i-1]*100/$tot_hist_outs[$period-$i-1]); else $dopr=0;
            echo "<td bgcolor='".$intf->color['NORM_CELL']."' align=center>";
            echo "<nobr>".$tot_hist_hits[$period-$i-1].":".$html->proxy_col($dhpr)."</nobr><br><nobr>".$tot_hist_outs[$period-$i-1].":".$html->proxy_col($dopr)."</nobr><br><nobr>".$tot_hist_clicks[$period-$i-1].":".$html->proxy_col($dcpr)."</nobr><br>".$dprod."%</td>";
        }
        echo "<tr>
            <td bgcolor='".$intf->color['MAIN_BGCOLOR']."' colspan=".$span." align=center><font size=1>Select Period: </font><select name=period>";
        for($i=2;$i<=20;$i++){
            $p=$i*5;
            if($p==$period) $s=' selected'; else $s='';
            echo "<option value=".$p.$s.">".$p." days";
        }
        echo "</select> &nbsp; ";
        $html->button('submit','Show History','light');
        echo "</td>
            </tr>
            </table><br>";
        $html->main_table_footer();
        $html->sub_page_footer();
        exit;
    }
}

?>